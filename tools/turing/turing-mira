#!/usr/bin/env python3
"""
Interactive Mira Chat â€” Talk to Mira directly from the terminal

This uses the real Mira LLM module with full system prompt, FAQ knowledge,
and personality. Perfect for testing prompts and debugging responses.

Usage:
    ./tools/turing/turing-mira                    # Interactive mode (default user 2)
    ./tools/turing/turing-mira --user 5           # As specific user
    ./tools/turing/turing-mira "Hi, how are you?" # Single message
    ./tools/turing/turing-mira --clear            # Clear conversation history

Controls:
    /clear  - Reset conversation
    /system - Show current system prompt  
    /quit   - Exit (or Ctrl+C)
"""

import sys
import asyncio
import argparse
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).resolve().parents[2]))

from core.mira_llm import chat as mira_chat, build_system_prompt
from core.database import get_connection
from core.logging_config import get_logger

logger = get_logger(__name__)

# ANSI colors for pretty output
class C:
    MIRA = '\033[95m'      # Magenta for Mira
    USER = '\033[96m'      # Cyan for user
    SYSTEM = '\033[90m'    # Gray for system info
    BOLD = '\033[1m'
    RESET = '\033[0m'


def print_mira(text: str):
    """Print Mira's response with styling."""
    print(f"{C.MIRA}{C.BOLD}ðŸ§˜ Mira:{C.RESET} {C.MIRA}{text}{C.RESET}")


def print_user(text: str):
    """Print user input with styling."""
    print(f"{C.USER}{C.BOLD}You:{C.RESET} {C.USER}{text}{C.RESET}")


def print_system(text: str):
    """Print system message."""
    print(f"{C.SYSTEM}{text}{C.RESET}")


class MiraChat:
    """Interactive Mira chat session."""
    
    def __init__(self, user_id: int = 2):
        self.user_id = user_id
        self.history = []  # List of {"role": "user"|"assistant", "content": str}
    
    def clear(self):
        """Reset conversation history."""
        self.history = []
        print_system("âœ¨ Conversation cleared")
    
    async def send(self, message: str) -> str:
        """Send message to Mira and get response."""
        with get_connection() as conn:
            # Get response from Mira LLM
            response = await mira_chat(
                message=message,
                user_id=self.user_id,
                conn=conn,
                history=self.history  # Pass conversation history
            )
            
            # Update history
            self.history.append({"role": "user", "content": message})
            self.history.append({"role": "assistant", "content": response.reply})
            
            return response.reply
    
    def show_system_prompt(self) -> str:
        """Get the current system prompt."""
        with get_connection() as conn:
            # Get yogi context for system prompt
            cursor = conn.cursor()
            cursor.execute("""
                SELECT 
                    p.id,
                    p.display_name,
                    COALESCE(p.skills_summary, '') as skills
                FROM profiles p
                WHERE p.user_id = %s
                LIMIT 1
            """, (self.user_id,))
            row = cursor.fetchone()
            
            yogi_context = ""
            if row:
                yogi_context = f"Name: {row['display_name']}\nSkills: {row['skills'][:200]}..." if row['skills'] else ""
            
            return build_system_prompt(language='de', yogi_context=yogi_context)


async def interactive_mode(user_id: int):
    """Run interactive chat session."""
    chat = MiraChat(user_id=user_id)
    
    print()
    print(f"{C.BOLD}â•­{'â”€' * 58}â•®{C.RESET}")
    print(f"{C.BOLD}â”‚{C.MIRA}  ðŸ§˜ Mira Chat â€” Interactive Mode                        {C.RESET}{C.BOLD}â”‚{C.RESET}")
    print(f"{C.BOLD}â”‚{C.SYSTEM}  User ID: {user_id:<47}{C.RESET}{C.BOLD}â”‚{C.RESET}")
    print(f"{C.BOLD}â”‚{C.SYSTEM}  Commands: /clear /system /quit                        {C.RESET}{C.BOLD}â”‚{C.RESET}")
    print(f"{C.BOLD}â•°{'â”€' * 58}â•¯{C.RESET}")
    print()
    
    # Mira's greeting
    print_mira("Hallo! Ich bin Mira, deine Begleiterin bei talent.yoga. Wie kann ich dir heute helfen?")
    print()
    
    while True:
        try:
            # Get user input
            user_input = input(f"{C.USER}{C.BOLD}You:{C.RESET} ").strip()
            
            if not user_input:
                continue
            
            # Handle commands
            if user_input.lower() in ['/quit', '/exit', '/q']:
                print_system("ðŸ‘‹ TschÃ¼ss!")
                break
            
            if user_input.lower() == '/clear':
                chat.clear()
                continue
            
            if user_input.lower() == '/system':
                print_system("â”" * 60)
                print_system("SYSTEM PROMPT:")
                print_system("â”" * 60)
                print(chat.show_system_prompt())
                print_system("â”" * 60)
                continue
            
            # Send to Mira
            response = await chat.send(user_input)
            print()
            print_mira(response)
            print()
            
        except KeyboardInterrupt:
            print()
            print_system("ðŸ‘‹ TschÃ¼ss!")
            break
        except EOFError:
            break


async def single_message(user_id: int, message: str):
    """Send a single message and print response."""
    chat = MiraChat(user_id=user_id)
    
    print_user(message)
    response = await chat.send(message)
    print_mira(response)


def main():
    parser = argparse.ArgumentParser(description='Chat with Mira')
    parser.add_argument('message', nargs='?', help='Single message to send (or omit for interactive mode)')
    parser.add_argument('--user', type=int, default=2, help='User ID (default: 2 = test@talent.yoga)')
    parser.add_argument('--clear', action='store_true', help='Clear conversation and exit')
    
    args = parser.parse_args()
    
    if args.clear:
        print_system("âœ¨ Conversation state cleared")
        return
    
    if args.message:
        # Single message mode
        asyncio.run(single_message(args.user, args.message))
    else:
        # Interactive mode
        asyncio.run(interactive_mode(args.user))


if __name__ == '__main__':
    main()
