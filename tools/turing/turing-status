#!/usr/bin/env python3
"""
Turing Status â€” What happened recently?

Usage:
    turing-status           # Last 24 hours
    turing-status --days 7  # Last 7 days
    turing-status --data    # Just data inventory (skip ticket activity)
"""
import argparse
import sys
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).resolve().parent.parent.parent))

from core.database import get_connection


def main():
    parser = argparse.ArgumentParser(description='Turing system status overview')
    parser.add_argument('--days', type=int, default=1, help='Look back N days')
    parser.add_argument('--data', action='store_true', help='Show only data inventory')
    args = parser.parse_args()
    
    with get_connection() as conn:
        cur = conn.cursor()
        
        print(f"\nðŸ“Š TURING STATUS â€” Last {args.days} day(s)\n")
        print("=" * 60)
        
        if not args.data:
            # Actor activity from tickets
            cur.execute("""
                SELECT 
                    COALESCE(a.canonical_name, a.actor_name) as actor,
                    a.actor_type,
                    COUNT(t.ticket_id) as tickets,
                    COUNT(*) FILTER (WHERE t.status = 'completed') as ok,
                    COUNT(*) FILTER (WHERE t.status = 'failed') as fail,
                    MAX(t.completed_at) as last_run
                FROM tickets t
                JOIN actors a ON a.actor_id = t.actor_id
                WHERE t.created_at > NOW() - INTERVAL '%s days'
                GROUP BY a.actor_id, a.canonical_name, a.actor_name, a.actor_type
                ORDER BY MAX(t.completed_at) DESC NULLS LAST
                LIMIT 15;
            """, (args.days,))
            
            rows = cur.fetchall()
            if rows:
                print(f"\nðŸŽ­ ACTOR ACTIVITY\n")
                print(f"{'Actor':<35} {'Type':<10} {'OK':>5} {'Fail':>5} {'Last Run':<20}")
                print("-" * 80)
                for r in rows:
                    last = r['last_run'].strftime('%Y-%m-%d %H:%M') if r['last_run'] else 'never'
                    actor_name = (r['actor'] or 'unknown')[:35]
                    actor_type = r['actor_type'] or 'script'
                    print(f"{actor_name:<35} {actor_type:<10} {r['ok']:>5} {r['fail']:>5} {last:<20}")
            else:
                print("\nâš ï¸  No ticket activity in this period")
        
        # Data inventory
        print("\n" + "=" * 60)
        print("\nðŸ“¦ DATA INVENTORY\n")
        
        # Total postings
        cur.execute("SELECT COUNT(*) as cnt FROM postings")
        total_postings = cur.fetchone()['cnt']
        print(f"  Postings (total):    {total_postings:,}")
        
        # By source
        cur.execute("""
            SELECT source, COUNT(*) as cnt 
            FROM postings 
            GROUP BY source 
            ORDER BY cnt DESC 
            LIMIT 5
        """)
        for row in cur.fetchall():
            print(f"    â””â”€ {row['source'] or 'unknown':<18} {row['cnt']:>8,}")
        
        # With job description
        cur.execute("SELECT COUNT(*) as cnt FROM postings WHERE job_description IS NOT NULL AND LENGTH(job_description) > 100")
        with_desc = cur.fetchone()['cnt']
        pct = (with_desc / total_postings * 100) if total_postings > 0 else 0
        print(f"\n  With description:    {with_desc:,} ({pct:.1f}%)")
        
        # Embeddings
        cur.execute("SELECT COUNT(*) as cnt FROM embeddings")
        embeds = cur.fetchone()['cnt']
        print(f"  Embeddings:          {embeds:,}")
        
        # Pending embeddings (postings with description but no embedding)
        # Using our content-addressed text_hash pattern
        cur.execute("""
            SELECT COUNT(*) as cnt FROM postings p 
            WHERE p.job_description IS NOT NULL 
            AND LENGTH(p.job_description) > 100
            AND NOT EXISTS (
                SELECT 1 FROM embeddings e 
                WHERE e.text_hash = md5(lower(trim(p.job_description)))
            )
        """)
        pending = cur.fetchone()['cnt']
        print(f"  Pending embed:       {pending:,}")
        
        # Recent activity
        print("\n" + "=" * 60)
        print("\nðŸ“ˆ RECENT CHANGES\n")
        
        # New postings in period (using first_seen_at)
        cur.execute("""
            SELECT COUNT(*) as cnt FROM postings 
            WHERE first_seen_at > NOW() - INTERVAL '%s days'
        """, (args.days,))
        new_postings = cur.fetchone()['cnt']
        print(f"  New postings ({args.days}d):  {new_postings:,}")
        
        # New embeddings in period  
        cur.execute("""
            SELECT COUNT(*) as cnt FROM embeddings 
            WHERE created_at > NOW() - INTERVAL '%s days'
        """, (args.days,))
        new_embeds = cur.fetchone()['cnt']
        print(f"  New embeddings ({args.days}d): {new_embeds:,}")
        
        # AA-specific stats if we have AA data
        cur.execute("""
            SELECT COUNT(*) as cnt FROM postings 
            WHERE source = 'arbeitsagentur' 
            AND first_seen_at > NOW() - INTERVAL '%s days'
        """, (args.days,))
        new_aa = cur.fetchone()['cnt']
        if new_aa > 0:
            print(f"  New AA postings:     {new_aa:,}")
        
        # Profiles
        cur.execute("SELECT COUNT(*) as cnt FROM profiles")
        profiles = cur.fetchone()['cnt']
        print(f"\n  Profiles:            {profiles:,}")
        
        # Matches
        cur.execute("SELECT COUNT(*) as cnt FROM profile_posting_matches")
        matches = cur.fetchone()['cnt']
        print(f"  Matches:             {matches:,}")
        
        print()


if __name__ == '__main__':
    main()
