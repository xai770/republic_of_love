#!/bin/bash
# turing-daemon - Control background execution
#
# Usage:
#   turing daemon start [--task-type ID] [--limit N]  Start daemon with nohup
#   turing daemon stop                                 Stop running daemon
#   turing daemon status                               Show daemon status
#   turing daemon log                                  Tail daemon log
#
# The daemon runs in background with nohup so you can run QA during execution.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
LOCK_FILE="$PROJECT_ROOT/.pull_daemon.lock"
LOG_FILE="$PROJECT_ROOT/logs/daemon_$(date +%Y%m%d_%H%M%S).log"
PID_FILE="$PROJECT_ROOT/.pull_daemon.pid"

case "${1:-status}" in
    start)
        shift
        
        # Check if already running
        if [ -f "$PID_FILE" ]; then
            OLD_PID=$(cat "$PID_FILE")
            if ps -p "$OLD_PID" > /dev/null 2>&1; then
                echo "âŒ Daemon already running (PID $OLD_PID)"
                echo "   Use 'turing daemon stop' first, or 'turing daemon status'"
                exit 1
            else
                rm -f "$PID_FILE" "$LOCK_FILE"
            fi
        fi
        
        # Clear any stale locks
        rm -f "$LOCK_FILE"
        
        # Clear any DB advisory locks from crashed sessions
        "$SCRIPT_DIR/q.sh" "SELECT pg_terminate_backend(pid) FROM pg_locks WHERE locktype = 'advisory' AND pid != pg_backend_pid()" > /dev/null 2>&1
        
        echo "ðŸš€ Starting daemon in background..."
        echo "   Log: $LOG_FILE"
        echo ""
        
        # Start with nohup
        cd "$PROJECT_ROOT"
        nohup python3 scripts/pull_daemon.py "$@" > "$LOG_FILE" 2>&1 &
        DAEMON_PID=$!
        echo "$DAEMON_PID" > "$PID_FILE"
        
        # Wait a moment and check if it started
        sleep 2
        if ps -p "$DAEMON_PID" > /dev/null 2>&1; then
            echo "âœ… Daemon started (PID $DAEMON_PID)"
            echo ""
            echo "Monitor with:"
            echo "  turing daemon log     # Live log output"
            echo "  turing daemon status  # Check status"
            echo "  turing status         # Progress overview"
            echo ""
            echo "Run QA during execution:"
            echo "  turing errors [TaskType]"
            echo "  turing qa [TaskType]"
        else
            echo "âŒ Daemon failed to start. Check log:"
            tail -20 "$LOG_FILE"
            rm -f "$PID_FILE"
            exit 1
        fi
        ;;
        
    stop)
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "Stopping daemon (PID $PID)..."
                kill "$PID"
                sleep 2
                if ps -p "$PID" > /dev/null 2>&1; then
                    echo "Force killing..."
                    kill -9 "$PID"
                fi
                echo "âœ… Daemon stopped"
            else
                echo "Daemon not running (stale PID file)"
            fi
            rm -f "$PID_FILE" "$LOCK_FILE"
        else
            echo "No daemon PID file found"
            # Try to find and kill any running daemon
            PIDS=$(pgrep -f "pull_daemon.py" 2>/dev/null)
            if [ -n "$PIDS" ]; then
                echo "Found daemon processes: $PIDS"
                echo "Killing..."
                kill $PIDS 2>/dev/null
                sleep 1
                kill -9 $PIDS 2>/dev/null
                echo "âœ… Killed"
            fi
        fi
        rm -f "$LOCK_FILE"
        ;;
        
    status)
        echo "Daemon Status"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        if [ -f "$PID_FILE" ]; then
            PID=$(cat "$PID_FILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "âœ… Running (PID $PID)"
                
                # Get runtime
                ELAPSED=$(ps -o etimes= -p "$PID" 2>/dev/null | tr -d ' ')
                if [ -n "$ELAPSED" ]; then
                    MINS=$((ELAPSED / 60))
                    SECS=$((ELAPSED % 60))
                    echo "   Runtime: ${MINS}m ${SECS}s"
                fi
                
                # Get command line
                CMDLINE=$(ps -o args= -p "$PID" 2>/dev/null)
                echo "   Command: $CMDLINE"
            else
                echo "âŒ Not running (stale PID $PID)"
            fi
        else
            # Check for any daemon processes
            PIDS=$(pgrep -f "pull_daemon.py" 2>/dev/null)
            if [ -n "$PIDS" ]; then
                echo "âš ï¸  Found orphan daemon(s): $PIDS"
                echo "   Use 'turing daemon stop' to clean up"
            else
                echo "âŒ Not running"
            fi
        fi
        
        echo ""
        echo "Recent logs:"
        LATEST_LOG=$(ls -t "$PROJECT_ROOT/logs/daemon_"*.log 2>/dev/null | head -1)
        if [ -n "$LATEST_LOG" ]; then
            echo "   $LATEST_LOG"
            tail -5 "$LATEST_LOG" | sed 's/^/   /'
        else
            echo "   (no logs found)"
        fi
        ;;
        
    log)
        LATEST_LOG=$(ls -t "$PROJECT_ROOT/logs/daemon_"*.log 2>/dev/null | head -1)
        if [ -n "$LATEST_LOG" ]; then
            echo "Tailing $LATEST_LOG (Ctrl+C to exit)"
            echo ""
            tail -f "$LATEST_LOG"
        else
            echo "No daemon logs found"
            exit 1
        fi
        ;;
        
    *)
        echo "Usage: turing daemon <command>"
        echo ""
        echo "Commands:"
        echo "  start [args]   Start daemon in background (nohup)"
        echo "  stop           Stop running daemon"
        echo "  status         Show daemon status"
        echo "  log            Tail daemon log"
        echo ""
        echo "Examples:"
        echo "  turing daemon start --task_type 9383 --limit 2000"
        echo "  turing daemon status"
        echo "  turing daemon log"
        echo "  turing daemon stop"
        ;;
esac
