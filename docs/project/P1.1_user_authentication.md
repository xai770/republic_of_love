---
id: P1.1
title: "User Authentication"
phase: 1
status: complete
owner: arden
priority: critical
depends_on: []
effort: 4h
completed: 2026-01-23
---

# P1.1 User Authentication

## Goal

Users can log in with Google OAuth. Sessions persist. User identity links to profiles.

## Schema Changes

```sql
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    google_id TEXT UNIQUE,
    display_name TEXT,
    avatar_url TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    last_login_at TIMESTAMP,
    enabled BOOLEAN DEFAULT TRUE
);

-- Link profiles to users
ALTER TABLE profiles ADD COLUMN user_id INTEGER REFERENCES users(user_id);
CREATE INDEX idx_profiles_user ON profiles(user_id);
```

## Implementation

1. **Google OAuth setup**
   - Create Google Cloud project
   - Configure OAuth consent screen
   - Get client ID and secret
   - Store in `.env`

2. **FastAPI integration**
   - `pip install authlib httpx`
   - OAuth callback endpoint
   - Session management (JWT or cookie)

3. **User creation flow**
   - First login → create user record
   - Subsequent logins → update `last_login_at`
   - Link to existing profile if email matches

## Files to Create

| File | Purpose |
|------|---------|
| `api/auth.py` | OAuth routes |
| `api/deps.py` | `get_current_user` dependency |
| `core/users.py` | User CRUD |

## Acceptance Criteria

- [x] User can click "Login with Google"
- [x] Callback creates/updates user record
- [x] Session persists across requests
- [x] `/me` endpoint returns current user
- [x] Logout clears session

**Verified:** Gershon logged in 2026-01-23, user_id=1

## Sandy's Notes

Keep it simple. Don't build roles/permissions yet — just authenticated vs not.

Store the Google ID, not just email. Email can change; Google ID is permanent.
