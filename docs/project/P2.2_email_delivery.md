---
id: P2.2
title: "Email Delivery"
phase: 2
status: not_started
owner: arden
priority: high
depends_on: [P1.1, P2.1]
effort: 4h
---

# P2.2 Email Delivery

## Goal

Send weekly match digest emails to users. Include top matches with recommendations.

## Email Content

```
Subject: talent.yoga — 3 new matches this week

Hi Gershon,

Here are your top job matches from the past week:

✅ APPLY: ITAO Team Lead — Deutsche Bank (85% match)
   Strong alignment in: Team Leadership, Risk Management, Stakeholder Management
   [View Details] [View Posting]

⏭️ SKIP: Payroll Processor — Deutsche Bank (86% match)
   Concern: Profile lacks payroll domain experience
   [View Details]

⏭️ SKIP: Finance Business Advisor — Deutsche Bank (89% match)
   Concern: Insufficient financial analysis background
   [View Details]

---
Manage preferences: https://talent.yoga/settings
Unsubscribe: https://talent.yoga/unsubscribe?token=xxx
```

## Schema Changes

```sql
ALTER TABLE users ADD COLUMN email_preferences JSONB DEFAULT '{
    "weekly_digest": true,
    "instant_high_match": false,
    "marketing": false
}'::jsonb;

ALTER TABLE users ADD COLUMN unsubscribe_token TEXT DEFAULT gen_random_uuid()::text;

CREATE TABLE email_log (
    email_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    email_type TEXT,  -- 'weekly_digest', 'instant_match'
    sent_at TIMESTAMP DEFAULT NOW(),
    subject TEXT,
    match_ids INTEGER[],
    status TEXT DEFAULT 'sent'  -- 'sent', 'bounced', 'opened'
);
```

## Implementation

### SMTP Setup

```python
# config/email.py
SMTP_HOST = os.getenv('SMTP_HOST', 'smtp.gmail.com')
SMTP_PORT = int(os.getenv('SMTP_PORT', 587))
SMTP_USER = os.getenv('SMTP_USER')
SMTP_PASS = os.getenv('SMTP_PASS')
FROM_EMAIL = 'matches@talent.yoga'
```

### Weekly Digest Script

```python
# scripts/weekly_digest.py
"""
Weekly digest email. Runs Sundays at 09:00.
"""

def main():
    users = get_users_with_digest_enabled()
    
    for user in users:
        matches = get_new_matches(user.id, since=one_week_ago())
        if not matches:
            continue
        
        html = render_digest_template(user, matches)
        send_email(user.email, subject, html)
        log_email(user.id, 'weekly_digest', [m.id for m in matches])
```

### Cron

```bash
# /etc/cron.d/talent-yoga-email
0 9 * * 0 xai cd /home/xai/Documents/ty_wave && python3 scripts/weekly_digest.py >> logs/email.log 2>&1
```

## Templates

Store in `templates/email/`:
- `weekly_digest.html` — Jinja2 template
- `base.html` — Common header/footer

## Acceptance Criteria

- [ ] SMTP credentials in `.env`
- [ ] Weekly digest sends on Sunday 09:00
- [ ] Users with no new matches → no email
- [ ] Unsubscribe link works
- [ ] Email preferences respected
- [ ] `email_log` tracks sent emails

## Sandy's Notes

Start with Gmail SMTP for development. Switch to SendGrid/Mailgun for production (better deliverability, tracking).

The unsubscribe link must work without login (token-based). GDPR requires this.

Don't send empty digests. If user has 0 new matches, skip them.
