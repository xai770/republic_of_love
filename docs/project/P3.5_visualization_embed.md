---
id: P3.5
title: "Visualization Embed"
phase: 3
status: not_started
owner: arden
priority: medium
depends_on: [P3.4]
effort: 4h
---

# P3.5 Visualization Embed

## Goal

Embed the UMAP skill visualization in the web report viewer.

## Current State

`tools/clara_visualizer.py` generates matplotlib PNG files. Works for CLI, not web.

## Web Implementation Options

### Option A: Pre-rendered PNG

```
Match computed → Generate PNG → Store in /static/viz/
Report loads → <img src="/static/viz/match_123.png">
```

**Pros:** Simple, works everywhere
**Cons:** Not interactive, storage grows

### Option B: Plotly.js (Recommended)

```python
# API returns visualization data
@app.get("/matches/{id}/visualization")
def get_visualization(id: int):
    return {
        "profile_skills": [
            {"name": "Python", "x": 1.2, "y": -3.4, "cluster": "Technical"},
            ...
        ],
        "job_requirements": [
            {"name": "Team Leadership", "x": 2.1, "y": -4.2, "matched_to": "Team Leadership"},
            ...
        ],
        "match_lines": [
            {"from": "Python", "to": "Python Programming", "score": 0.89},
            ...
        ],
        "clusters": [
            {"name": "Technical", "center": [1.5, -3.0]},
            ...
        ]
    }
```

```html
<!-- Frontend renders with Plotly -->
<div id="viz-container"></div>
<script>
    fetch('/matches/123/visualization')
        .then(r => r.json())
        .then(data => {
            Plotly.newPlot('viz-container', buildTraces(data), layout);
        });
</script>
```

**Pros:** Interactive (zoom, hover), lightweight
**Cons:** Requires Plotly.js (~1MB)

### Option C: D3.js

Full control, smallest bundle, steepest learning curve.

## Recommendation

**Option B (Plotly.js)** — Best balance of interactivity and effort.

## Visualization Features

| Feature | Implementation |
|---------|----------------|
| Skill points | Scatter plot, color by type (profile/job) |
| Match lines | Dashed lines connecting matched pairs |
| Cluster labels | Text annotations at cluster centers |
| Verdict box | Annotation in corner |
| Hover | Show skill name + score |
| Zoom | Built-in Plotly controls |

## API Endpoint

```python
@app.get("/matches/{id}/visualization")
def get_visualization(match_id: int, db: Session = Depends(get_db)):
    match = get_match(db, match_id)
    
    # Get skills and compute UMAP (or use cached)
    profile_skills = get_profile_facets(db, match.profile_id)
    job_requirements = get_posting_facets(db, match.posting_id)
    
    # UMAP projection
    embeddings = get_embeddings(profile_skills + job_requirements)
    coords = umap.UMAP(n_components=2).fit_transform(embeddings)
    
    # Cluster labels
    clusters = compute_clusters(coords, labels)
    
    return VisualizationData(
        profile_skills=[...],
        job_requirements=[...],
        match_lines=[...],
        clusters=[...],
        verdict=match.recommendation
    )
```

## Caching

UMAP is expensive (~1s per computation). Cache results:

```sql
ALTER TABLE profile_posting_matches 
ADD COLUMN visualization_data JSONB;
```

Compute once, serve many times.

## Acceptance Criteria

- [x] Visualization renders in report viewer
- [x] Interactive (hover shows skill names)
- [x] Cluster labels visible
- [x] Match lines connect pairs
- [x] Verdict box shows score + recommendation
- [x] Mobile: Falls back to smaller or static version
- [x] Cached after first computation
