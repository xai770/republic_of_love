---
id: P2.1
title: "Scheduled Matching"
phase: 2
status: not_started
owner: arden
priority: high
depends_on: [P1.3, P1.4]
effort: 2h
---

# P2.1 Scheduled Matching

## Goal

Automatically compute matches for all profiles against new postings. Run daily.

## Current State

- Matching logic exists in `tools/profile_matcher.py`
- Works for single profile ↔ posting pair
- Manual invocation only

## Implementation

### Option A: Cron + Script

```bash
# /etc/cron.d/talent-yoga-matching
0 6 * * * xai cd /home/xai/Documents/ty_wave && python3 scripts/daily_match.py >> logs/matching.log 2>&1
```

```python
# scripts/daily_match.py
"""
Daily matching job. Runs at 06:00.
Computes matches for all enabled profiles against active postings.
"""

def main():
    profiles = get_enabled_profiles()
    postings = get_active_postings(since=yesterday())
    
    for profile in profiles:
        for posting in postings:
            if not match_exists(profile.id, posting.id):
                score = compute_match(profile, posting)
                save_match(profile.id, posting.id, score)
    
    log(f"Computed {count} new matches")
```

### Option B: Pull Daemon Actor

Create `actors/daily_matcher.py` with `pull_enabled=true`:

```sql
INSERT INTO actors (actor_name, actor_type, pull_enabled, work_query, ...)
VALUES (
    'daily_matcher',
    'script',
    true,
    $$
    SELECT p.profile_id, po.posting_id
    FROM profiles p
    CROSS JOIN postings po
    WHERE po.status = 'active'
      AND NOT EXISTS (
        SELECT 1 FROM profile_posting_matches m
        WHERE m.profile_id = p.profile_id AND m.posting_id = po.posting_id
      )
    LIMIT 100
    $$,
    ...
);
```

## Recommendation

**Option A (cron)** for now. Reasons:
- Simpler to debug
- Clear run time (06:00 daily)
- Pull daemon is for throughput; daily matching is batch

Later, if matching volume grows, switch to Option B.

## Monitoring

```sql
-- Check matching freshness
SELECT 
    DATE(computed_at) as day,
    COUNT(*) as matches_computed
FROM profile_posting_matches
GROUP BY 1
ORDER BY 1 DESC
LIMIT 7;
```

## Acceptance Criteria

- [x] Cron job runs daily at 06:00
- [x] New postings get matched to all profiles
- [x] New profiles get matched to all active postings
- [x] Duplicate matches skipped (idempotent)
- [x] Logs written to `logs/matching.log`

## Sandy's Notes

The cross-join explosion is O(profiles × postings). Currently small, but watch it.

Add a `profiles.matching_enabled` flag so users can pause matching if needed.
