---
id: P4.1
title: "User Match Ratings"
phase: 4
status: done
owner: arden
priority: medium
depends_on: [P3.3]
effort: 3h
completed: 2026-01-27
---

# P4.1 User Match Ratings

## Goal

Allow users to rate matches (üëç/üëé) to improve matching over time.

## Why This Matters

Current match scores are based on embedding similarity alone. User feedback tells us:
- Which jobs they actually find relevant
- False positives (high score, bad match)
- False negatives (low score, good match)

## Schema

```sql
CREATE TABLE match_ratings (
    id SERIAL PRIMARY KEY,
    match_id INTEGER NOT NULL REFERENCES profile_posting_matches(id),
    user_id INTEGER NOT NULL REFERENCES users(id),
    rating INTEGER NOT NULL CHECK (rating IN (-1, 1)),  -- -1 = bad, 1 = good
    reason TEXT,  -- Optional explanation
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(match_id, user_id)
);

-- Index for analysis
CREATE INDEX idx_match_ratings_rating ON match_ratings(rating);
```

## API Endpoint

```python
class RatingCreate(BaseModel):
    rating: Literal[-1, 1]
    reason: Optional[str] = None

@app.post("/matches/{id}/rating")
def rate_match(match_id: int, rating: RatingCreate, user: User = Depends(get_current_user)):
    # Verify user owns this match (their profile)
    match = db.get(ProfilePostingMatch, match_id)
    profile = db.get(Profile, match.profile_id)
    if profile.user_id != user.id:
        raise HTTPException(403, "Not your match")
    
    # Upsert rating
    db.execute(insert(MatchRating).values(
        match_id=match_id,
        user_id=user.id,
        rating=rating.rating,
        reason=rating.reason
    ).on_conflict_do_update(
        index_elements=['match_id', 'user_id'],
        set_={'rating': rating.rating, 'reason': rating.reason}
    ))
    
    return {"status": "rated"}
```

## UI Component

```html
<!-- In match dashboard -->
<div class="match-rating" data-match-id="123">
    <button hx-post="/matches/123/rating" 
            hx-vals='{"rating": 1}' 
            class="rating-btn thumbs-up">üëç</button>
    <button hx-post="/matches/123/rating" 
            hx-vals='{"rating": -1}' 
            class="rating-btn thumbs-down">üëé</button>
    <input type="text" name="reason" placeholder="Why? (optional)">
</div>
```

## Feedback Loop (P4.3)

Ratings feed into threshold tuning:

```sql
-- Calibration query
SELECT 
    CASE 
        WHEN weighted_score >= 0.70 THEN 'strong'
        WHEN weighted_score >= 0.60 THEN 'partial'
        ELSE 'low'
    END as match_tier,
    rating,
    COUNT(*) as count,
    AVG(weighted_score) as avg_score
FROM profile_posting_matches m
JOIN match_ratings r ON r.match_id = m.id
GROUP BY 1, 2
ORDER BY 1, 2;
```

If "strong" matches (‚â•0.70) have many üëé, threshold needs adjustment.

## Acceptance Criteria

- [ ] User can rate any match in their dashboard
- [ ] Ratings persist and survive page reload
- [ ] Can change rating (toggle)
- [ ] Optional reason field captured
- [ ] Only match owner can rate
- [ ] Ratings queryable for analysis
