# 2026-01-19 ‚Äî Arden's Log

## Session: 04:08

### Fixes
- Cleaned 357 postings with `===OUTPUT TEMPLATE===` artifact in extracted_summary (from Jan 15 batch)

### New Infrastructure
- Added `task_logs.code_hash` column to track which code version produced each output
- Added `raq stale <task_type>` command to find subjects with outdated outputs
- Updated `pull_daemon.py` to populate code_hash on task_log creation

### Insights
- The artifact came from Jan 15 run where prompt included template markers
- 442 existing task_logs have NULL code_hash (pre-tracking)
- Going forward: `raq stale` after any actor change shows what needs reprocessing

### Status
- requirements_extract: 442 completed (all pre-tracking, technically "stale")
- extracted_summary: 2,202 populated, artifact cleaned

---

## Session: ~08:00

### Thick Actor Naming Convention

Renamed all thick actors to `{table}__{attribute}_{CRUD}.py`:

| Old Name | New Name |
|----------|----------|
| `requirements_extract.py` | `postings__extracted_requirements_U.py` |
| `summary_extract.py` | `postings__extracted_summary_U.py` |
| `lily_cps_extract.py` | `posting_competencies__row_C.py` |
| `db_job_fetcher.py` | `postings__row_CU.py` |

**Convention:**
- `__` separates table from attribute (distinct from `_` within names)
- `_C` = Create, `_U` = Update, `_D` = Delete, `_CU` = Upsert
- `row` = whole-row operations

**Updated:** database `script_path`, directives (#12), cheat sheet, docstrings, test fixtures.

---

## Session: ~09:00

### Requirements Extractor Now Uses extracted_summary

Changed `postings__extracted_requirements_U.py` to use `extracted_summary` instead of `job_description`:

**Before:**
```
job_description ‚Üí translate ‚Üí LLM extract ‚Üí verify against job_description
```

**After:**
```
extracted_summary ‚Üí translate if non-English ‚Üí LLM extract ‚Üí verify against summary
```

**Benefits:**
- **81% smaller input** (5,415 ‚Üí 1,070 chars avg)
- **Faster LLM calls**, lower token cost
- **Bidirectional QA**: if quote not in summary, summary may have missed it

**Flow preserved for non-English:**
- If `source_language != 'en'`, translate the summary to English before extraction
- Requires `job_description_en` to exist (set by summary extractor)

**Updated:**
- Actor uses `extracted_summary` field
- Mermaid diagram in docstring reflects new flow
- Directives now include "The Posting Pipeline" section with full 4-stage flow

### Language Handling Clarified

Realized the flow needed clarity for non-English postings:

**Problem:** Where does translation happen?

**Solution:** Summary extractor handles it:
1. `postings__extracted_summary_U.py` detects language
2. If non-English, uses `job_description_en` as input (must exist)
3. Output (`extracted_summary`) is **always English**
4. Requirements extractor just uses summary directly - no translation needed

This simplifies the pipeline:
```
German posting ‚Üí job_description_en ‚Üí extracted_summary (EN) ‚Üí extracted_requirements
English posting ‚Üí job_description ‚Üí extracted_summary (EN) ‚Üí extracted_requirements
```

**Also fixed:** Removed `===OUTPUT TEMPLATE===` artifact from instruction #3328.

---

## Session: ~10:30

### Cascade Triggers for Dependency Management

**Problem:** When upstream attribute A changes, downstream attribute B becomes stale. How do we know?

**Solution:** Database triggers that auto-archive and invalidate downstream attributes.

**New table:** `attribute_history`
- Archives old values before cascade NULLs/DELETEs them
- Columns: `table_name`, `record_id`, `attribute_name`, `old_value` (JSONB), `reason`, `nulled_at`

**New triggers:**

| Trigger | When | Action |
|---------|------|--------|
| `trg_cascade_summary_to_requirements` | `extracted_summary` changes | Archive ‚Üí NULL `extracted_requirements` |
| `trg_cascade_requirements_to_competencies` | `extracted_requirements` changes | Archive ‚Üí DELETE `posting_competencies` rows |

**Full pipeline dependency chain:**
```
job_description ‚Üí extracted_summary ‚Üí extracted_requirements ‚Üí posting_competencies
                       ‚Üì                      ‚Üì
                  (trigger)              (trigger)
                       ‚Üì                      ‚Üì
              NULL requirements      DELETE competencies
```

**Tested:** Modified requirements on posting 11874 ‚Üí 16 competencies archived and deleted ‚Üí restored from archive successfully.

**Benefits:**
- Automatic staleness detection at DB level
- Full audit trail of cascaded changes
- Can restore from archive if needed

---

## Session: ~16:00

### OWL Canonical Structure Reset

**Problem:** OWL had inconsistent structure from previous experiments.

**Solution:** Reset to canonical Type Families design:
- 9 taxonomy_roots: competency, geography, preference, organization, person, event, contract, concept, work
- 11 skill_dimensions under competency: PO, LC, CA, CG, EC, TC, PM, DE, IP, SM, NR
- Documented in directives so we don't reinvent it

**Scare:** `TRUNCATE CASCADE` deleted owl_pending (8,985 test items!) ‚Äî restored from backup.

**Created:** `scripts/reset_owl_to_canonical.sql` for future resets.

### Clara Solo Working! üé¨

**Fixed Navigator:**
- Changed from 9 to 20 visible items (LLMs can handle it)
- Added `skill_dimension` to navigable folder types
- Fixed 2-digit command parsing ([11] not just [1])

**Fixed Clara:**
- Switched to `qwen2.5-coder:7b` model (much better at picking folders)
- Simplified prompt with context-aware dimension mapping
- Root level: "Skills go to competency [1]"
- Inside competency: "Programming ‚Üí technical, Writing ‚Üí language_and_communication, etc."

**Test Results:**
| Skill | Placed In | Correct? |
|-------|-----------|----------|
| Python Programming | technical | ‚úÖ |
| Public Speaking | language_and_communication | ‚úÖ |
| Data Analysis | cognitive_and_analytical | ‚úÖ |
| Team Leadership | interpersonal | ‚úÖ |

### Clara Dual Architecture Planned

Decided on Option 2: Thick actors with database coordination:
```
Clara A ‚Üí classification_proposals table ‚Üê Clara B
                    ‚Üì
              Arbitrator
                    ‚Üì
                 Commit
```

**Next:** Create classification_proposals table and stub actors.
---

## Session: ~21:00

### Clara Dual Pipeline Complete! üé¨üé¨

**Created 4 thick actors:**
| Actor | File | Model | Purpose |
|-------|------|-------|---------|
| Clara A | `owl__classify_U__clara_a.py` | mistral-nemo:12b | First classifier (verbose) |
| Clara B | `owl__classify_U__clara_b.py` | qwen2.5-coder:7b | Second classifier (fast) |
| Arbitrator | `owl__classify_U__arbitrator.py` | gemma2:latest | Compare & decide |
| Commit | `owl__classify_U__commit.py` | - | Write to owl_relationships |

**Created table:** `classification_proposals`
- Tracks: owl_id, classifier, model, proposed_parent_id, proposed_path, status
- Status flow: pending ‚Üí accepted/rejected ‚Üí committed

**Bug fixes during testing:**
1. Prompt was passing full Navigator menu including "[1-20]" header text ‚Üí LLM confused
2. At leaf nodes, prompt said "P to place or U to go up" ‚Üí model kept saying U
3. Fixed: "You MUST place the entity here. Answer with P:"

**End-to-end test on `machine_learning` (owl_id=26):**
| Step | Actor | Result |
|------|-------|--------|
| 1 | Clara A | `competency ‚Üí technical` |
| 2 | Clara B | `competency ‚Üí cognitive_and_analytical` |
| 3 | Arbitrator | **Chose Clara B** |
| 4 | Commit | ‚úÖ Written to owl_relationships |

Both agreed on root (competency) but disagreed on dimension. Arbitrator's choice is defensible ‚Äî ML involves analysis and problem-solving.

---

## Session: ~05:00 (Jan 20)

### Vera - The Validator ‚úÖ

Created `owl__validate_U__vera.py` - folder name validation (NO LLM):
- Uses `core.navigator.Vera` class for rules
- ASCII-only, snake_case, no banned words, length 2-50
- Duplicate detection against existing folders
- `--fix` flag auto-corrects names

**Test results:**
| Input | Result |
|-------|--------|
| `valid_folder` | ‚úÖ Approved |
| `advancedleadershipexp√©rience` | ‚ùå Non-ASCII |
| `MySkill` | ‚ùå Not snake_case |
| `years_experience` | ‚ùå Banned word |
| `technicals` | ‚ö†Ô∏è Valid but similar to `technical` |

### Victor - The Gatekeeper ‚úÖ

Created `owl__validate_U__victor.py` - substantive review (uses LLM):
- Necessity check: Is this folder needed?
- Duplicate check: Near-matches like `ml_tools` vs `machine_learning_tools`
- Placement check: Right parent folder?

**Test results:**
| Proposal | Result | Reason |
|----------|--------|--------|
| `kubernetes_ecosystem` | ‚úÖ | Distinct ecosystem |
| `tech` | ‚ùå | Too similar to `technical` |
| `machine_learning_tools` | ‚ùå | `machine_learning` exists |
| `quantum_computing` | ‚úÖ | Genuinely new |

### Adam - The Scribe ‚úÖ

Created `owl__create_C__adam.py` - writes to ledger:
- Creates `owl` record with description
- Creates `owl_relationships` to parent
- Creates `owl_names` with display name
- Pre-flight Vera validation
- Duplicate protection

**Test:** Created `quantum_computing` under `competency ‚Üí technical`:
```
owl_id: 27
type: folder
parent: technical (owl_id=15)
description: Quantum algorithms, hardware, and programming
```

### Competency Keepers Status

| Actor | Role | Type | Status |
|-------|------|------|--------|
| Clara Solo | Single classifier | LLM | ‚úÖ |
| Clara A | First dual classifier | LLM | ‚úÖ |
| Clara B | Second dual classifier | LLM | ‚úÖ |
| Arbitrator | Compare & decide | LLM | ‚úÖ |
| Commit | Write classification | Script | ‚úÖ |
| **Vera** | Format validation | Script | ‚úÖ |
| **Victor** | Substance review | LLM | ‚úÖ |
| **Adam** | Create entities | Script | ‚úÖ |

**Complete pipeline for new folders:**
```
Clara: [N] new_folder_name
          ‚Üì
       Vera (format) ‚Üí ‚ùå retry
          ‚Üì ‚úÖ
       Victor (substance) ‚Üí ‚ùå retry  
          ‚Üì ‚úÖ
       Adam (create) ‚Üí owl tables
```