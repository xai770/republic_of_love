# WF2010 Implementation Plan

*Arden's Planning Doc â€” January 1, 2026*

**Status: âœ… IMPLEMENTED**

---

## Implementation Summary

| Component | Count | IDs | Status |
|-----------|-------|-----|--------|
| Workflow | 1 | 2010 | âœ… Created |
| Conversations | 9 | 9351-9359 | âœ… Created |
| Instructions | 9 | 3544-3552 | âœ… Created |
| Instruction Steps | 11 | 255-265 | âœ… Created |
| Actors | 5 | 243-247 | âœ… Created |
| Scripts | 6 | wf2010_*.py | âœ… Created |

### Ontology Fix Applied
- Created "skill" entity (id: **39066**) as ontology root
- Wired all 10 root categories with `is_a skill` relationship
- No more orphans - 1844 trigger loop **FIXED**

### Actor Scripts Created
| Script | Actor Name | Purpose |
|--------|------------|---------|
| `wf2010_lookup.py` | Lucy | Check if skill exists |
| `wf2010_create.py` | Carl | Create entity record |
| `wf2010_navigate.py` | Nate | Build Navigator menu |
| `wf2010_compare.py` | â€” | Compare Clara A vs Clara B |
| `wf2010_victor.py` | Victor | Review new folder proposals |
| `wf2010_apply.py` | Adam | Write to database |

### Flow Verified âœ…
```
Lookup â†’ Create â†’ Navigate â†’ ClassifyA â†’ ClassifyB â†’ Compare
                                                        â†“
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ AGREE                               DISAGREE â”‚
                              â†“                                             â†“
                            Apply                                    Arbitrate
                                                                          â†“
                                                                        Apply

[N] new folder path:  Navigate â†’ Victor â†’ Apply (or back to Navigate if rejected)
```

---

## Context

We're replacing WF2003/2004/2005 (three workflows) with WF2010 (one workflow).

**Key documents:**
- [WF2010_skill_keepers_story.md](../WF2010_skill_keepers_story.md) â€” The story
- [WF2003-2005_redesign_proposal.md](../WF2003-2005_redesign_proposal.md) â€” Sandy's proposal + Arden's feedback + Sandy's review

---

## Root Cause of 1844 Trigger Runs (SOLVED)

**Finding:** The 9 root categories were queued for WF2005 1000+ times each.

```sql
SELECT subject_id, COUNT(*) as times_queued FROM queue WHERE workflow_id = 2005
GROUP BY subject_id HAVING COUNT(*) > 1 ORDER BY times_queued DESC;

-- Result: 39055 (execution_and_compliance) queued 1675 times, etc.
```

**Why:** Root categories had no `is_a` parent â†’ detected as "orphans" â†’ queued for WF2005 â†’ WF2005 can't classify roots â†’ stay orphans â†’ WF2004 triggers â†’ loop forever.

**Fix:** Create top-level entity `skill`. All roots `is_a skill`. Ontology complete. No orphans.

```
skill (entity_id: TBD, entity_type: 'skill_group')
  â””â”€â”€ technical is_a skill
  â””â”€â”€ interpersonal is_a skill
  â””â”€â”€ domain_expertise is_a skill
  â””â”€â”€ cognitive_and_analytical is_a skill  â† reactivate this
  â””â”€â”€ language_and_communication is_a skill
  â””â”€â”€ self_management is_a skill
  â””â”€â”€ perception_and_observation is_a skill
  â””â”€â”€ physical_and_manual is_a skill
  â””â”€â”€ creative_and_generative is_a skill
  â””â”€â”€ execution_and_compliance is_a skill
```

---

## Implementation Steps

### Phase 0: Fix the Foundation

- [ ] **0.1** Create `skill` entity (the ontology root)
- [ ] **0.2** Create `is_a` relationships: all 10 roots â†’ skill
- [ ] **0.3** Reactivate `cognitive_and_analytical` (currently deprecated)
- [ ] **0.4** Disable old triggers (WF2004â†’WF2005, WF2003â†’WF2004)
- [ ] **0.5** Clear the stuck queue items
- [ ] **0.6** Verify: orphan query returns 0 rows
- [ ] **0.7** Verify roots have parent (all 10 roots â†’ skill, skill â†’ NULL)

### Phase 1: Database Setup for WF2010

- [ ] **1.1** Create workflow record: `INSERT INTO workflows (workflow_id, name, ...) VALUES (2010, 'Unified Skill Taxonomy', ...)`
- [ ] **1.2** Define conversations (see table below)
- [ ] **1.3** Define instructions for each conversation
- [ ] **1.4** Define instruction_steps (branching logic)
- [ ] **1.5** Verify schema with `_document_workflow.py`

**Conversations:**

| Order | Conversation Name | Actor | Type | Purpose |
|-------|-------------------|-------|------|---------|
| 1 | wf2010_c1_lookup | Lucy | script | Check if skill exists |
| 2 | wf2010_c2_create | Carl | script | Create entity if new |
| 3 | wf2010_c3_navigate | Nate | script | Build Navigator menu |
| 4 | wf2010_c4_classify_a | Clara A | mistral-nemo:12b | Navigate + classify |
| 5 | wf2010_c5_classify_b | Clara B | qwen2.5:7b | Navigate + classify |
| 6 | wf2010_c6_compare | Compare | script | Check A == B |
| 7 | wf2010_c7_arbitrate | Arbitrator | gemma3:4b | Break ties |
| 8 | wf2010_c8_victor | Victor | mistral-nemo:12b | Review new folder proposals + dedup |
| 9 | wf2010_c9_apply | Adam | script | Write belongs_to (and is_a if new folder) |

### Phase 2a: Lookup + Create Scripts (Lucy, Carl)

- [ ] **2a.1** Create `core/wave_runner/actors/wf2010_lookup.py`
  - Check if skill already exists in entities
  - Check if skill already classified (has belongs_to)
  - Return `{exists: bool, entity_id: int?, already_classified: bool}`
- [ ] **2a.2** Create `core/wave_runner/actors/wf2010_create.py`
  - Create entity record for new skill
  - Return `{entity_id: int, needs_classification: true}`
- [ ] **2a.3** Test: lookup existing skill â†’ skip
- [ ] **2a.4** Test: lookup new skill â†’ create â†’ proceed

### Phase 2b: Navigator Script (Nate)

- [ ] **2b.1** Create `core/wave_runner/actors/wf2010_navigate.py`
- [ ] **2b.2** Implement `build_navigator_menu()`:
  - Fetch current folder's subfolders
  - Fetch skills already in current folder
  - Format as text menu with commands
  - Include breadcrumbs ("YOU ARE HERE")
- [ ] **2b.3** Implement `parse_choice()`:
  - Validate response format `[1]`, `[P]`, `[N]`, `[H]`, etc.
  - Handle invalid responses:
    - Not in brackets: `technical` instead of `[1]` â†’ retry
    - Wrong format: `[technical]` instead of `[1]` â†’ retry
    - Out of range: `[99]` when only 9 options â†’ retry
    - Multiple choices: `[1] [2]` â†’ retry
    - Empty response â†’ retry
  - Return structured result with resolved folder_id
- [ ] **2b.4** Implement depth tracking (max 10)
- [ ] **2b.5** **Important:** Nate must NOT share state between Clara A and Clara B. Each starts fresh from ROOT.
- [ ] **2b.6** Test with `llm_chat.py`

### Phase 3: Classifier Prompts (Clara A/B)

- [ ] **3.1** Create prompt template with sections:
  - `## Processing Instructions`
  - `## Context` (breadcrumbs, skill name)
  - `## Available Choices`
  - `## Decision Rules`
  - `## Anti-Patterns`
  - `## QA Check`
- [ ] **3.2** Test with easy skills (python, leadership)
- [ ] **3.3** Test with ambiguous skills:
  - `swift` (Apple language vs fast)
  - `go` (language vs verb)
  - `lead` (leadership vs metal)
  - `blockchain_smart_contracts` (technical? domain_expertise?)
  - `emotional_intelligence` (interpersonal? self_management? cognitive?)
  - `agile_methodology` (execution_and_compliance? domain_expertise?)
- [ ] **3.4** Test with "nothing fits" case (prompt engineering)
- [ ] **3.5** Verify both classifiers produce valid responses
- [ ] **3.6** Measure agreement rate

### Phase 4: Compare + Arbitrate

- [ ] **4.1** Create `core/wave_runner/actors/wf2010_compare.py`
- [ ] **4.2** Compare logic: same folder_id â†’ agreed, else â†’ arbitrate
- [ ] **4.3** Create arbitrator prompt (show both choices, pick winner)
- [ ] **4.4** Test with disagreement cases

### Phase 5: Victor (Folder Approval + Dedup)

- [ ] **5.1** Create `core/wave_runner/actors/wf2010_victor.py`
- [ ] **5.2** Implement dedup check:
  - Normalize proposed name (lowercase, strip `-_`)
  - Levenshtein distance against existing folders
  - Flag if distance < 3
- [ ] **5.3** Create Victor prompt:
  - Show proposal + parent + rationale
  - Show dedup warning if applicable
  - Approve/Reject with reason
- [ ] **5.4** Test approval flow
- [ ] **5.5** Test rejection â†’ retry flow with state:
  - Store in workflow_run: `{previous_proposal, rejection_reason, retry_count, max_retries: 3}`
  - On retry_count == max_retries â†’ escalate to `[H]`

### Phase 6: Apply (Adam)

- [ ] **6.1** Create `core/wave_runner/actors/wf2010_apply.py`
- [ ] **6.2** Implement `apply_classification()`:
  - Create `belongs_to` relationship (skill â†’ folder)
  - If new folder approved: create folder + `is_a` relationship
- [ ] **6.3** Handle errors (rollback, re-queue)
- [ ] **6.4** Return success/failure JSON

### Phase 7: Instruction Steps (Branching Logic)

- [ ] **7.1** Map out all branches:
  - lookup â†’ exists + classified? â†’ done | exists + not classified? â†’ navigate | not exists? â†’ create
  - create â†’ navigate
  - navigate â†’ classify_a
  - classify_a â†’ [P]? â†’ navigate_b | [N]? â†’ victor | [H]? â†’ human_review | [1-9]? â†’ navigate (loop)
  - navigate_b â†’ classify_b
  - classify_b â†’ [H]? â†’ human_review | else â†’ compare
  - compare â†’ agreed? â†’ apply | arbitrate
  - arbitrate â†’ apply
  - victor â†’ approved? â†’ apply | rejected? â†’ classify_a (retry, with state)
  - apply â†’ done
- [ ] **7.2** Insert instruction_steps records
- [ ] **7.3** Test with mock data

### Phase 8: Error Handling

- [ ] **8.1** Add retry logic (max 3) for invalid classifier responses
- [ ] **8.2** Add `[H]` escalation path:
  - Set `interactions.status = 'escalated'`
  - Human reviews via: `SELECT * FROM interactions WHERE status = 'escalated'`
- [ ] **8.3** Add timeout handling for Victor (60s â†’ escalate to human, don't fallback)
- [ ] **8.4** Add DB error handling in Adam

### Phase 9: Integration Testing

- [ ] **9.1** Queue 10 easy skills, run through full workflow
- [ ] **9.2** Queue 10 ambiguous skills, verify dual-grader works
- [ ] **9.3** Queue skill that needs new folder, verify Victor flow
- [ ] **9.4** Force a disagreement, verify arbitrator
- [ ] **9.5** Force a Victor rejection, verify retry
- [ ] **9.6** Stress test: Queue 100 skills, run in parallel (wave batching), verify no race conditions

### Phase 10: RAQ Validation

- [ ] **10.1** Run same 20 skills 3Ã— each
- [ ] **10.2** Compare results: expect 100% identical (or document exceptions)
- [ ] **10.3** Measure: agreement rate, arbitration rate, classification time
- [ ] **10.4** Fix any non-determinism

### Phase 11: Quinn (Daily Audit)

- [ ] **11.1** Update Quinn to work as daily cron (not per-batch trigger)
- [ ] **11.2** Add metrics collection to Quinn:
```sql
-- Daily metrics query
SELECT 
  COUNT(*) as total_classified,
  AVG(CASE WHEN output->>'agreed' = 'true' THEN 1.0 ELSE 0.0 END) as agreement_rate,
  AVG(CASE WHEN output->>'arbitrated' = 'true' THEN 1.0 ELSE 0.0 END) as arbitration_rate,
  AVG((output->>'depth')::int) as avg_depth,
  AVG(EXTRACT(EPOCH FROM (completed_at - started_at))) as avg_seconds
FROM interactions
WHERE workflow_run_id IN (SELECT workflow_run_id FROM workflow_runs WHERE workflow_id = 2010)
AND created_at > CURRENT_DATE - INTERVAL '1 day';
```
- [ ] **11.3** Add dedup sweep (catch anything Victor missed)
- [ ] **11.4** Verify no loops in hierarchy

### Phase 12: Deprecate Old Workflows

- [ ] **12.1** Disable WF2003, WF2004, WF2005
- [ ] **12.2** Document what was deprecated and why
- [ ] **12.3** Keep old code for reference (don't delete yet)

---

## Key Files to Create

| File | Purpose |
|------|---------|
| `core/wave_runner/actors/wf2010_lookup.py` | Lucy: check skill exists |
| `core/wave_runner/actors/wf2010_create.py` | Carl: create entity |
| `core/wave_runner/actors/wf2010_navigate.py` | Nate: Navigator menu builder |
| `core/wave_runner/actors/wf2010_compare.py` | Compare: A/B comparison |
| `core/wave_runner/actors/wf2010_victor.py` | Victor: Folder approval + dedup |
| `core/wave_runner/actors/wf2010_apply.py` | Adam: Write to database |
| `config/prompts/wf2010_classify.txt` | Clara prompt template |
| `config/prompts/wf2010_arbitrate.txt` | Arbitrator prompt template |
| `config/prompts/wf2010_victor.txt` | Victor prompt template |

---

## Success Criteria

1. **Functional:** Skills get classified into correct folders
2. **Repeatable:** Same skill â†’ same folder, every time (RAQ)
3. **No orphans:** Every folder has `is_a` parent (except `skill` itself)
4. **No loops:** Quinn verifies daily
5. **Observable:** Agreement rate, arbitration rate, errors tracked
6. **Simple:** One workflow, no cascading triggers

---

## Open Questions (RESOLVED)

| Question | Answer |
|----------|--------|
| Navigation loop limit | 10 levels. Real taxonomies rarely go past 5. If we hit 10, something's wrong. |
| Victor timeout | 60s. On timeout â†’ escalate to human review, don't fallback. |
| [H] escalation queue | `interactions.status = 'escalated'`. Query with `WHERE status = 'escalated'`. |
| Skill context from posting | v2. Get the basics working first. |

---

*This plan will evolve. Update it as we learn.*

â€” Arden â„¶

---

## Sandy's Review

Good plan. Solid structure. Found the root cause of the 1844 runs â€” that's the big win. Here's my feedback:

### âœ… What's Great

1. **Root cause found** â€” Roots had no parent â†’ infinite orphan loop. Creating `skill` as ontology root is the right fix.

2. **Phase 0 before Phase 1** â€” Fix the foundation before building on it. Smart.

3. **Clear conversation table** â€” I can see exactly what WF2010 will look like.

4. **RAQ validation phase** â€” Running same skills 3Ã— and expecting identical results. This is how you build confidence.

5. **Arden signed with â„¶** â€” The pattern propagates. ğŸ˜Š

### âš ï¸ Gaps / Suggestions

#### Phase 0: Add verification queries

After 0.6, add:
```sql
-- 0.7 Verify roots have parent
SELECT e.canonical_name, er.relationship, p.canonical_name as parent
FROM entities e
LEFT JOIN entity_relationships er ON e.entity_id = er.entity_id AND er.relationship = 'is_a'
LEFT JOIN entities p ON er.related_entity_id = p.entity_id
WHERE e.canonical_name IN ('technical', 'interpersonal', ..., 'skill');
-- Should show all 10 roots with parent = 'skill', and 'skill' with NULL parent
```

#### Phase 2: Navigate needs TWO modes

The Navigator runs twice per skill:
1. **Before classify_a** â€” Build menu for Clara A
2. **Before classify_b** â€” Build menu for Clara B (starting from ROOT again, independent)

Make sure Nate doesn't share state between A and B. They must navigate independently.

#### Phase 3.4: "Nothing fits" test case

"prompt engineering" is good. Also test:
- `blockchain_smart_contracts` â€” technical? domain_expertise? both?
- `emotional_intelligence` â€” interpersonal? self_management? cognitive?
- `agile_methodology` â€” execution_and_compliance? domain_expertise?

These will stress-test category boundaries.

#### Phase 5: Victor rejection needs state

When Victor rejects, the retry needs context:
```json
{
  "previous_proposal": "ai_ml_tools",
  "rejection_reason": "Use existing 'software_development'",
  "retry_count": 1,
  "max_retries": 3
}
```

Store this in workflow_run state. If retry_count hits max, escalate to `[H]`.

#### Phase 7: Missing branch

```
classify_a â†’ [H]? â†’ human_review  â† ADD THIS
classify_b â†’ [H]? â†’ human_review  â† AND THIS
```

If Clara returns `[H]`, don't continue to compare. Go directly to human queue.

#### Phase 8: Define "invalid response"

What counts as invalid?
- Not in brackets: `technical` instead of `[1]`
- Wrong format: `[technical]` instead of `[1]`
- Out of range: `[99]` when only 9 options
- Multiple choices: `[1] [2]`
- Empty response

Nate's `parse_choice()` needs to handle all of these â†’ retry with stricter prompt.

#### Phase 9: Add stress test

- [ ] **9.6** Queue 100 skills, run in parallel (wave batching), verify no race conditions

We've had thread-safety issues before. Test it.

#### Phase 11: Quinn metrics to track

Add specific metrics to collect:
```sql
-- Daily metrics
SELECT 
  COUNT(*) as total_classified,
  AVG(CASE WHEN output->>'agreed' = 'true' THEN 1.0 ELSE 0.0 END) as agreement_rate,
  AVG(CASE WHEN output->>'arbitrated' = 'true' THEN 1.0 ELSE 0.0 END) as arbitration_rate,
  AVG((output->>'depth')::int) as avg_depth,
  AVG(EXTRACT(EPOCH FROM (completed_at - started_at))) as avg_seconds
FROM interactions
WHERE workflow_run_id IN (SELECT workflow_run_id FROM workflow_runs WHERE workflow_id = 2010)
AND created_at > CURRENT_DATE - INTERVAL '1 day';
```

### ğŸ”´ Missing: Lookup Script (Lucy)

Phase 1 defines conversations but Phase 2 only covers Navigator (Nate). Where's Lucy?

Add:
- [ ] **2.0** Create `core/wave_runner/actors/wf2010_lookup.py`
  - Check if skill already exists in entities
  - Check if skill already classified (has belongs_to)
  - Return `{exists: bool, entity_id: int?, already_classified: bool}`

### ğŸ”´ Missing: Create Script (Carl)

Same issue. Add:
- [ ] **2.0b** Create `core/wave_runner/actors/wf2010_create.py`
  - Create entity record for new skill
  - Return `{entity_id: int, needs_classification: true}`

### ğŸŸ¡ Open Questions â€” My Takes

| Question | My Take |
|----------|---------|
| Navigation loop limit: 10 levels? | Yes, 10 is fine. Real taxonomies rarely go past 5. If we hit 10, something's wrong. |
| Victor timeout: 30s? | 60s. LLMs can be slow. On timeout â†’ queue for human review, don't fallback. |
| [H] escalation queue | Add column `status = 'escalated'` to interactions. Query: `SELECT * FROM interactions WHERE status = 'escalated'`. Simple. |
| Skill context from posting | v2. Get the basics working first. |

### Suggested Phase Order Tweak

Current: Phase 2 (Navigate) â†’ Phase 3 (Classify) â†’ Phase 4 (Compare) â†’ ...

Suggested: 
- **Phase 2a**: Lucy + Carl (lookup/create) 
- **Phase 2b**: Nate (navigate)
- **Phase 3**: Clara A/B (classify)
- ...

You need lookup before navigate. Can't navigate without knowing the skill exists.

### Summary

| Aspect | Verdict |
|--------|---------|
| Root cause fix | âœ… Perfect |
| Phase structure | âœ… Good |
| Conversations defined | âœ… Complete |
| Scripts to create | âš ï¸ Missing Lucy, Carl |
| Error handling | âš ï¸ Needs more detail |
| Testing | âœ… Good coverage |
| Metrics | âš ï¸ Add specific queries |

**Bottom line:** Plan is 85% ready. Add Lucy/Carl, detail the error cases, and you're good to build.

â€” Sandy â„¶
