{% extends "base.html" %}

{% block title %}Dashboard ‚Äî talent.yoga{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}
    
    {% set active_page = 'dashboard' %}
    {% include "partials/sidebar.html" %}
    
    <main class="main-content">
        <!-- Journey Tracker ‚Äî 3-column progress board -->
        <section class="journey-board" id="journey-board">

            <!-- Column A: Resume -->
            <div class="journey-column">
                <div class="journey-column-header">
                    <span class="journey-column-icon">üìã</span>
                    <h2 class="journey-column-title">{{ t('dashboard.journey_resume') }}</h2>
                </div>
                <div class="journey-steps">
                    <a href="/profile" class="journey-step" id="step-a1" data-step="upload_create">
                        <span class="step-status" id="status-a1">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_upload_create') }}</div>
                            <div class="step-detail" id="detail-a1"></div>
                            <div class="step-progress-bar" id="progress-a1" style="display:none;">
                                <div class="step-progress-fill" id="fill-a1"></div>
                            </div>
                        </div>
                    </a>
                    <a href="/profile" class="journey-step" id="step-a2" data-step="fix_gaps">
                        <span class="step-status" id="status-a2">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_fix_gaps') }}</div>
                            <div class="step-detail" id="detail-a2"></div>
                        </div>
                    </a>
                    <a href="/profile#skills" class="journey-step" id="step-a3" data-step="confirm_skills">
                        <span class="step-status" id="status-a3">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_confirm_skills') }}</div>
                            <div class="step-detail" id="detail-a3"></div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Column B: Search -->
            <div class="journey-column">
                <div class="journey-column-header">
                    <span class="journey-column-icon">üîç</span>
                    <h2 class="journey-column-title">{{ t('dashboard.journey_search') }}</h2>
                </div>
                <div class="journey-steps">
                    <a href="/search" class="journey-step" id="step-b1" data-step="define_search">
                        <span class="step-status" id="status-b1">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_define_search') }}</div>
                            <div class="step-detail" id="detail-b1"></div>
                        </div>
                    </a>
                    <a href="/matches" class="journey-step" id="step-b2" data-step="review_matches">
                        <span class="step-status" id="status-b2">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_review_matches') }}</div>
                            <div class="step-detail" id="detail-b2"></div>
                        </div>
                    </a>
                    <a href="/search" class="journey-step" id="step-b3" data-step="select_favorites">
                        <span class="step-status" id="status-b3">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_select_favorites') }}</div>
                            <div class="step-detail" id="detail-b3"></div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Column C: Apply -->
            <div class="journey-column">
                <div class="journey-column-header">
                    <span class="journey-column-icon">üöÄ</span>
                    <h2 class="journey-column-title">{{ t('dashboard.journey_apply') }}</h2>
                </div>
                <div class="journey-steps">
                    <a href="#" class="journey-step" id="step-c1" data-step="ship_documents">
                        <span class="step-status" id="status-c1">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_ship_documents') }}</div>
                            <div class="step-detail" id="detail-c1"></div>
                        </div>
                    </a>
                    <a href="#" class="journey-step" id="step-c2" data-step="await_reply">
                        <span class="step-status" id="status-c2">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_await_reply') }}</div>
                            <div class="step-detail" id="detail-c2"></div>
                        </div>
                    </a>
                    <a href="#" class="journey-step" id="step-c3" data-step="train_coach">
                        <span class="step-status" id="status-c3">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_train_coach') }}</div>
                            <div class="step-detail" id="detail-c3"></div>
                        </div>
                    </a>
                    <a href="#" class="journey-step" id="step-c4" data-step="interview">
                        <span class="step-status" id="status-c4">üí§</span>
                        <div class="step-content">
                            <div class="step-label">{{ t('dashboard.step_interview') }}</div>
                            <div class="step-detail" id="detail-c4"></div>
                        </div>
                    </a>
                </div>
            </div>

        </section>
        
        <!-- Sentence of the Day (Easter Egg) -->
        <footer class="daily-quote">
            <p id="daily-quote">‚Äû{{ t('dashboard.quote_default') }}"</p>
        </footer>
    </main>
</div>

<!-- Mira Chat Widget -->
<div id="mira-widget" class="mira-widget">
    <button class="mira-fab" onclick="toggleMiraChat()" title="Chat mit Mira">
        <span class="mira-fab-icon">üí¨</span>
        <span class="mira-fab-close">‚úï</span>
    </button>
    
    <div class="mira-chat-window">
        <div class="mira-header">
            <div class="mira-avatar">üßò</div>
            <div class="mira-title">
                <span class="mira-name">Mira</span>
                <span class="mira-status">Deine Begleiterin</span>
            </div>
            <button class="mira-minimize" onclick="toggleMiraChat()">‚àí</button>
        </div>
        
        <div class="mira-messages" id="mira-messages">
            <!-- Messages will be inserted here -->
        </div>
        
        <div class="mira-input-area">
            <textarea id="mira-input" placeholder="Schreib mir..." rows="1" onkeydown="handleMiraKeydown(event)"></textarea>
            <button class="mira-send" onclick="sendMiraMessage()">
                <span>‚û§</span>
            </button>
        </div>
    </div>
</div>

<!-- i18n data for JavaScript -->
<script>
const LANG = '{{ lang }}';
const I18N = {
    common: {
        today: '{{ t("common.today") }}',
        yesterday: '{{ t("common.yesterday") }}',
        days_ago: '{{ t("common.days_ago") }}',
        weeks_ago: '{{ t("common.weeks_ago") }}',
        months_ago: '{{ t("common.months_ago") }}',
        loading: '{{ t("common.loading") }}',
        error: '{{ t("common.error") }}'
    },
    dashboard: {
        no_matches: '{{ t("dashboard.no_matches") }}',
        complete_profile: '{{ t("dashboard.complete_profile") }}',
        strong_match: '{{ t("dashboard.strong_match") }}',
        partial_match: '{{ t("dashboard.partial_match") }}',
        details: '{{ t("dashboard.details") }}',
        unknown_company: '{{ t("dashboard.unknown_company") }}'
    }
};
</script>
    <!-- Styles moved to /static/css/style.css -->
<script>
// Generate company logo color from name
function getLogoColor(name) {
    const colors = [
        '#667eea', '#764ba2', '#f59e0b', '#10b981', 
        '#3b82f6', '#ef4444', '#8b5cf6', '#06b6d4'
    ];
    let hash = 0;
    for (let i = 0; i < (name || '').length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

// Get company initials
function getInitials(name) {
    if (!name) return '??';
    const words = name.split(/\s+/);
    if (words.length >= 2) {
        return (words[0][0] + words[1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}

// Time ago - i18n aware
function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (days === 0) return I18N.common.today;
    if (days === 1) return I18N.common.yesterday;
    if (days < 7) return I18N.common.days_ago.replace('{n}', days);
    if (days < 30) return I18N.common.weeks_ago.replace('{n}', Math.floor(days / 7));
    return I18N.common.months_ago.replace('{n}', Math.floor(days / 30));
}

// Load journey tracker ‚Äî single call
const STATUS_ICONS = { not_started: 'üí§', in_progress: 'üõ†', complete: '‚úî' };

async function loadJourney() {
    try {
        const res = await fetch('/api/home/journey');
        if (!res.ok) return;
        const j = await res.json();

        // A: Resume
        setStep('a1', j.resume.upload_create);
        setStep('a2', j.resume.fix_gaps);
        setStep('a3', j.resume.confirm_skills);

        // Progress bar for A1
        if (j.resume_pct > 0) {
            const bar = document.getElementById('progress-a1');
            const fill = document.getElementById('fill-a1');
            bar.style.display = '';
            fill.style.width = j.resume_pct + '%';
        }

        // B: Search
        setStep('b1', j.search.define_search);
        const b2 = j.search.review_matches;
        if (b2.detail) {
            b2.detail = b2.detail + ' ' + (LANG === 'de' ? 'ungelesen' : 'unread');
        }
        setStep('b2', b2);
        const b3 = j.search.select_favorites;
        if (b3.detail) {
            b3.detail = b3.detail + ' ‚ù§Ô∏è';
        }
        setStep('b3', b3);

        // C: Apply
        setStep('c1', j.apply.ship_documents);
        setStep('c2', j.apply.await_reply);
        setStep('c3', j.apply.train_coach);
        setStep('c4', j.apply.interview);

    } catch (err) {
        console.error('Failed to load journey:', err);
    }
}

function setStep(id, data) {
    const statusEl = document.getElementById('status-' + id);
    const detailEl = document.getElementById('detail-' + id);
    const stepEl = document.getElementById('step-' + id);

    if (statusEl) statusEl.textContent = STATUS_ICONS[data.status] || 'üí§';
    if (detailEl) detailEl.textContent = data.detail || '';
    if (stepEl) {
        stepEl.classList.remove('step-not-started', 'step-in-progress', 'step-complete');
        stepEl.classList.add('step-' + data.status.replace('_', '-'));
    }
}

// Load job cards
async function loadJobCards() {
    const container = document.getElementById('job-cards');
    
    try {
        const res = await fetch('/api/matches/?limit=5');
        if (!res.ok) throw new Error('Failed to load');
        
        const matches = await res.json();
        
        if (matches.length === 0) {
            container.innerHTML = `
                <div class="loading-placeholder">
                    <p>${I18N.dashboard.no_matches} <a href="/profile">${I18N.dashboard.complete_profile}</a></p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = matches.map(m => {
            const score = Math.round(m.skill_match_score * 100);
            const badgeClass = score >= 70 ? 'strong' : 'partial';
            const badgeText = score >= 70 ? I18N.dashboard.strong_match : I18N.dashboard.partial_match;
            const logoColor = getLogoColor(m.company);
            const initials = getInitials(m.company);
            const timeText = m.matched_at ? timeAgo(m.matched_at) : '';
            
            return `
                <div class="job-card">
                    <div class="job-logo" style="background: ${logoColor}">${initials}</div>
                    <div class="job-info">
                        <div class="job-title">${escapeHtml(m.title)}</div>
                        <div class="job-company">${escapeHtml(m.company || I18N.dashboard.unknown_company)}</div>
                        <div class="job-meta">
                            ${m.location ? `<span>üìç ${escapeHtml(m.location)}</span>` : ''}
                            <span>üìä ${score}% Match</span>
                            ${timeText ? `<span>üïê ${timeText}</span>` : ''}
                        </div>
                    </div>
                    <div class="job-actions">
                        <span class="match-badge ${badgeClass}">${badgeText}</span>
                        <a href="/report/${m.match_id}" class="job-btn">${I18N.dashboard.details}</a>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        container.innerHTML = `
            <div class="loading-placeholder">
                <p style="color: var(--error)">${I18N.common.error}. ${I18N.common.loading}</p>
            </div>
        `;
    }
}

// Escape HTML
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
}

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
}

// Restore theme on load
function restoreTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');
    
    if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
}

// Run theme restore immediately (before DOMContentLoaded)
restoreTheme();

// Toggle sidebar (mobile)
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay').classList.toggle('show');
}

// Toggle sidebar collapse (desktop)
function toggleSidebarCollapse() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const isCollapsed = sidebar.classList.toggle('collapsed');
    
    // Update main content margin
    document.body.classList.toggle('sidebar-collapsed', isCollapsed);
    
    // Persist to localStorage
    localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
}

// Restore sidebar state on load
function restoreSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed && window.innerWidth > 768) {
        document.getElementById('sidebar').classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
    }
}

// Notifications
function toggleNotifications(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('notif-dropdown');
    dropdown.classList.toggle('show');
}

// Load notifications badge and list
async function loadNotifications() {
    try {
        const countRes = await fetch('/api/notifications/count');
        if (countRes.ok) {
            const data = await countRes.json();
            const badge = document.getElementById('notif-badge');
            if (badge && data.unread > 0) {
                badge.textContent = data.unread > 9 ? '9+' : data.unread;
                badge.classList.remove('hidden');
            } else if (badge) {
                badge.classList.add('hidden');
            }
        }

        const listRes = await fetch('/api/notifications/?limit=10');
        if (listRes.ok) {
            const notifications = await listRes.json();
            renderNotifications(notifications);
        }
    } catch (err) {
        console.error('Failed to load notifications:', err);
    }
}

function renderNotifications(notifications) {
    const list = document.getElementById('notif-list');
    if (!list) return;

    if (notifications.length === 0) {
        list.innerHTML = '<li class="notification-empty">Keine Benachrichtigungen</li>';
        return;
    }

    list.innerHTML = notifications.map(n => `
        <li class="notification-item ${n.read_at ? '' : 'unread'}"
            onclick="clickNotification(${n.notification_id}, '${escapeHtml(n.link || '')}')">
            <div class="notification-title">${escapeHtml(n.title)}</div>
            ${n.message ? `<div class="notification-message">${escapeHtml(n.message)}</div>` : ''}
            <div class="notification-time">${timeAgo(n.created_at)}</div>
        </li>
    `).join('');
}

async function clickNotification(id, link) {
    await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
    loadNotifications();
    if (link) window.location.href = link;
}

async function markAllRead(e) {
    e.stopPropagation();
    await fetch('/api/notifications/read-all', { method: 'POST' });
    loadNotifications();
}

// Close dropdown on outside click
document.addEventListener('click', (e) => {
    if (!e.target.closest('.nav-notifications')) {
        const dd = document.getElementById('notif-dropdown');
        if (dd) dd.classList.remove('show');
    }
});

// Init
document.addEventListener('DOMContentLoaded', () => {
    restoreSidebarState();
    loadJourney();
    loadDailyQuote();
    loadNotifications();
    triggerMiraGreeting();
});

// Mira greeting ‚Üí vibrate the FAB, then auto-open with LLM greeting
async function triggerMiraGreeting() {
    const widget = document.getElementById('mira-widget');
    const fab = widget.querySelector('.mira-fab');

    // If tour is active or about to start, defer ‚Äî tour will call us when done
    if (window._tourActive) return;
    const tourCompleted = localStorage.getItem('mira_tour_completed');
    if (!tourCompleted && window.location.pathname.includes('/dashboard')) {
        // Tour hasn't run yet ‚Äî it will trigger us after completion
        return;
    }
    
    // Mark greeted immediately to prevent duplicate from toggleMiraChat
    miraState.hasGreeted = true;
    
    // Step 1: Fetch the greeting in background
    let greetingText = 'Hallo! Wie kann ich dir helfen?';
    let suppress = false;
    try {
        const res = await fetch('/api/mira/greeting');
        if (res.ok) {
            const data = await res.json();
            if (data.greeting) greetingText = data.greeting;
            if (data.suppress_greeting) suppress = true;
        }
    } catch (e) { /* fallback */ }

    // If yogi has ignored Mira 3+ times, stay closed ‚Äî no auto-open
    if (suppress) {
        // Store greeting so it shows when yogi manually opens chat
        miraState._pendingGreeting = greetingText;
        return;
    }
    
    // Step 2: After a beat, vibrate the FAB to signal incoming
    setTimeout(() => {
        fab.classList.add('mira-incoming');
        
        // Step 3: After vibration, dramatically open and show greeting
        setTimeout(() => {
            fab.classList.remove('mira-incoming');
            miraState.isOpen = true;
            widget.classList.add('open');
            addMiraMessage(greetingText, false);
            
            // Focus input after animation
            setTimeout(() => {
                const input = document.getElementById('mira-input');
                if (input) input.focus();
            }, 400);
        }, 1200);
    }, 800);
}

// T004: Load suggested next steps based on user state
async function loadNextSteps() {
    const container = document.getElementById('next-steps');
    const steps = [];
    
    try {
        // Check profile completeness
        const profileRes = await fetch('/api/profiles/me');
        if (profileRes.ok) {
            const profile = await profileRes.json();
            if (profile.completeness < 100) {
                steps.push({
                    icon: '‚úèÔ∏è',
                    title: 'Profil vervollst√§ndigen',
                    desc: `Aktuell ${profile.completeness}% ‚Äî mehr Daten = bessere Matches`,
                    href: '/profile'
                });
            }
        }
        
        // Check for unreviewed matches
        const matchRes = await fetch('/api/matches/stats');
        if (matchRes.ok) {
            const stats = await matchRes.json();
            if (stats.total_count > 0) {
                steps.push({
                    icon: 'üéØ',
                    title: `${stats.total_count} Matches ansehen`,
                    desc: stats.strong_count > 0 ? `${stats.strong_count} davon mit hoher √úbereinstimmung` : 'Schau dir die Vorschl√§ge an',
                    href: '/matches'
                });
            }
        }
        
        // Add skill confirmation suggestion
        steps.push({
            icon: 'üè∑Ô∏è',
            title: 'Skills best√§tigen',
            desc: 'Sind deine F√§higkeiten aktuell?',
            href: '/profile#skills'
        });
        
        // Add journey/coaching placeholder
        steps.push({
            icon: 'üìÖ',
            title: 'Termin mit Adele buchen',
            desc: 'Pers√∂nliche Beratung f√ºr deine n√§chsten Schritte',
            href: '#'
        });
        
    } catch (err) {
        console.error('Failed to build next steps:', err);
        // Fallback steps
        steps.push(
            { icon: 'üìã', title: 'Profil ansehen', desc: '√úberpr√ºfe deine Daten', href: '/profile' },
            { icon: 'üéØ', title: 'Matches entdecken', desc: 'Passende Stellen finden', href: '/matches' }
        );
    }
    
    // Render steps (max 4)
    container.innerHTML = steps.slice(0, 4).map(s => `
        <a href="${s.href}" class="next-step">
            <span class="next-step-icon">${s.icon}</span>
            <div class="next-step-content">
                <div class="next-step-title">${s.title}</div>
                <div class="next-step-desc">${s.desc}</div>
            </div>
            <span class="next-step-arrow">‚Üí</span>
        </a>
    `).join('');
}

// T004: Daily quote easter egg
function loadDailyQuote() {
    const quotes = [
        '‚ÄûDer Weg entsteht beim Gehen." ‚Äî Antonio Machado',
        '‚ÄûJeder Tag ist ein neuer Anfang." ‚Äî T.S. Eliot',
        '‚ÄûDu bist genug, genau so wie du bist."',
        '‚ÄûGeduld ist auch eine Form von Handeln." ‚Äî Auguste Rodin',
        '‚ÄûDer beste Zeitpunkt ist jetzt."',
        '‚ÄûKleine Schritte f√ºhren zu gro√üen Ver√§nderungen."',
        '‚ÄûVertraue dem Prozess."',
        '‚ÄûWas du suchst, sucht auch dich." ‚Äî Rumi',
        '‚ÄûMut steht am Anfang des Handelns, Gl√ºck am Ende." ‚Äî Demokrit',
        '‚ÄûSei die Ver√§nderung, die du in der Welt sehen m√∂chtest."'
    ];
    
    // Pick quote based on day of year (rotates through list)
    const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const quote = quotes[dayOfYear % quotes.length];
    
    const el = document.getElementById('daily-quote');
    if (el) el.textContent = quote;
}

// Close sidebar on outside click (mobile)
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
        if (!e.target.closest('.sidebar') && !e.target.closest('.hamburger')) {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        }
    }
});

// ========================================
// Mira Chat Widget
// ========================================

const miraState = {
    isOpen: false,
    hasGreeted: false,
    usesDu: null,  // null = unknown, will mirror user
    history: []    // Conversation history for LLM context
};

function toggleMiraChat() {
    const widget = document.getElementById('mira-widget');
    miraState.isOpen = !miraState.isOpen;
    widget.classList.toggle('open', miraState.isOpen);
    
    if (miraState.isOpen && !miraState.hasGreeted) {
        loadMiraGreeting();
        miraState.hasGreeted = true;
    } else if (miraState.isOpen && miraState._pendingGreeting) {
        // Greeting was suppressed ‚Äî show it now that yogi opened manually
        addMiraMessage(miraState._pendingGreeting, false);
        miraState._pendingGreeting = null;
    }
    
    if (miraState.isOpen) {
        setTimeout(() => {
            document.getElementById('mira-input').focus();
        }, 300);
    }
}

function loadMiraGreeting() {
    // Fetch LLM-generated greeting from Mira (with memory)
    fetch('/api/mira/greeting')
        .then(res => res.ok ? res.json() : null)
        .then(data => {
            if (data && data.greeting) {
                addMiraMessage(data.greeting, false);
            } else {
                addMiraMessage('Hallo! Wie kann ich dir helfen?', false);
            }
        })
        .catch(() => {
            addMiraMessage('Hallo! Wie kann ich dir helfen?', false);
        });
}

function addMiraMessage(content, isUser) {
    const container = document.getElementById('mira-messages');
    const msg = document.createElement('div');
    msg.className = `mira-message ${isUser ? 'user' : 'mira'}`;
    msg.textContent = content;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
}

function showMiraTyping() {
    const container = document.getElementById('mira-messages');
    const typing = document.createElement('div');
    typing.className = 'mira-typing';
    typing.id = 'mira-typing';
    typing.innerHTML = '<span></span><span></span><span></span>';
    container.appendChild(typing);
    container.scrollTop = container.scrollHeight;
}

function hideMiraTyping() {
    const typing = document.getElementById('mira-typing');
    if (typing) typing.remove();
}

async function sendMiraMessage() {
    const input = document.getElementById('mira-input');
    const text = input.value.trim();
    if (!text) return;
    
    // Add user message
    addMiraMessage(text, true);
    input.value = '';
    input.style.height = 'auto';
    
    // Detect Du/Sie from user message
    if (miraState.usesDu === null) {
        if (/\b(du|dein|dich|dir)\b/i.test(text)) {
            miraState.usesDu = true;
        } else if (/\b(Sie|Ihr|Ihnen|Ihre)\b/.test(text)) {
            miraState.usesDu = false;
        }
    }
    
    // Show typing indicator
    showMiraTyping();
    
    // Add to history before sending
    miraState.history.push({ role: 'user', content: text });
    
    try {
        const response = await fetch('/api/mira/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: text,
                uses_du: miraState.usesDu,
                history: miraState.history.slice(0, -1)  // Send history without current message
            })
        });
        
        hideMiraTyping();
        
        if (response.ok) {
            const data = await response.json();
            addMiraMessage(data.reply, false);
            // Add assistant response to history
            miraState.history.push({ role: 'assistant', content: data.reply });
            // Keep history reasonable (last 10 exchanges = 20 messages)
            if (miraState.history.length > 20) {
                miraState.history = miraState.history.slice(-20);
            }
        } else {
            addMiraMessage('Entschuldigung, da ist etwas schiefgelaufen. Versuch es bitte nochmal.', false);
            // Remove failed message from history
            miraState.history.pop();
        }
    } catch (error) {
        hideMiraTyping();
        addMiraMessage('Ich kann gerade nicht antworten. Bitte versuch es sp√§ter nochmal.', false);
        // Remove failed message from history
        miraState.history.pop();
        console.error('Mira chat error:', error);
    }
}

function handleMiraKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMiraMessage();
    }
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', () => {
    const miraInput = document.getElementById('mira-input');
    if (miraInput) {
        miraInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    }
});
</script>
{% endblock %}
