{% extends "base.html" %}

{% block title %}Dashboard ‚Äî talent.yoga{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}
    
    {% set active_page = 'dashboard' %}
    {% include "partials/sidebar.html" %}
    
    <main class="main-content">
        <!-- T004: Home Redesign ‚Äî Mira-centered, no job cards -->
        
        <!-- Mira Greeting (Front and Center) -->
        <section class="mira-greeting-section">
            <div class="mira-greeting-card">
                <div class="mira-avatar-large">üßò</div>
                <div class="mira-greeting-content">
                    <h1 class="mira-greeting-text">{{ t('dashboard.welcome', name=(user.display_name.split()[0] if user.display_name else 'there')) }}</h1>
                    <p class="mira-subtext" id="mira-status-text">{{ t('dashboard.mira_checking') }}</p>
                </div>
            </div>
            
            <!-- Inline Mira Chat -->
            <div class="mira-inline-chat">
                <div class="mira-inline-messages" id="mira-inline-messages">
                    <div class="mira-message mira-message-bot">
                        <span class="mira-msg-avatar">üßò</span>
                        <div class="mira-msg-bubble">{{ t('dashboard.mira_intro') }}</div>
                    </div>
                </div>
                <div class="mira-inline-input">
                    <input type="text" id="mira-inline-input" placeholder="{{ t('dashboard.mira_placeholder') }}" onkeydown="if(event.key==='Enter')sendInlineMessage()">
                    <button onclick="sendInlineMessage()">‚û§</button>
                </div>
            </div>
        </section>
        
        <!-- Summary Cards (No job lists, just stats) -->
        <section class="summary-cards">
            <a href="/matches" class="summary-card">
                <div class="summary-icon">üéØ</div>
                <div class="summary-content">
                    <span class="summary-number" id="stat-matches">‚Äî</span>
                    <span class="summary-label">{{ t('dashboard.matches_found') }}</span>
                </div>
                <div class="summary-detail" id="match-detail">{{ t('dashboard.click_to_review') }}</div>
            </a>
            
            <a href="/profile" class="summary-card">
                <div class="summary-icon">üìã</div>
                <div class="summary-content">
                    <span class="summary-number"><span id="stat-profile">‚Äî</span>%</span>
                    <span class="summary-label">{{ t('dashboard.profile_complete') }}</span>
                </div>
                <div class="summary-detail">{{ t('dashboard.click_to_complete') }}</div>
            </a>
            
            <a href="/journey" class="summary-card">
                <div class="summary-icon">üó∫Ô∏è</div>
                <div class="summary-content">
                    <span class="summary-number" id="journey-stage">‚Äî</span>
                    <span class="summary-label">{{ t('dashboard.your_journey') }}</span>
                </div>
                <div class="summary-detail">{{ t('dashboard.view_progress') }}</div>
            </a>
        </section>
        
        <!-- Suggested Next Steps -->
        <section class="next-steps-section">
            <h2>{{ t('dashboard.next_steps') }}</h2>
            <div class="next-steps" id="next-steps">
                <div class="loading-placeholder">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>
        
        <!-- Sentence of the Day (Easter Egg) -->
        <footer class="daily-quote">
            <p id="daily-quote">‚Äû{{ t('dashboard.quote_default') }}"</p>
        </footer>
    </main>
</div>

<!-- Mira Chat Widget -->
<div id="mira-widget" class="mira-widget">
    <button class="mira-fab" onclick="toggleMiraChat()" title="Chat mit Mira">
        <span class="mira-fab-icon">üí¨</span>
        <span class="mira-fab-close">‚úï</span>
    </button>
    
    <div class="mira-chat-window">
        <div class="mira-header">
            <div class="mira-avatar">üßò</div>
            <div class="mira-title">
                <span class="mira-name">Mira</span>
                <span class="mira-status">Deine Begleiterin</span>
            </div>
            <button class="mira-minimize" onclick="toggleMiraChat()">‚àí</button>
        </div>
        
        <div class="mira-messages" id="mira-messages">
            <!-- Messages will be inserted here -->
        </div>
        
        <div class="mira-input-area">
            <textarea id="mira-input" placeholder="Schreib mir..." rows="1" onkeydown="handleMiraKeydown(event)"></textarea>
            <button class="mira-send" onclick="sendMiraMessage()">
                <span>‚û§</span>
            </button>
        </div>
    </div>
</div>

<!-- i18n data for JavaScript -->
<script>
const LANG = '{{ lang }}';
const I18N = {
    common: {
        today: '{{ t("common.today") }}',
        yesterday: '{{ t("common.yesterday") }}',
        days_ago: '{{ t("common.days_ago") }}',
        weeks_ago: '{{ t("common.weeks_ago") }}',
        months_ago: '{{ t("common.months_ago") }}',
        loading: '{{ t("common.loading") }}',
        error: '{{ t("common.error") }}'
    },
    dashboard: {
        no_matches: '{{ t("dashboard.no_matches") }}',
        complete_profile: '{{ t("dashboard.complete_profile") }}',
        strong_match: '{{ t("dashboard.strong_match") }}',
        partial_match: '{{ t("dashboard.partial_match") }}',
        details: '{{ t("dashboard.details") }}',
        unknown_company: '{{ t("dashboard.unknown_company") }}'
    }
};
</script>
    <!-- Styles moved to /static/css/style.css -->
<script>
// Generate company logo color from name
function getLogoColor(name) {
    const colors = [
        '#667eea', '#764ba2', '#f59e0b', '#10b981', 
        '#3b82f6', '#ef4444', '#8b5cf6', '#06b6d4'
    ];
    let hash = 0;
    for (let i = 0; i < (name || '').length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

// Get company initials
function getInitials(name) {
    if (!name) return '??';
    const words = name.split(/\s+/);
    if (words.length >= 2) {
        return (words[0][0] + words[1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}

// Time ago - i18n aware
function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const days = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (days === 0) return I18N.common.today;
    if (days === 1) return I18N.common.yesterday;
    if (days < 7) return I18N.common.days_ago.replace('{n}', days);
    if (days < 30) return I18N.common.weeks_ago.replace('{n}', Math.floor(days / 7));
    return I18N.common.months_ago.replace('{n}', Math.floor(days / 30));
}

// Load stats
async function loadStats() {
    try {
        // Matches count (T011: use stats endpoint with proper filtering)
        const matchRes = await fetch('/api/matches/stats');
        if (matchRes.ok) {
            const stats = await matchRes.json();
            document.getElementById('stat-matches').textContent = stats.total_count;
            // Update match detail text
            const detail = document.getElementById('match-detail');
            if (detail && stats.strong_count > 0) {
                detail.textContent = `${stats.strong_count} starke Matches`;
            }
        }
        
        // Profile completeness (T010: use server-calculated value)
        const profileRes = await fetch('/api/profiles/me');
        if (profileRes.ok) {
            const profile = await profileRes.json();
            document.getElementById('stat-profile').textContent = profile.completeness;
            // Update Mira status based on profile
            const statusText = document.getElementById('mira-status-text');
            if (statusText) {
                if (profile.completeness < 50) {
                    statusText.textContent = 'Lass uns dein Profil vervollst√§ndigen!';
                } else if (profile.completeness < 100) {
                    statusText.textContent = 'Dein Profil sieht gut aus! Noch ein paar Details?';
                } else {
                    statusText.textContent = 'Super! Dein Profil ist vollst√§ndig.';
                }
            }
        } else {
            document.getElementById('stat-profile').textContent = '0';
        }
        
        // Journey stage placeholder
        const journeyEl = document.getElementById('journey-stage');
        if (journeyEl) journeyEl.textContent = 'Start';
        
    } catch (err) {
        console.error('Failed to load stats:', err);
    }
}

// Load job cards
async function loadJobCards() {
    const container = document.getElementById('job-cards');
    
    try {
        const res = await fetch('/api/matches/?limit=5');
        if (!res.ok) throw new Error('Failed to load');
        
        const matches = await res.json();
        
        if (matches.length === 0) {
            container.innerHTML = `
                <div class="loading-placeholder">
                    <p>${I18N.dashboard.no_matches} <a href="/profile">${I18N.dashboard.complete_profile}</a></p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = matches.map(m => {
            const score = Math.round(m.skill_match_score * 100);
            const badgeClass = score >= 70 ? 'strong' : 'partial';
            const badgeText = score >= 70 ? I18N.dashboard.strong_match : I18N.dashboard.partial_match;
            const logoColor = getLogoColor(m.company);
            const initials = getInitials(m.company);
            const timeText = m.matched_at ? timeAgo(m.matched_at) : '';
            
            return `
                <div class="job-card">
                    <div class="job-logo" style="background: ${logoColor}">${initials}</div>
                    <div class="job-info">
                        <div class="job-title">${escapeHtml(m.title)}</div>
                        <div class="job-company">${escapeHtml(m.company || I18N.dashboard.unknown_company)}</div>
                        <div class="job-meta">
                            ${m.location ? `<span>üìç ${escapeHtml(m.location)}</span>` : ''}
                            <span>üìä ${score}% Match</span>
                            ${timeText ? `<span>üïê ${timeText}</span>` : ''}
                        </div>
                    </div>
                    <div class="job-actions">
                        <span class="match-badge ${badgeClass}">${badgeText}</span>
                        <a href="/report/${m.match_id}" class="job-btn">${I18N.dashboard.details}</a>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        container.innerHTML = `
            <div class="loading-placeholder">
                <p style="color: var(--error)">${I18N.common.error}. ${I18N.common.loading}</p>
            </div>
        `;
    }
}

// Escape HTML
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
}

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
}

// Restore theme on load
function restoreTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');
    
    if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
}

// Run theme restore immediately (before DOMContentLoaded)
restoreTheme();

// Toggle sidebar (mobile)
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay').classList.toggle('show');
}

// Toggle sidebar collapse (desktop)
function toggleSidebarCollapse() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const isCollapsed = sidebar.classList.toggle('collapsed');
    
    // Update main content margin
    document.body.classList.toggle('sidebar-collapsed', isCollapsed);
    
    // Persist to localStorage
    localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
}

// Restore sidebar state on load
function restoreSidebarState() {
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed && window.innerWidth > 768) {
        document.getElementById('sidebar').classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
    }
}

// Notifications
function toggleNotifications(e) {
    e.stopPropagation();
    // TODO: Show notification dropdown
}

// Load notifications badge
async function loadNotifications() {
    try {
        const res = await fetch('/api/notifications/count');
        if (res.ok) {
            const data = await res.json();
            const badge = document.getElementById('notif-badge');
            if (badge && data.unread > 0) {
                badge.textContent = data.unread > 9 ? '9+' : data.unread;
                badge.classList.remove('hidden');
            }
        }
    } catch (err) {
        console.error('Failed to load notifications:', err);
    }
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    restoreSidebarState();
    loadStats();
    loadNextSteps();
    loadDailyQuote();
    loadNotifications();
});

// T004: Load suggested next steps based on user state
async function loadNextSteps() {
    const container = document.getElementById('next-steps');
    const steps = [];
    
    try {
        // Check profile completeness
        const profileRes = await fetch('/api/profiles/me');
        if (profileRes.ok) {
            const profile = await profileRes.json();
            if (profile.completeness < 100) {
                steps.push({
                    icon: '‚úèÔ∏è',
                    title: 'Profil vervollst√§ndigen',
                    desc: `Aktuell ${profile.completeness}% ‚Äî mehr Daten = bessere Matches`,
                    href: '/profile'
                });
            }
        }
        
        // Check for unreviewed matches
        const matchRes = await fetch('/api/matches/stats');
        if (matchRes.ok) {
            const stats = await matchRes.json();
            if (stats.total_count > 0) {
                steps.push({
                    icon: 'üéØ',
                    title: `${stats.total_count} Matches ansehen`,
                    desc: stats.strong_count > 0 ? `${stats.strong_count} davon mit hoher √úbereinstimmung` : 'Schau dir die Vorschl√§ge an',
                    href: '/matches'
                });
            }
        }
        
        // Add skill confirmation suggestion
        steps.push({
            icon: 'üè∑Ô∏è',
            title: 'Skills best√§tigen',
            desc: 'Sind deine F√§higkeiten aktuell?',
            href: '/profile#skills'
        });
        
        // Add journey/coaching placeholder
        steps.push({
            icon: 'üìÖ',
            title: 'Termin mit Adele buchen',
            desc: 'Pers√∂nliche Beratung f√ºr deine n√§chsten Schritte',
            href: '/journey'
        });
        
    } catch (err) {
        console.error('Failed to build next steps:', err);
        // Fallback steps
        steps.push(
            { icon: 'üìã', title: 'Profil ansehen', desc: '√úberpr√ºfe deine Daten', href: '/profile' },
            { icon: 'üéØ', title: 'Matches entdecken', desc: 'Passende Stellen finden', href: '/matches' }
        );
    }
    
    // Render steps (max 4)
    container.innerHTML = steps.slice(0, 4).map(s => `
        <a href="${s.href}" class="next-step">
            <span class="next-step-icon">${s.icon}</span>
            <div class="next-step-content">
                <div class="next-step-title">${s.title}</div>
                <div class="next-step-desc">${s.desc}</div>
            </div>
            <span class="next-step-arrow">‚Üí</span>
        </a>
    `).join('');
}

// T004: Daily quote easter egg
function loadDailyQuote() {
    const quotes = [
        '‚ÄûDer Weg entsteht beim Gehen." ‚Äî Antonio Machado',
        '‚ÄûJeder Tag ist ein neuer Anfang." ‚Äî T.S. Eliot',
        '‚ÄûDu bist genug, genau so wie du bist."',
        '‚ÄûGeduld ist auch eine Form von Handeln." ‚Äî Auguste Rodin',
        '‚ÄûDer beste Zeitpunkt ist jetzt."',
        '‚ÄûKleine Schritte f√ºhren zu gro√üen Ver√§nderungen."',
        '‚ÄûVertraue dem Prozess."',
        '‚ÄûWas du suchst, sucht auch dich." ‚Äî Rumi',
        '‚ÄûMut steht am Anfang des Handelns, Gl√ºck am Ende." ‚Äî Demokrit',
        '‚ÄûSei die Ver√§nderung, die du in der Welt sehen m√∂chtest."'
    ];
    
    // Pick quote based on day of year (rotates through list)
    const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    const quote = quotes[dayOfYear % quotes.length];
    
    const el = document.getElementById('daily-quote');
    if (el) el.textContent = quote;
}

// T004: Inline Mira chat (simpler version of floating widget)
async function sendInlineMessage() {
    const input = document.getElementById('mira-inline-input');
    const messagesContainer = document.getElementById('mira-inline-messages');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    messagesContainer.innerHTML += `
        <div class="mira-message mira-message-user">
            <div class="mira-msg-bubble">${escapeHtml(message)}</div>
        </div>
    `;
    input.value = '';
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Add thinking indicator
    const thinkingId = 'mira-thinking-' + Date.now();
    messagesContainer.innerHTML += `
        <div class="mira-message mira-message-bot" id="${thinkingId}">
            <span class="mira-msg-avatar">üßò</span>
            <div class="mira-msg-bubble">...</div>
        </div>
    `;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    try {
        const res = await fetch('/api/mira/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        
        if (res.ok) {
            const data = await res.json();
            document.getElementById(thinkingId).querySelector('.mira-msg-bubble').textContent = data.reply || data.response || 'Hmm...';
        } else {
            document.getElementById(thinkingId).querySelector('.mira-msg-bubble').textContent = 'Hmm, da ist etwas schiefgelaufen. Versuch es nochmal?';
        }
    } catch (err) {
        document.getElementById(thinkingId).querySelector('.mira-msg-bubble').textContent = 'Verbindungsproblem. Bitte sp√§ter nochmal versuchen.';
    }
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Close sidebar on outside click (mobile)
document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
        if (!e.target.closest('.sidebar') && !e.target.closest('.hamburger')) {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        }
    }
});

// ========================================
// Mira Chat Widget
// ========================================

const miraState = {
    isOpen: false,
    hasGreeted: false,
    usesDu: null,  // null = unknown, will mirror user
    history: []    // Conversation history for LLM context
};

function toggleMiraChat() {
    const widget = document.getElementById('mira-widget');
    miraState.isOpen = !miraState.isOpen;
    widget.classList.toggle('open', miraState.isOpen);
    
    if (miraState.isOpen && !miraState.hasGreeted) {
        loadMiraGreeting();
        miraState.hasGreeted = true;
    }
    
    if (miraState.isOpen) {
        setTimeout(() => {
            document.getElementById('mira-input').focus();
        }, 300);
    }
}

function loadMiraGreeting() {
    const userName = "{{ current_user.name if current_user else '' }}".split(' ')[0];
    const hour = new Date().getHours();
    
    let timeGreeting;
    if (hour < 12) {
        timeGreeting = 'Guten Morgen';
    } else if (hour < 18) {
        timeGreeting = 'Guten Tag';
    } else {
        timeGreeting = 'Guten Abend';
    }
    
    const greetings = [
        `${timeGreeting}${userName ? ', ' + userName : ''}! Ich bin Mira, deine Begleiterin hier bei talent.yoga. Wie kann ich dir heute helfen?`,
        `Hallo${userName ? ' ' + userName : ''}! Sch√∂n, dich zu sehen. Ich bin Mira ‚Äì wenn du Fragen hast, bin ich f√ºr dich da.`,
    ];
    
    const greeting = greetings[Math.floor(Math.random() * greetings.length)];
    addMiraMessage(greeting, false);
}

function addMiraMessage(content, isUser) {
    const container = document.getElementById('mira-messages');
    const msg = document.createElement('div');
    msg.className = `mira-message ${isUser ? 'user' : 'mira'}`;
    msg.textContent = content;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
}

function showMiraTyping() {
    const container = document.getElementById('mira-messages');
    const typing = document.createElement('div');
    typing.className = 'mira-typing';
    typing.id = 'mira-typing';
    typing.innerHTML = '<span></span><span></span><span></span>';
    container.appendChild(typing);
    container.scrollTop = container.scrollHeight;
}

function hideMiraTyping() {
    const typing = document.getElementById('mira-typing');
    if (typing) typing.remove();
}

async function sendMiraMessage() {
    const input = document.getElementById('mira-input');
    const text = input.value.trim();
    if (!text) return;
    
    // Add user message
    addMiraMessage(text, true);
    input.value = '';
    input.style.height = 'auto';
    
    // Detect Du/Sie from user message
    if (miraState.usesDu === null) {
        if (/\b(du|dein|dich|dir)\b/i.test(text)) {
            miraState.usesDu = true;
        } else if (/\b(Sie|Ihr|Ihnen|Ihre)\b/.test(text)) {
            miraState.usesDu = false;
        }
    }
    
    // Show typing indicator
    showMiraTyping();
    
    // Add to history before sending
    miraState.history.push({ role: 'user', content: text });
    
    try {
        const response = await fetch('/api/mira/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: text,
                uses_du: miraState.usesDu,
                history: miraState.history.slice(0, -1)  // Send history without current message
            })
        });
        
        hideMiraTyping();
        
        if (response.ok) {
            const data = await response.json();
            addMiraMessage(data.reply, false);
            // Add assistant response to history
            miraState.history.push({ role: 'assistant', content: data.reply });
            // Keep history reasonable (last 10 exchanges = 20 messages)
            if (miraState.history.length > 20) {
                miraState.history = miraState.history.slice(-20);
            }
        } else {
            addMiraMessage('Entschuldigung, da ist etwas schiefgelaufen. Versuch es bitte nochmal.', false);
            // Remove failed message from history
            miraState.history.pop();
        }
    } catch (error) {
        hideMiraTyping();
        addMiraMessage('Ich kann gerade nicht antworten. Bitte versuch es sp√§ter nochmal.', false);
        // Remove failed message from history
        miraState.history.pop();
        console.error('Mira chat error:', error);
    }
}

function handleMiraKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMiraMessage();
    }
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', () => {
    const miraInput = document.getElementById('mira-input');
    if (miraInput) {
        miraInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    }
});
</script>
{% endblock %}
