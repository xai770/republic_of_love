{% extends "admin/base.html" %}

{% block title %}OWL Triage - talent.yoga{% endblock %}
{% block max_width %}960px{% endblock %}

{% block extra_css %}
    .stats-bar {
        display: flex; gap: 20px; margin-bottom: 16px; padding: 12px 20px;
        background: var(--bg-card); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stats-bar .stat { text-align: center; }
    .stats-bar .stat-num { font-size: 1.4em; font-weight: bold; color: var(--accent); }
    .stats-bar .stat-lbl { font-size: 0.8em; color: var(--text-secondary); }
    .tab-bar {
        display: flex; gap: 4px; margin-bottom: 20px; padding: 4px;
        background: var(--bg-card); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tab-bar a {
        padding: 8px 18px; border-radius: 6px; text-decoration: none;
        font-weight: 500; font-size: 0.9em; color: var(--text-secondary);
        transition: all 0.15s;
    }
    .tab-bar a:hover { background: rgba(0,102,204,0.08); color: var(--text-primary); }
    .tab-bar a.active {
        background: var(--accent); color: white;
    }
    .tab-bar .tab-count {
        font-size: 0.8em; opacity: 0.7; margin-left: 4px;
    }
    .item {
        background: var(--bg-card); border-radius: 8px; padding: 20px; margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid var(--accent);
    }
    .item.item-rejected { border-left-color: var(--danger); }
    .item.item-resolved { border-left-color: var(--success); }
    .item-title {
        font-size: 1.3em; font-weight: 700; margin-bottom: 12px;
        color: var(--text-primary);
    }
    .item-meta { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px; }
    .candidates { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .candidate {
        display: flex; align-items: center; gap: 12px; padding: 10px 14px;
        border: 2px solid var(--border-color); border-radius: 6px;
        cursor: pointer; transition: all 0.15s;
    }
    .candidate:hover { border-color: var(--accent); background: rgba(0,102,204,0.05); }
    .candidate.selected { border-color: var(--success); background: rgba(40,167,69,0.08); }
    .score {
        font-family: monospace; font-size: 0.95em; font-weight: 600;
        padding: 3px 8px; border-radius: 4px; min-width: 52px; text-align: center;
    }
    .score-high { background: #d4edda; color: #155724; }
    .score-mid { background: #fff3cd; color: #856404; }
    .score-low { background: #f8d7da; color: #721c24; }
    [data-theme="dark"] .score-high { background: #1a3a2a; color: #7dcea0; }
    [data-theme="dark"] .score-mid { background: #3a3020; color: #f1c40f; }
    [data-theme="dark"] .score-low { background: #3a1a1a; color: #e74c3c; }
    .cand-name { flex: 1; font-weight: 500; }
    .cand-id { font-family: monospace; font-size: 0.85em; color: var(--text-secondary); }
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn-confirm { background: var(--success); color: white; }
    .btn-skip { background: var(--warning); color: #333; }
    .btn-reject { background: var(--danger); color: white; }
    .flash {
        padding: 12px 16px; border-radius: 6px; margin-bottom: 16px;
        font-weight: 500; text-align: center;
    }
    .flash-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .flash-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    [data-theme="dark"] .flash-success { background: #1a3a2a; color: #7dcea0; border-color: #2a5a3a; }
    [data-theme="dark"] .flash-error { background: #3a1a1a; color: #e74c3c; border-color: #5a2a2a; }
    .empty-state {
        text-align: center; padding: 60px 20px; color: var(--text-secondary);
        font-size: 1.1em;
    }
    .postings-count { font-size: 0.85em; color: var(--text-secondary); margin-left: 8px; }
    .keyboard-hint {
        font-size: 0.8em; color: var(--text-secondary); margin-top: 12px;
        text-align: center;
    }
    kbd {
        background: var(--bg-primary); border: 1px solid var(--border-color);
        padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em;
    }
    .resolution-note {
        font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px;
        font-style: italic;
    }
{% endblock %}

{% block body %}
    <div class="header">
        <h1>OWL Triage</h1>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">&#x1F313;</button>
            <a href="/admin/console">&larr; Admin</a>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-num">{{ "{:,}".format(stats.pending) }}</div>
            <div class="stat-lbl">Pending</div>
        </div>
        <div class="stat">
            <div class="stat-num">{{ "{:,}".format(stats.rejected) }}</div>
            <div class="stat-lbl">Rejected</div>
        </div>
        <div class="stat">
            <div class="stat-num">{{ "{:,}".format(affected_postings) }}</div>
            <div class="stat-lbl">Postings Affected</div>
        </div>
        <div class="stat">
            <div class="stat-num">{{ "{:,}".format(stats.resolved) }}</div>
            <div class="stat-lbl">Resolved</div>
        </div>
        <div class="stat">
            <div class="stat-num">{{ "{:,}".format(stats.skipped) }}</div>
            <div class="stat-lbl">Skipped</div>
        </div>
    </div>

    <div class="tab-bar">
        <a href="/admin/owl-triage?status=rejected"
           class="{{ 'active' if current_status == 'rejected' else '' }}">
            Rejected <span class="tab-count">({{ "{:,}".format(stats.rejected) }})</span>
        </a>
        <a href="/admin/owl-triage?status=pending"
           class="{{ 'active' if current_status == 'pending' else '' }}">
            Pending <span class="tab-count">({{ "{:,}".format(stats.pending) }})</span>
        </a>
        <a href="/admin/owl-triage?status=resolved"
           class="{{ 'active' if current_status == 'resolved' else '' }}">
            Resolved <span class="tab-count">({{ "{:,}".format(stats.resolved) }})</span>
        </a>
        <a href="/admin/owl-triage?status=skipped"
           class="{{ 'active' if current_status == 'skipped' else '' }}">
            Skipped <span class="tab-count">({{ "{:,}".format(stats.skipped) }})</span>
        </a>
    </div>

    {% if current_status == 'pending' %}
    <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
        <form method="POST" action="/admin/owl-triage/auto" style="display:inline">
            <input type="hidden" name="page" value="{{ page }}">
            <input type="hidden" name="batch_size" value="50">
            <button type="submit" class="btn btn-nav" onclick="this.disabled=true; this.textContent='LLM working...';">
                &#x1F916; Auto-triage next 50
            </button>
        </form>
        <span style="color:var(--text-secondary); font-size:0.85em;">
            LLM picks matches from candidates &mdash; resolved items get OWL synonyms
        </span>
    </div>
    {% endif %}

    {% if flash %}
    <div class="flash flash-{{ flash_type }}">{{ flash }}</div>
    {% endif %}

    {% if not items %}
    <div class="empty-state">
        {% if current_status == 'pending' %}All caught up! No pending items.
        {% elif current_status == 'rejected' %}No rejected items. The LLM matched everything it could.
        {% elif current_status == 'resolved' %}No resolved items yet.
        {% else %}No skipped items.{% endif %}
    </div>
    {% else %}
    {% for item in items %}
    <div class="item {{ 'item-rejected' if current_status == 'rejected' else 'item-resolved' if current_status == 'resolved' else '' }}" id="item-{{ item.pending_id }}">
        <div class="item-title">{{ item.raw_value or '<em>(empty title)</em>'|safe }}</div>
        {% if item.resolution_notes and current_status in ('resolved', 'rejected') %}
        <div class="resolution-note">{{ item.resolution_notes }}</div>
        {% endif %}
        <div class="candidates">
            {% for c in item.candidates %}
            {% set score = c.get('score', 0) %}
            {% set score_class = 'score-high' if score >= 0.70 else 'score-mid' if score >= 0.55 else 'score-low' %}
            <div class="candidate"
                 data-pid="{{ item.pending_id }}"
                 data-bid="{{ c.get('berufenet_id', 0) }}"
                 onclick="toggleCandidate(this, {{ item.pending_id }})">
                <span class="score {{ score_class }}">{{ "%.3f"|format(score) }}</span>
                <span class="cand-name">{{ c.get('name', '?') }}</span>
                <span class="cand-id">#{{ c.get('berufenet_id', '?') }}</span>
            </div>
            {% endfor %}
        </div>
        {% if current_status in ('pending', 'rejected') %}
        <div class="actions">
            <form method="POST" action="/admin/owl-triage/resolve" style="display:inline">
                <input type="hidden" name="pending_id" value="{{ item.pending_id }}">
                <input type="hidden" name="berufenet_ids" id="bids-{{ item.pending_id }}" value="">
                <input type="hidden" name="status_tab" value="{{ current_status }}">
                <input type="hidden" name="page" value="{{ page }}">
                <button type="submit" class="btn btn-confirm" id="confirm-{{ item.pending_id }}" disabled>
                    {% if current_status == 'rejected' %}Override &amp; Resolve{% else %}Confirm{% endif %}
                </button>
            </form>
            {% if current_status == 'pending' %}
            <form method="POST" action="/admin/owl-triage/skip" style="display:inline">
                <input type="hidden" name="pending_id" value="{{ item.pending_id }}">
                <input type="hidden" name="action" value="skip">
                <input type="hidden" name="status_tab" value="{{ current_status }}">
                <input type="hidden" name="page" value="{{ page }}">
                <button type="submit" class="btn btn-skip">Skip</button>
            </form>
            <form method="POST" action="/admin/owl-triage/skip" style="display:inline">
                <input type="hidden" name="pending_id" value="{{ item.pending_id }}">
                <input type="hidden" name="action" value="reject">
                <input type="hidden" name="status_tab" value="{{ current_status }}">
                <input type="hidden" name="page" value="{{ page }}">
                <button type="submit" class="btn btn-reject">No Match</button>
            </form>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    {# Pagination #}
    <div style="display:flex; justify-content:center; gap:8px; margin-top:20px;">
        {% if page > 1 %}
        <a href="/admin/owl-triage?status={{ current_status }}&page={{ page - 1 }}" class="btn btn-nav">&larr; Prev</a>
        {% endif %}
        <span style="padding:8px 12px; color:var(--text-secondary);">Page {{ page }} / {{ total_pages }}</span>
        {% if page < total_pages %}
        <a href="/admin/owl-triage?status={{ current_status }}&page={{ page + 1 }}" class="btn btn-nav">Next &rarr;</a>
        {% endif %}
    </div>

    <div class="keyboard-hint">
        Click one or more candidates then <kbd>Enter</kbd> to confirm &mdash;
        <kbd>S</kbd> to skip &mdash; <kbd>R</kbd> to reject &mdash;
        first selected = primary classification
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        let activePendingId = null;

        function toggleCandidate(el, pendingId) {
            el.classList.toggle('selected');
            const item = document.getElementById('item-' + pendingId);
            const selected = item.querySelectorAll('.candidate.selected');
            const ids = Array.from(selected).map(c => c.dataset.bid);
            document.getElementById('bids-' + pendingId).value = ids.join(',');
            document.getElementById('confirm-' + pendingId).disabled = ids.length === 0;
            activePendingId = pendingId;
        }

        document.addEventListener('keydown', function(e) {
            if (!activePendingId) return;
            const item = document.getElementById('item-' + activePendingId);
            if (!item) return;
            if (e.key === 'Enter') {
                e.preventDefault();
                const btn = document.getElementById('confirm-' + activePendingId);
                if (!btn.disabled) btn.closest('form').submit();
            } else if (e.key === 's' || e.key === 'S') {
                e.preventDefault();
                item.querySelector('button.btn-skip').closest('form').submit();
            } else if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                item.querySelector('button.btn-reject').closest('form').submit();
            }
        });
    </script>
{% endblock %}
