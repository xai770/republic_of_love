{% extends "base.html" %}

{% block title %}My Documents ‚Äî talent.yoga{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/pages/documents.css?v=20260216b">
{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}
    
    <!-- Left Sidebar -->
    {% set active_page = 'documents' %}
    {% include "partials/sidebar.html" %}
    
    <!-- Main Content -->
    <main class="main-content documents-page">
        <div class="documents-container">
            <!-- Header -->
            <div class="documents-header">
                <h1>üìÑ My Documents</h1>
                <p class="documents-subtitle">Reports, analyses, and content created for you</p>
            </div>
            
            <!-- Type Filters -->
            <div class="doc-type-filters">
                <button class="doc-filter active" data-type="all" onclick="setTypeFilter('all')">
                    üìÅ All
                    <span class="filter-count" id="count-all">0</span>
                </button>
                <button class="doc-filter" data-type="doug_report" onclick="setTypeFilter('doug_report')">
                    üìä Doug Reports
                    <span class="filter-count" id="count-doug_report">0</span>
                </button>
                <button class="doc-filter" data-type="newsletter" onclick="setTypeFilter('newsletter')">
                    üì∞ Newsletters
                    <span class="filter-count" id="count-newsletter">0</span>
                </button>
                <button class="doc-filter" data-type="match_analysis" onclick="setTypeFilter('match_analysis')">
                    üéØ Match Analysis
                    <span class="filter-count" id="count-match_analysis">0</span>
                </button>
                <button class="doc-filter" data-type="cover_letter" onclick="setTypeFilter('cover_letter')">
                    ‚úâÔ∏è Cover Letters
                    <span class="filter-count" id="count-cover_letter">0</span>
                </button>
            </div>
            
            <!-- Documents Grid -->
            <div class="documents-grid" id="documents-grid">
                <!-- Populated by JS -->
            </div>
            
            <!-- Empty State -->
            <div class="empty-state hidden" id="empty-state">
                <div class="empty-icon">üì≠</div>
                <h3>No documents yet</h3>
                <p>As you use talent.yoga, Doug and other actors will create reports and documents for you here.</p>
            </div>
            
            <!-- Loading State -->
            <div class="loading-state" id="loading-state">
                <div class="spinner"></div>
                <p>Loading documents...</p>
            </div>
        </div>
        
        <!-- Document Viewer Modal -->
        <div class="doc-viewer-modal hidden" id="doc-viewer">
            <div class="doc-viewer-content">
                <div class="doc-viewer-header">
                    <div class="doc-viewer-title">
                        <span class="doc-type-badge" id="viewer-type"></span>
                        <h2 id="viewer-title">Document Title</h2>
                    </div>
                    <button class="btn-close" onclick="closeViewer()">‚úï</button>
                </div>
                <div class="doc-viewer-meta">
                    <span id="viewer-author">By Doug</span>
                    <span id="viewer-date">Feb 8, 2026</span>
                </div>
                <div class="doc-viewer-body" id="viewer-body">
                    <!-- Markdown rendered content -->
                </div>
                <div class="doc-viewer-actions">
                    <button class="btn" onclick="downloadDocument()">üì• Download</button>
                    <button class="btn btn-secondary" onclick="closeViewer()">Close</button>
                </div>
            </div>
        </div>
    </main>
</div>


<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// State
let allDocuments = [];
let currentTypeFilter = 'all';
let searchQuery = '';
let currentDocument = null;

// Doc type config
const DOC_TYPE_CONFIG = {
    doug_report: { icon: 'üìä', label: 'Doug Report' },
    newsletter: { icon: 'üì∞', label: 'Newsletter' },
    match_analysis: { icon: 'üéØ', label: 'Match Analysis' },
    cover_letter: { icon: '‚úâÔ∏è', label: 'Cover Letter' },
    resume: { icon: 'üìÉ', label: 'Resume' },
    other: { icon: 'üìÑ', label: 'Document' }
};

// Load documents on page load
document.addEventListener('DOMContentLoaded', loadDocuments);

async function loadDocuments() {
    showLoading(true);
    
    try {
        const res = await fetch('/api/documents/');
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        allDocuments = data.documents || [];
        
        updateTypeCounts();
        renderDocuments();
        
    } catch (err) {
        console.error('Failed to load documents:', err);
        showEmpty(true);
    } finally {
        showLoading(false);
    }
}

function updateTypeCounts() {
    // Count by type
    const counts = { all: allDocuments.length };
    
    allDocuments.forEach(doc => {
        const type = doc.doc_type;
        counts[type] = (counts[type] || 0) + 1;
    });
    
    // Update UI
    document.getElementById('count-all').textContent = counts.all;
    
    Object.keys(DOC_TYPE_CONFIG).forEach(type => {
        const el = document.getElementById(`count-${type}`);
        if (el) el.textContent = counts[type] || 0;
    });
}

function setTypeFilter(type) {
    currentTypeFilter = type;
    
    // Update active state
    document.querySelectorAll('.doc-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
    
    renderDocuments();
}

function filterDocuments() {
    searchQuery = document.getElementById('doc-search').value.toLowerCase();
    renderDocuments();
}

function renderDocuments() {
    const grid = document.getElementById('documents-grid');
    
    // Filter documents
    let filtered = allDocuments;
    
    if (currentTypeFilter !== 'all') {
        filtered = filtered.filter(d => d.doc_type === currentTypeFilter);
    }
    
    if (searchQuery) {
        filtered = filtered.filter(d => 
            d.title.toLowerCase().includes(searchQuery) ||
            (d.preview && d.preview.toLowerCase().includes(searchQuery))
        );
    }
    
    // Show empty state if no docs
    if (filtered.length === 0) {
        grid.innerHTML = '';
        showEmpty(true);
        return;
    }
    
    showEmpty(false);
    
    // Render cards
    grid.innerHTML = filtered.map(doc => {
        const config = DOC_TYPE_CONFIG[doc.doc_type] || DOC_TYPE_CONFIG.other;
        const date = new Date(doc.created_at).toLocaleDateString('de-DE', {
            day: 'numeric', month: 'short', year: 'numeric'
        });
        const preview = doc.preview ? stripMarkdown(doc.preview) : 'No preview available';
        
        return `
            <div class="doc-card" onclick="openDocument(${doc.document_id})">
                <div class="doc-card-header">
                    <div class="doc-type-icon">${config.icon}</div>
                    <div class="doc-card-title">
                        <span class="doc-type-badge">${config.label}</span>
                        <h3>${escapeHtml(doc.title)}</h3>
                    </div>
                </div>
                <p class="doc-card-preview">${escapeHtml(preview)}</p>
                <div class="doc-card-footer">
                    <span class="doc-author">By ${escapeHtml(doc.created_by)}</span>
                    <span class="doc-date">${date}</span>
                </div>
            </div>
        `;
    }).join('');
}

async function openDocument(docId) {
    try {
        const res = await fetch(`/api/documents/${docId}`);
        if (!res.ok) throw new Error('Failed to load document');
        
        currentDocument = await res.json();
        const config = DOC_TYPE_CONFIG[currentDocument.doc_type] || DOC_TYPE_CONFIG.other;
        
        document.getElementById('viewer-type').textContent = config.label;
        document.getElementById('viewer-title').textContent = currentDocument.title;
        document.getElementById('viewer-author').textContent = `By ${currentDocument.created_by}`;
        document.getElementById('viewer-date').textContent = new Date(currentDocument.created_at)
            .toLocaleDateString('de-DE', { day: 'numeric', month: 'long', year: 'numeric' });
        document.getElementById('viewer-body').innerHTML = marked.parse(currentDocument.content || '');
        
        document.getElementById('doc-viewer').classList.remove('hidden');
        
    } catch (err) {
        console.error('Failed to open document:', err);
        alert('Could not load document');
    }
}

function closeViewer() {
    document.getElementById('doc-viewer').classList.add('hidden');
    currentDocument = null;
}

function downloadDocument() {
    if (!currentDocument) return;
    
    // Create blob and download
    const blob = new Blob([currentDocument.content || ''], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentDocument.title.replace(/[^a-z0-9]/gi, '_')}.md`;
    a.click();
    URL.revokeObjectURL(url);
}

function showLoading(show) {
    document.getElementById('loading-state').classList.toggle('hidden', !show);
    document.getElementById('documents-grid').classList.toggle('hidden', show);
}

function showEmpty(show) {
    document.getElementById('empty-state').classList.toggle('hidden', !show);
}

function stripMarkdown(text) {
    return text
        .replace(/#{1,6}\s/g, '')
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/\*([^*]+)\*/g, '$1')
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/`([^`]+)`/g, '$1');
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Close modal on escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeViewer();
});

// Close modal on backdrop click
document.getElementById('doc-viewer').addEventListener('click', (e) => {
    if (e.target.id === 'doc-viewer') closeViewer();
});
</script>
{% endblock %}
