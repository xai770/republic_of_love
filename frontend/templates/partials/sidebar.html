{# Sidebar Partial - include with: {% include "partials/sidebar.html" %} #}
{# Set active_page before including: dashboard, profile, bi, matches, messages #}
{# user.is_admin controls visibility of admin-only nav items #}

<aside class="sidebar" id="sidebar">
    <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
    
    <nav class="sidebar-nav">
        {# 1. Home #}
        <a href="/dashboard" class="nav-item {{ 'active' if active_page == 'dashboard' else '' }}" data-tooltip="{{ t('nav.start') }}">
            <span class="nav-icon-wrap" style="background: #fff3e0;">
                <img src="/static/images/icons/icon-home.png" alt="" class="nav-icon-img">
            </span>
            <span class="nav-label">{{ t('nav.start') }}</span>
        </a>
        
        {# 2. My Resume #}
        <a href="/profile" class="nav-item {{ 'active' if active_page == 'profile' else '' }}" data-tooltip="{{ t('nav.resume') }}">
            <span class="nav-icon-wrap" style="background: #fff8e1;">
                <img src="/static/images/icons/icon-profile.png" alt="" class="nav-icon-img">
            </span>
            <span class="nav-label">{{ t('nav.resume') }}</span>
        </a>
        
        {# 3. Mira Search #}
        <a href="/search" class="nav-item {{ 'active' if active_page == 'search' else '' }}" data-tooltip="{{ t('nav.search') }}">
            <span class="nav-icon-wrap" style="background: #e3f2fd;">
                <span class="nav-icon">ğŸ”</span>
            </span>
            <span class="nav-label">{{ t('nav.search') }}</span>
        </a>

        {# 4. My Active Postings (Jobs/Matches) #}
        <a href="/matches" class="nav-item {{ 'active' if active_page == 'matches' else '' }}" data-tooltip="{{ t('nav.jobs') }}">
            <span class="nav-icon-wrap" style="background: #e8f5e9;">
                <img src="/static/images/icons/icon-jobs.png" alt="" class="nav-icon-img">
            </span>
            <span class="nav-label">{{ t('nav.jobs') }}</span>
        </a>
        
        {# 5. Messages (with notification badge) #}
        <a href="/messages" class="nav-item {{ 'active' if active_page == 'messages' else '' }}" data-tooltip="{{ t('nav.messages') }}" id="nav-messages">
            <span class="nav-icon-wrap" style="background: #fff3e0; position: relative;">
                <img src="/static/images/icons/icon-inbox.png" alt="" class="nav-icon-img">
                <span class="nav-badge hidden" id="notif-badge"></span>
            </span>
            <span class="nav-label">{{ t('nav.messages') }}</span>
        </a>
        
        {# 6. Documents #}
        <a href="/documents" class="nav-item {{ 'active' if active_page == 'documents' else '' }}" data-tooltip="Documents">
            <span class="nav-icon-wrap" style="background: #e8eaf6;">
                <span class="nav-icon">ğŸ“„</span>
            </span>
            <span class="nav-label">Documents</span>
        </a>
        
        {# 7. Account #}
        <a href="/account" class="nav-item {{ 'active' if active_page == 'account' else '' }}" data-tooltip="{{ t('nav.account') }}">
            <span class="nav-icon-wrap" style="background: #ede7f6;">
                <span class="nav-icon">ğŸ‘¤</span>
            </span>
            <span class="nav-label">{{ t('nav.account') }}</span>
        </a>

        {% if user and user.is_admin %}
        {# â”€â”€ Admin-only section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
        <div class="nav-separator" style="border-top: 1px solid rgba(0,0,0,0.08); margin: 8px 12px;"></div>

        {# Finances #}
        <a href="/finances" class="nav-item {{ 'active' if active_page == 'finances' else '' }}" data-tooltip="Finances">
            <span class="nav-icon-wrap" style="background: #fff8e1;">
                <span class="nav-icon">ğŸ’°</span>
            </span>
            <span class="nav-label">Finances</span>
        </a>

        {# Arcade â€” Frustrationsabbau #}
        <a href="/arcade" class="nav-item {{ 'active' if active_page == 'arcade' else '' }}" data-tooltip="Frustrationsabbau">
            <span class="nav-icon-wrap" style="background: #fce4ec;">
                <span class="nav-icon">ğŸ‘¾</span>
            </span>
            <span class="nav-label">Frustabbau</span>
        </a>
        {% endif %}
    </nav>
    
    <div class="sidebar-footer">
        {# Feedback / Report Issue #}
        <a href="javascript:void(0)" onclick="openFeedbackWidget()" class="nav-item" data-tooltip="Feedback (Ctrl+Shift+F)">
            <span class="nav-icon-wrap" style="background: #fce4ec;">
                <span class="nav-icon">ğŸ’¡</span>
            </span>
            <span class="nav-label">{{ t('feedback.title') if t('feedback.title') != 'feedback.title' else 'Feedback' }}</span>
        </a>

        {# Tour - replay onboarding (page-aware) #}
        <a href="javascript:void(0)" onclick="if(window.startSearchTour && location.pathname.includes('/search')){resetSearchTour();startSearchTour();}else{resetMiraTour();startMiraTour();}" class="nav-item" data-tooltip="Tour starten">
            <span class="nav-icon-wrap" style="background: #e0f7fa;">
                <span class="nav-icon">ğŸ“</span>
            </span>
            <span class="nav-label">Tour</span>
        </a>

        {% if user and user.is_admin %}
        {# Reset onboarding â€” admin/tester only #}
        <a href="javascript:void(0)" onclick="confirmResetOnboarding()" class="nav-item" data-tooltip="Reset onboarding (clear all data)" id="nav-reset">
            <span class="nav-icon-wrap" style="background: #fff3e0;">
                <span class="nav-icon">ğŸ”„</span>
            </span>
            <span class="nav-label">Reset</span>
        </a>
        {% endif %}
        
        <a href="/auth/logout" class="nav-item logout" data-tooltip="{{ t('common.logout') }}">
            <span class="nav-icon-wrap" style="background: #ffebee;">
                <span class="nav-icon">ğŸšª</span>
            </span>
            <span class="nav-label">{{ t('common.logout') }}</span>
        </a>
    </div>
</aside>

<!-- Overlay for mobile -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<script>
(function() {
    var sb = document.getElementById('sidebar');
    if (!sb) return;
    // Restore pinned-open state from previous navigation
    if (sessionStorage.getItem('sidebarOpen') === '1') {
        sb.classList.add('sidebar-pinned');
    }
    // Drop pinned state when cursor leaves sidebar
    sb.addEventListener('mouseleave', function() {
        sb.classList.remove('sidebar-pinned');
        sessionStorage.removeItem('sidebarOpen');
    });
    // Save state when clicking a real nav link (not javascript:void)
    sb.querySelectorAll('.nav-item[href]').forEach(function(link) {
        if (link.getAttribute('href').indexOf('javascript') === 0) return;
        link.addEventListener('click', function() {
            sessionStorage.setItem('sidebarOpen', '1');
        });
    });
}());
</script>

{% if user and user.is_admin %}
<!-- Reset onboarding confirmation + AJAX -->
<script>
function confirmResetOnboarding() {
    const msg = 'âš ï¸ This will DELETE all your data:\n\n' +
        'â€¢ Adele interview session\n' +
        'â€¢ Profile & work history\n' +
        'â€¢ All matches\n' +
        'â€¢ All messages (Mira + Adele)\n\n' +
        'You will restart onboarding from scratch.\n\n' +
        'Type RESET to confirm:';
    const answer = prompt(msg);
    if (answer && answer.trim().toUpperCase() === 'RESET') {
        fetch('/api/account/reset-onboarding', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                // Clear tour flags so onboarding tour replays
                localStorage.removeItem('mira_tour_completed');
                localStorage.removeItem('mira_tour_completed_at');
                localStorage.removeItem('mira_search_tour_completed');
                localStorage.removeItem('mira_search_tour_completed_at');
                alert('âœ… ' + data.message + '\n\nRedirecting to onboarding...');
                window.location.href = '/onboarding';
            } else {
                alert('âŒ Reset failed: ' + (data.detail || 'Unknown error'));
            }
        })
        .catch(err => alert('âŒ Reset failed: ' + err.message));
    }
}
</script>
{% endif %}
