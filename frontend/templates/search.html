{% extends "base.html" %}

{% block title %}{{ t('nav.search') }} ‚Äî talent.yoga{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}

    {% set active_page = 'search' %}
    {% include "partials/sidebar.html" %}

    <main class="main-content search-page">

        <!-- Search header -->
        <div class="search-header">
            <h1 class="search-title">üîç {{ t('search.title') }}</h1>
            <div class="search-active-filters" id="active-filters">
                <!-- Active filter pills rendered by JS -->
            </div>
        </div>

        <!-- Three-panel layout -->
        <div class="search-panels">
            <!-- LEFT: Domain (Berufsfeld) -->
            <div class="search-panel panel-domain">
                <h3 class="panel-title">{{ t('search.domain_title') }}</h3>
                <div class="domain-bars" id="domain-bars">
                    <!-- Rendered by JS -->
                    <div class="panel-loading">{{ t('search.loading') }}</div>
                </div>
            </div>

            <!-- CENTER: Map -->
            <div class="search-panel panel-map">
                <div class="map-controls">
                    <input type="text" id="city-search" placeholder="{{ t('search.city_placeholder') }}" autocomplete="off">
                    <select id="radius-select">
                        <option value="">{{ t('search.no_radius') }}</option>
                        <option value="10">10 km</option>
                        <option value="25">25 km</option>
                        <option value="50" selected>50 km</option>
                        <option value="100">100 km</option>
                    </select>
                </div>
                <div id="search-map"></div>
                <div class="map-freshness" id="freshness-badge" style="display:none;">
                    <span id="fresh-count">0</span> {{ t('search.fresh_this_week') }}
                </div>
            </div>

            <!-- RIGHT: Qualification Level -->
            <div class="search-panel panel-ql">
                <h3 class="panel-title">{{ t('search.ql_title') }}</h3>
                <div class="ql-buttons" id="ql-buttons">
                    <!-- Rendered by JS -->
                    <div class="panel-loading">{{ t('search.loading') }}</div>
                </div>
                <div class="search-total" id="search-total">
                    <span class="total-number">‚Äî</span>
                    <span class="total-label">{{ t('search.positions_found') }}</span>
                </div>
            </div>
        </div>

        <!-- Save button -->
        <div class="search-actions">
            <button class="btn-save-search" id="btn-save-search">
                üíæ {{ t('search.save_search') }}
            </button>
            <span class="save-feedback" id="save-feedback"></span>
        </div>

        <!-- Preview cards -->
        <div class="search-preview" id="search-preview">
            <!-- 3-5 best match cards rendered by JS after filters settle -->
        </div>

    </main>

    <!-- Mira Chat Widget (same as dashboard) -->
    <div id="mira-widget" class="mira-widget">
        <button class="mira-fab" id="mira-fab-btn" title="{{ t('search.mira_chat_title') }}">
            <span class="mira-fab-icon">üí¨</span>
            <span class="mira-fab-close">‚úï</span>
        </button>
        
        <div class="mira-chat-window">
            <div class="mira-header">
                <div class="mira-avatar">üßò</div>
                <div class="mira-title">
                    <span class="mira-name">Mira</span>
                    <span class="mira-status">{{ t('search.mira_status') }}</span>
                </div>
                <button class="mira-minimize" id="mira-minimize-btn">‚àí</button>
            </div>
            
            <div class="mira-messages" id="mira-messages">
            </div>
            
            <div class="mira-input-area">
                <textarea id="mira-input" placeholder="{{ t('search.mira_placeholder') }}" rows="1"></textarea>
                <button class="mira-send" id="mira-send-btn">
                    <span>‚û§</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Search tour i18n + script -->
<script>
window.SEARCH_TOUR_I18N = {
    welcome_title: '{{ t("search.tour_welcome_title") }}',
    welcome_desc: '{{ t("search.tour_welcome_desc") }}',
    domain_title: '{{ t("search.tour_domain_title") }}',
    domain_desc: '{{ t("search.tour_domain_desc") }}',
    map_title: '{{ t("search.tour_map_title") }}',
    map_desc: '{{ t("search.tour_map_desc") }}',
    ql_title: '{{ t("search.tour_ql_title") }}',
    ql_desc: '{{ t("search.tour_ql_desc") }}',
    pills_title: '{{ t("search.tour_pills_title") }}',
    pills_desc: '{{ t("search.tour_pills_desc") }}',
    save_title: '{{ t("search.tour_save_title") }}',
    save_desc: '{{ t("search.tour_save_desc") }}',
    mira_title: '{{ t("search.tour_mira_title") }}',
    mira_desc: '{{ t("search.tour_mira_desc") }}',
    done_title: '{{ t("search.tour_done_title") }}',
    done_desc: '{{ t("search.tour_done_desc") }}',
    next: '{{ t("search.tour_next") }}',
    prev: '{{ t("search.tour_prev") }}',
    done: '{{ t("search.tour_done") }}',
    progress: '{{ t("search.tour_progress") }}',
};
</script>
<script src="/static/js/search-tour.js?v=20260212"></script>

<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
(function() {
    // ============================================================
    // I18N ‚Äî translations for JS-rendered content
    // ============================================================
    const LANG = '{{ lang }}';
    const I18N = {
        ql: { 1: '{{ t("search.ql_helfer") }}', 2: '{{ t("search.ql_fachkraft") }}', 3: '{{ t("search.ql_spezialist") }}', 4: '{{ t("search.ql_experte") }}' },
        domains: {
            'Gesundheit & Medizin': '{{ t("search.domain_gesundheit") }}',
            'IT & Technologie': '{{ t("search.domain_it") }}',
            'Fertigung & Technik': '{{ t("search.domain_fertigung") }}',
            'Maschinen & Elektro': '{{ t("search.domain_maschinen") }}',
            'Bau & Handwerk': '{{ t("search.domain_bau") }}',
            'Finanzen & Banken': '{{ t("search.domain_finanzen") }}',
            'Handel & Vertrieb': '{{ t("search.domain_handel") }}',
            'Transport & Logistik': '{{ t("search.domain_transport") }}',
            'Bildung & Soziales': '{{ t("search.domain_bildung") }}',
            'Wissenschaft & Forschung': '{{ t("search.domain_wissenschaft") }}',
            'Gastgewerbe & Tourismus': '{{ t("search.domain_tourismus") }}',
            'Gastgewerbe & Lebensmittel': '{{ t("search.domain_lebensmittel") }}',
            'Verwaltung & Recht': '{{ t("search.domain_verwaltung") }}',
            'Wirtschaft & Management': '{{ t("search.domain_wirtschaft") }}',
            'Land- & Forstwirtschaft': '{{ t("search.domain_landwirtschaft") }}',
            'Sicherheit & Verteidigung': '{{ t("search.domain_sicherheit") }}',
            'Kultur & Medien': '{{ t("search.domain_kultur") }}',
        },
        save_success: '{{ t("search.save_success") }}',
        save_error: '{{ t("search.save_error") }}',
        network_error: '{{ t("search.network_error") }}',
        mira_greeting: '{{ t("search.mira_greeting") }}',
        mira_error: '{{ t("search.mira_error") }}',
        mira_offline: '{{ t("search.mira_offline") }}',
    };
    // Translate a domain name from API (German) to current language
    function tDomain(name) { return I18N.domains[name] || name; }
    // Translate a QL level to current language
    function tQL(level) { return I18N.ql[level] || ('Level ' + level); }

    // ============================================================
    // STATE
    // ============================================================
    const state = {
        domains: [],     // selected KLDB 2-digit codes
        ql: [],          // selected QL levels [1-4]
        lat: null,
        lon: null,
        radius_km: null,
        // data from last response
        data: null,
    };

    // ============================================================
    // MAP SETUP
    // ============================================================
    const map = L.map('search-map', {
        center: [51.1657, 10.4515],  // Germany center
        zoom: 6,
        zoomControl: true,
        scrollWheelZoom: true,
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 18,
    }).addTo(map);

    let heatLayer = null;
    let radiusCircle = null;
    let searchMarker = null;

    // Click on map = set center + radius
    map.on('click', function(e) {
        state.lat = Math.round(e.latlng.lat * 100) / 100;
        state.lon = Math.round(e.latlng.lng * 100) / 100;
        state.radius_km = parseInt(document.getElementById('radius-select').value) || null;
        updateRadiusCircle();
        doSearch();
    });

    function updateRadiusCircle() {
        if (radiusCircle) map.removeLayer(radiusCircle);
        if (searchMarker) map.removeLayer(searchMarker);

        if (state.lat && state.lon) {
            searchMarker = L.circleMarker([state.lat, state.lon], {
                radius: 6, color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.8, weight: 2
            }).addTo(map);

            if (state.radius_km) {
                radiusCircle = L.circle([state.lat, state.lon], {
                    radius: state.radius_km * 1000,
                    color: '#3498db', fillColor: '#3498db', fillOpacity: 0.08,
                    weight: 2, dashArray: '5,5'
                }).addTo(map);
            }
        }
    }

    // Radius dropdown change
    document.getElementById('radius-select').addEventListener('change', function() {
        state.radius_km = parseInt(this.value) || null;
        updateRadiusCircle();
        if (state.lat && state.lon) doSearch();
    });

    // ============================================================
    // CITY SEARCH (simple geocoding via Nominatim)
    // ============================================================
    let cityTimeout = null;
    const cityInput = document.getElementById('city-search');
    const cityDropdown = document.createElement('div');
    cityDropdown.className = 'city-dropdown';
    cityInput.parentElement.appendChild(cityDropdown);

    cityInput.addEventListener('input', function() {
        clearTimeout(cityTimeout);
        const q = this.value.trim();
        if (q.length < 2) { cityDropdown.innerHTML = ''; return; }
        cityTimeout = setTimeout(() => geocodeCity(q), 400);
    });

    async function geocodeCity(q) {
        try {
            const res = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&countrycodes=de&limit=5&q=${encodeURIComponent(q)}`,
                { headers: { 'Accept-Language': 'de' } }
            );
            const results = await res.json();
            cityDropdown.innerHTML = results.map(r =>
                `<div class="city-option" data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name.split(',').slice(0,2).join(',')}</div>`
            ).join('');
        } catch(e) {
            cityDropdown.innerHTML = '';
        }
    }

    cityDropdown.addEventListener('click', function(e) {
        const opt = e.target.closest('.city-option');
        if (!opt) return;
        state.lat = parseFloat(opt.dataset.lat);
        state.lon = parseFloat(opt.dataset.lon);
        state.radius_km = parseInt(document.getElementById('radius-select').value) || 50;
        cityInput.value = opt.textContent;
        cityDropdown.innerHTML = '';
        map.setView([state.lat, state.lon], 10);
        updateRadiusCircle();
        doSearch();
    });

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!cityInput.contains(e.target) && !cityDropdown.contains(e.target)) {
            cityDropdown.innerHTML = '';
        }
    });

    // ============================================================
    // DOMAIN BARS
    // ============================================================
    function renderDomains(domains) {
        const container = document.getElementById('domain-bars');
        if (!domains || domains.length === 0) {
            container.innerHTML = '<div class="panel-empty">‚Äî</div>';
            return;
        }
        const maxCount = Math.max(...domains.map(d => d.count));
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';

        container.innerHTML = domains.map(d => {
            const pct = maxCount > 0 ? Math.round(d.count / maxCount * 100) : 0;
            const selected = state.domains.length === 0 || d.codes.some(c => state.domains.includes(c));
            const dimmed = state.domains.length > 0 && !selected;
            return `
                <div class="domain-bar ${dimmed ? 'dimmed' : ''} ${selected && state.domains.length > 0 ? 'selected' : ''}"
                     data-codes="${d.codes.join(',')}" data-name="${d.name}">
                    <div class="domain-bar-label">${tDomain(d.name)}</div>
                    <div class="domain-bar-track">
                        <div class="domain-bar-fill" style="width:${pct}%; background:${d.color};"></div>
                    </div>
                    <div class="domain-bar-count">${d.count.toLocaleString(locale)}</div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('domain-bars').addEventListener('click', function(e) {
        const bar = e.target.closest('.domain-bar');
        if (!bar) return;
        const codes = bar.dataset.codes.split(',');

        // Toggle: if all codes are already selected, remove them. Otherwise add them.
        const allSelected = codes.every(c => state.domains.includes(c));
        if (allSelected) {
            state.domains = state.domains.filter(c => !codes.includes(c));
        } else {
            codes.forEach(c => { if (!state.domains.includes(c)) state.domains.push(c); });
        }
        doSearch();
    });

    // ============================================================
    // QL BAR CHART
    // ============================================================
    function renderQL(levels) {
        const container = document.getElementById('ql-buttons');
        const qlColors = { 1: '#95a5a6', 2: '#3498db', 3: '#e67e22', 4: '#e74c3c' };
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';
        const total = levels.reduce((s, l) => s + l.count, 0) || 1;

        container.innerHTML = levels.map(l => {
            const selected = state.ql.length === 0 || state.ql.includes(l.level);
            const dimmed = state.ql.length > 0 && !selected;
            const pct = ((l.count / total) * 100).toFixed(1);
            const color = qlColors[l.level] || '#999';
            return `
                <div class="ql-btn ${dimmed ? 'dimmed' : ''} ${selected && state.ql.length > 0 ? 'selected' : ''}"
                     data-level="${l.level}">
                    <div class="ql-bar-header">
                        <span class="ql-dot" style="background:${color};"></span>
                        <span class="ql-label">${tQL(l.level)}</span>
                        <span class="ql-count">${l.count.toLocaleString(locale)}</span>
                        <span class="ql-pct">${pct}%</span>
                    </div>
                    <div class="ql-bar-track">
                        <div class="ql-bar-fill" style="width:${pct}%; background:${color};"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('ql-buttons').addEventListener('click', function(e) {
        const btn = e.target.closest('.ql-btn');
        if (!btn) return;
        const level = parseInt(btn.dataset.level);
        const idx = state.ql.indexOf(level);
        if (idx >= 0) {
            state.ql.splice(idx, 1);
        } else {
            state.ql.push(level);
        }
        doSearch();
    });

    // ============================================================
    // HEATMAP
    // ============================================================
    function renderHeatmap(points) {
        if (heatLayer) map.removeLayer(heatLayer);
        if (!points || points.length === 0) return;
        heatLayer = L.heatLayer(points, {
            radius: 18,
            blur: 22,
            maxZoom: 12,
            max: Math.max(...points.map(p => p[2])),
            gradient: { 0.2: '#2196F3', 0.4: '#4CAF50', 0.6: '#FFEB3B', 0.8: '#FF9800', 1.0: '#F44336' }
        }).addTo(map);
    }

    // ============================================================
    // ACTIVE FILTER PILLS
    // ============================================================
    function renderFilterPills() {
        const container = document.getElementById('active-filters');
        let pills = [];

        // Domain pills
        if (state.domains.length > 0) {
            // Group by domain name
            const names = new Set();
            for (const code of state.domains) {
                for (const [name, codes] of Object.entries(window._domainMap || {})) {
                    if (codes.includes(code)) names.add(name);
                }
            }
            names.forEach(name => {
                pills.push(`<span class="filter-pill domain-pill" data-type="domain" data-name="${name}">
                    ${tDomain(name)} <button class="pill-remove" data-type="domain" data-name="${name}">√ó</button>
                </span>`);
            });
        }

        // QL pills
        state.ql.forEach(level => {
            const label = tQL(level);
            pills.push(`<span class="filter-pill ql-pill" data-type="ql" data-level="${level}">
                ${label} <button class="pill-remove" data-type="ql" data-level="${level}">√ó</button>
            </span>`);
        });

        // Geo pill
        if (state.lat && state.lon) {
            const geoLabel = cityInput.value || `${state.lat}, ${state.lon}`;
            const rLabel = state.radius_km ? ` (${state.radius_km} km)` : '';
            pills.push(`<span class="filter-pill geo-pill" data-type="geo">
                üìç ${geoLabel}${rLabel} <button class="pill-remove" data-type="geo">√ó</button>
            </span>`);
        }

        container.innerHTML = pills.join('');
    }

    document.getElementById('active-filters').addEventListener('click', function(e) {
        const btn = e.target.closest('.pill-remove');
        if (!btn) return;
        const type = btn.dataset.type;
        if (type === 'domain') {
            const name = btn.dataset.name;
            const codes = (window._domainMap || {})[name] || [];
            state.domains = state.domains.filter(c => !codes.includes(c));
        } else if (type === 'ql') {
            const level = parseInt(btn.dataset.level);
            state.ql = state.ql.filter(l => l !== level);
        } else if (type === 'geo') {
            state.lat = null;
            state.lon = null;
            state.radius_km = null;
            cityInput.value = '';
            if (radiusCircle) map.removeLayer(radiusCircle);
            if (searchMarker) map.removeLayer(searchMarker);
            radiusCircle = null;
            searchMarker = null;
        }
        doSearch();
    });

    // ============================================================
    // TOTAL + FRESHNESS
    // ============================================================
    function renderTotal(total) {
        const el = document.getElementById('search-total');
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';
        el.querySelector('.total-number').textContent = total.toLocaleString(locale);
    }

    function renderFreshness(count) {
        const badge = document.getElementById('freshness-badge');
        if (count > 0) {
            badge.style.display = '';
            const locale = LANG === 'de' ? 'de-DE' : 'en-US';
            document.getElementById('fresh-count').textContent = count.toLocaleString(locale);
        } else {
            badge.style.display = 'none';
        }
    }

    // ============================================================
    // MAIN SEARCH
    // ============================================================
    let searchPending = false;
    let searchQueued = false;

    async function doSearch() {
        if (searchPending) { searchQueued = true; return; }
        searchPending = true;

        const body = {};
        if (state.domains.length > 0) body.domains = state.domains;
        if (state.ql.length > 0) body.ql = state.ql;
        if (state.lat != null) body.lat = state.lat;
        if (state.lon != null) body.lon = state.lon;
        if (state.radius_km) body.radius_km = state.radius_km;

        try {
            const res = await fetch('/api/search/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            state.data = data;

            // Build domain map for pill rendering
            window._domainMap = {};
            data.by_domain.forEach(d => { window._domainMap[d.name] = d.codes; });

            renderDomains(data.by_domain);
            renderQL(data.by_ql);
            renderHeatmap(data.heatmap);
            renderTotal(data.total);
            renderFreshness(data.fresh_count);
            renderFilterPills();

            // Track filter state for Mira context
            if (typeof trackEvent === 'function') {
                trackEvent('search_filter', {
                    domains: state.domains,
                    ql: state.ql,
                    city: state.city || null,
                    radius: state.radius_km,
                    results: data.total
                });
            }
        } catch(e) {
            console.error('Search failed:', e);
        } finally {
            searchPending = false;
            if (searchQueued) {
                searchQueued = false;
                doSearch();
            }
        }
    }

    // ============================================================
    // SAVE SEARCH
    // ============================================================
    document.getElementById('btn-save-search').addEventListener('click', async function() {
        const body = {};
        if (state.domains.length > 0) body.domains = state.domains;
        if (state.ql.length > 0) body.ql = state.ql;
        if (state.lat != null) body.lat = state.lat;
        if (state.lon != null) body.lon = state.lon;
        if (state.radius_km) body.radius_km = state.radius_km;

        const feedback = document.getElementById('save-feedback');
        try {
            const res = await fetch('/api/search/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!res.ok) {
                const err = await res.json();
                feedback.textContent = err.error || I18N.save_error;
                feedback.className = 'save-feedback error';
            } else {
                feedback.textContent = I18N.save_success;
                feedback.className = 'save-feedback success';
            }
        } catch(e) {
            feedback.textContent = I18N.network_error;
            feedback.className = 'save-feedback error';
        }
        setTimeout(() => { feedback.textContent = ''; }, 3000);
    });

    // ============================================================
    // LOAD SAVED SEARCH + AUTO-SEED FROM PROFILE
    // ============================================================
    async function loadSavedSearch() {
        try {
            const res = await fetch('/api/search/saved');
            if (!res.ok) return;
            const data = await res.json();
            if (data.search_params) {
                const sp = data.search_params;
                if (sp.domains) state.domains = sp.domains;
                if (sp.ql) state.ql = sp.ql;
                if (sp.lat != null) { state.lat = sp.lat; state.lon = sp.lon; }
                if (sp.radius_km) {
                    state.radius_km = sp.radius_km;
                    document.getElementById('radius-select').value = sp.radius_km;
                }
                if (state.lat && state.lon) {
                    map.setView([state.lat, state.lon], 10);
                    updateRadiusCircle();
                }
            }
        } catch(e) {
            console.warn('Could not load saved search:', e);
        }
    }

    // ============================================================
    // MIRA CHAT WIDGET ‚Äî Smart FAB pattern
    // ============================================================
    const miraState = {
        isOpen: false,
        hasGreeted: false,
        usesDu: null,
        history: [],
        idleTimer: null,
    };

    function openMiraChat() {
        const widget = document.getElementById('mira-widget');
        miraState.isOpen = true;
        widget.classList.add('open');
        widget.classList.remove('mira-idle');
        resetMiraIdleTimer();
        if (!miraState.hasGreeted) {
            loadMiraGreeting();
            miraState.hasGreeted = true;
        }
        setTimeout(() => document.getElementById('mira-input').focus(), 300);
    }

    function closeMiraChat() {
        const widget = document.getElementById('mira-widget');
        miraState.isOpen = false;
        widget.classList.remove('open', 'mira-idle');
        clearTimeout(miraState.idleTimer);
    }

    function toggleMiraChat() {
        if (miraState.isOpen) closeMiraChat(); else openMiraChat();
    }

    // Idle transparency ‚Äî after 5s without hover/interaction, dim the chat
    function resetMiraIdleTimer() {
        const widget = document.getElementById('mira-widget');
        widget.classList.remove('mira-idle');
        clearTimeout(miraState.idleTimer);
        if (!miraState.isOpen) return;
        miraState.idleTimer = setTimeout(() => {
            if (miraState.isOpen) widget.classList.add('mira-idle');
        }, 5000);
    }

    // Click outside = close
    document.addEventListener('mousedown', function(e) {
        const widget = document.getElementById('mira-widget');
        if (miraState.isOpen && !widget.contains(e.target)) {
            closeMiraChat();
        }
    });

    // Reset idle on any interaction within the widget
    document.addEventListener('DOMContentLoaded', () => {
        const widget = document.getElementById('mira-widget');
        ['mouseenter', 'mousemove', 'click', 'keydown'].forEach(evt => {
            widget.addEventListener(evt, resetMiraIdleTimer);
        });
    });

    function loadMiraGreeting() {
        addMiraMessage(I18N.mira_greeting, false);
    }

    function addMiraMessage(content, isUser) {
        const container = document.getElementById('mira-messages');
        const msg = document.createElement('div');
        msg.className = `mira-message ${isUser ? 'user' : 'mira'}`;
        msg.textContent = content;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
    }

    function showMiraTyping() {
        const container = document.getElementById('mira-messages');
        const typing = document.createElement('div');
        typing.className = 'mira-typing'; typing.id = 'mira-typing';
        typing.innerHTML = '<span></span><span></span><span></span>';
        container.appendChild(typing);
        container.scrollTop = container.scrollHeight;
    }

    function hideMiraTyping() {
        const el = document.getElementById('mira-typing'); if (el) el.remove();
    }

    async function sendMiraMessage() {
        const input = document.getElementById('mira-input');
        const text = input.value.trim();
        if (!text) return;
        addMiraMessage(text, true);
        input.value = ''; input.style.height = 'auto';

        if (miraState.usesDu === null) {
            if (/\b(du|dein|dich|dir)\b/i.test(text)) miraState.usesDu = true;
            else if (/\b(Sie|Ihr|Ihnen|Ihre)\b/.test(text)) miraState.usesDu = false;
        }

        showMiraTyping();
        miraState.history.push({ role: 'user', content: text });

        try {
            const response = await fetch('/api/mira/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, uses_du: miraState.usesDu, history: miraState.history.slice(0, -1) })
            });
            hideMiraTyping();
            if (response.ok) {
                const data = await response.json();
                addMiraMessage(data.reply, false);
                miraState.history.push({ role: 'assistant', content: data.reply });
                if (miraState.history.length > 20) miraState.history = miraState.history.slice(-20);

                // Apply search filter actions if present
                if (data.actions && window.applyMiraFilters) {
                    window.applyMiraFilters(data.actions);
                }
            } else {
                addMiraMessage(I18N.mira_error, false);
                miraState.history.pop();
            }
        } catch (error) {
            hideMiraTyping();
            addMiraMessage(I18N.mira_offline, false);
            miraState.history.pop();
        }
    }

    function handleMiraKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMiraMessage(); }
    }

    // Wire up all Mira button handlers via addEventListener (not onclick)
    function wireMiraHandlers() {
        const fabBtn = document.getElementById('mira-fab-btn');
        const minBtn = document.getElementById('mira-minimize-btn');
        const sendBtn = document.getElementById('mira-send-btn');
        const miraInput = document.getElementById('mira-input');

        if (fabBtn) fabBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleMiraChat();
        });
        if (minBtn) minBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            closeMiraChat();
        });
        if (sendBtn) sendBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            sendMiraMessage();
        });
        if (miraInput) {
            miraInput.addEventListener('keydown', handleMiraKeydown);
            miraInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            miraInput.addEventListener('focus', () => {
                cancelMiraAutoCollapse();
                resetMiraIdleTimer();
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', wireMiraHandlers);
    } else {
        wireMiraHandlers();
    }

    // Trigger Mira greeting: vibrate FAB, auto-open, then auto-collapse after 4s
    // If user interacts (hovers/clicks/types), cancel the auto-collapse
    let miraAutoCollapseTimer = null;

    function cancelMiraAutoCollapse() {
        if (miraAutoCollapseTimer) {
            clearTimeout(miraAutoCollapseTimer);
            miraAutoCollapseTimer = null;
        }
    }

    function triggerMiraGreeting() {
        const widget = document.getElementById('mira-widget');
        const fab = widget.querySelector('.mira-fab');
        miraState.hasGreeted = true;

        // Cancel auto-collapse on any user interaction with the widget
        ['mouseenter', 'click', 'keydown'].forEach(evt => {
            widget.addEventListener(evt, cancelMiraAutoCollapse, { once: false });
        });

        setTimeout(() => {
            fab.classList.add('mira-incoming');
            setTimeout(() => {
                fab.classList.remove('mira-incoming');
                openMiraChat();
                // Auto-collapse after 4s so user sees greeting but it clears for QL panel
                miraAutoCollapseTimer = setTimeout(() => {
                    if (miraState.isOpen) closeMiraChat();
                }, 4000);
            }, 1200);
        }, 800);
    }

    // ============================================================
    // INIT
    // ============================================================
    async function init() {
        await loadSavedSearch();
        doSearch();
        // Fix Leaflet tile rendering ‚Äî force recalculation after layout resolves
        // The grid now has explicit height (calc(100vh-220px)) so this should work reliably
        setTimeout(() => { map.invalidateSize(); map.setView(map.getCenter()); }, 200);
        setTimeout(() => map.invalidateSize(), 1000);
        // Watch for container resize (window resize, sidebar toggle)
        if (window.ResizeObserver) {
            const mapEl = document.getElementById('search-map');
            const ro = new ResizeObserver(() => map.invalidateSize());
            ro.observe(mapEl);
        }
        // Vibrate + open Mira
        triggerMiraGreeting();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Sidebar toggle
    window.toggleSidebar = function() {
        document.getElementById('sidebar').classList.toggle('open');
    };

    // Expose for sidebar toggle
    window.toggleMiraChat = toggleMiraChat;

    // ============================================================
    // MIRA FILTER ACTIONS ‚Äî exposed for chat response handling
    // ============================================================
    window.applyMiraFilters = function(actions) {
        if (!actions || !actions.set_filters) return;
        const filters = actions.set_filters;
        let changed = false;

        // Set domains
        if (filters.domains && Array.isArray(filters.domains)) {
            state.domains = filters.domains;
            changed = true;
        }

        // Set qualification levels
        if (filters.ql && Array.isArray(filters.ql)) {
            state.ql = filters.ql;
            changed = true;
        }

        // Set city/location
        if (filters.lat != null && filters.lon != null) {
            state.lat = filters.lat;
            state.lon = filters.lon;
            state.radius_km = filters.radius_km || 50;

            // Update city input display
            const cityInput = document.getElementById('city-search');
            if (cityInput && filters.city) {
                cityInput.value = filters.city;
            }

            // Update radius dropdown
            const radiusSelect = document.getElementById('radius-select');
            if (radiusSelect) {
                radiusSelect.value = String(state.radius_km);
            }

            // Pan map and draw circle
            map.setView([state.lat, state.lon], 10);
            updateRadiusCircle();
            changed = true;
        }

        if (changed) {
            doSearch();
            // Ensure map tiles reload after filter-driven view change
            setTimeout(() => map.invalidateSize(), 200);
        }
    };
})();
</script>
{% endblock %}
