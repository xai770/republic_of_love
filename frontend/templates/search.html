{% extends "base.html" %}

{% block title %}{{ t('nav.search') }} ‚Äî talent.yoga{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}

    {% set active_page = 'search' %}
    {% include "partials/sidebar.html" %}

    <main class="main-content search-page">

        <!-- Search header -->
        <div class="search-header">
            <h1 class="search-title">üîç {{ t('search.title') }}</h1>
            <div class="search-active-filters" id="active-filters">
                <!-- Active filter pills rendered by JS -->
            </div>
        </div>

        <!-- Three-panel layout -->
        <div class="search-panels">
            <!-- LEFT: Domain (Berufsfeld) -->
            <div class="search-panel panel-domain">
                <h3 class="panel-title">{{ t('search.domain_title') }}</h3>
                <div class="domain-bars" id="domain-bars">
                    <!-- Rendered by JS -->
                    <div class="panel-loading">{{ t('search.loading') }}</div>
                </div>
            </div>

            <!-- CENTER: Map -->
            <div class="search-panel panel-map">
                <div class="map-controls">
                    <input type="text" id="city-search" placeholder="{{ t('search.city_placeholder') }}" autocomplete="off">
                    <select id="radius-select">
                        <option value="">{{ t('search.no_radius') }}</option>
                        <option value="10">10 km</option>
                        <option value="25">25 km</option>
                        <option value="50" selected>50 km</option>
                        <option value="100">100 km</option>
                    </select>
                </div>
                <div id="search-map"></div>
                <div class="map-stats" id="map-stats">
                    <div class="search-total" id="search-total">
                        <span class="total-number">‚Äî</span>
                        <span class="total-label">{{ t('search.positions_found') }}</span>
                    </div>
                    <div class="map-freshness" id="freshness-badge" style="display:none;">
                        <span id="fresh-count">0</span> {{ t('search.fresh_this_week') }}
                    </div>
                </div>
            </div>

            <!-- RIGHT: Intelligence panel -->
            <div class="search-panel panel-ql">
                <h3 class="panel-title">{{ t('search.ql_title') }}</h3>
                <div class="ql-buttons ql-compact" id="ql-buttons">
                    <!-- Rendered by JS -->
                    <div class="panel-loading">{{ t('search.loading') }}</div>
                </div>

                <!-- 30-day sparkline -->
                <div class="intel-section" id="intel-activity" style="display:none;">
                    <h4 class="intel-title">üìä 30 Tage</h4>
                    <canvas id="sparkline-canvas" width="320" height="100" style="width:100%;height:100px;"></canvas>
                </div>

                <!-- States + Professions side by side -->
                <div class="intel-split" id="intel-split" style="display:none;">
                    <div class="intel-list-col">
                        <h4 class="intel-title">üìç Bundesl√§nder</h4>
                        <div class="intel-list" id="intel-states"></div>
                    </div>
                    <div class="intel-list-col">
                        <h4 class="intel-title">üîÄ Berufe</h4>
                        <div class="intel-list" id="intel-professions"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save button -->
        <div class="search-actions">
            <button class="btn-save-search" id="btn-save-search">
                üíæ {{ t('search.save_search') }}
            </button>
            <span class="save-feedback" id="save-feedback"></span>
        </div>

        <!-- Search results -->
        <div class="search-results-section" id="search-results-section" style="display:none;">
            <h2 class="results-section-title" id="results-title"></h2>
            <div class="search-results-grid" id="search-results-grid">
                <!-- Tiles rendered by JS -->
            </div>
            <div class="results-show-more" id="results-show-more" style="display:none;">
                <button class="btn-show-more" id="btn-show-more"></button>
            </div>
        </div>

        <!-- Posting detail modal -->
        <div class="posting-modal-overlay" id="posting-modal-overlay">
            <div class="posting-modal">
                <div class="posting-modal-toolbar">
                    <button class="posting-modal-feedback" id="posting-modal-feedback"
                            onclick="openFeedbackWidget()" title="{{ t('search.report_issue') }}">üí°</button>
                    <button class="posting-modal-close" id="posting-modal-close">&times;</button>
                </div>
                <div class="posting-modal-body" id="posting-modal-body">
                    <!-- Filled by JS -->
                </div>
                <div class="posting-interest-bar" id="posting-interest-bar">
                    <p class="interest-prompt" id="interest-prompt"></p>
                    <div class="interest-buttons">
                        <button class="btn-interest btn-interested" id="btn-interested"></button>
                        <button class="btn-interest btn-not-interested" id="btn-not-interested"></button>
                    </div>
                    <div class="interest-reason-row" id="interest-reason-row" style="display:none;">
                        <input type="text" id="interest-reason" class="interest-reason-input" maxlength="200">
                        <button class="btn-interest-submit" id="btn-interest-submit">&#10003;</button>
                    </div>
                    <div class="interest-feedback" id="interest-feedback" style="display:none;"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Mira Chat Widget (same as dashboard) -->
    <div id="mira-widget" class="mira-widget">
        <button class="mira-fab" id="mira-fab-btn" title="{{ t('search.mira_chat_title') }}">
            <span class="mira-fab-icon">üí¨</span>
            <span class="mira-fab-close">‚úï</span>
        </button>
        
        <div class="mira-chat-window">
            <div class="mira-header">
                <div class="mira-avatar">üßò</div>
                <div class="mira-title">
                    <span class="mira-name">Mira</span>
                    <span class="mira-status">{{ t('search.mira_status') }}</span>
                </div>
                <button class="mira-minimize" id="mira-minimize-btn">‚àí</button>
            </div>
            
            <div class="mira-messages" id="mira-messages">
            </div>
            
            <div class="mira-input-area">
                <textarea id="mira-input" placeholder="{{ t('search.mira_placeholder') }}" rows="1"></textarea>
                <button class="mira-send" id="mira-send-btn">
                    <span>‚û§</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Search tour i18n + script -->
<script>
window.SEARCH_TOUR_I18N = {
    welcome_title: '{{ t("search.tour_welcome_title") }}',
    welcome_desc: '{{ t("search.tour_welcome_desc") }}',
    domain_title: '{{ t("search.tour_domain_title") }}',
    domain_desc: '{{ t("search.tour_domain_desc") }}',
    map_title: '{{ t("search.tour_map_title") }}',
    map_desc: '{{ t("search.tour_map_desc") }}',
    ql_title: '{{ t("search.tour_ql_title") }}',
    ql_desc: '{{ t("search.tour_ql_desc") }}',
    pills_title: '{{ t("search.tour_pills_title") }}',
    pills_desc: '{{ t("search.tour_pills_desc") }}',
    save_title: '{{ t("search.tour_save_title") }}',
    save_desc: '{{ t("search.tour_save_desc") }}',
    mira_title: '{{ t("search.tour_mira_title") }}',
    mira_desc: '{{ t("search.tour_mira_desc") }}',
    done_title: '{{ t("search.tour_done_title") }}',
    done_desc: '{{ t("search.tour_done_desc") }}',
    next: '{{ t("search.tour_next") }}',
    prev: '{{ t("search.tour_prev") }}',
    done: '{{ t("search.tour_done") }}',
    progress: '{{ t("search.tour_progress") }}',
};
</script>
<script src="/static/js/search-tour.js?v=20260212"></script>

<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
(function() {
    // ============================================================
    // I18N ‚Äî translations for JS-rendered content
    // ============================================================
    const LANG = '{{ lang }}';
    const I18N = {
        ql: { 1: '{{ t("search.ql_helfer") }}', 2: '{{ t("search.ql_fachkraft") }}', 3: '{{ t("search.ql_spezialist") }}', 4: '{{ t("search.ql_experte") }}' },
        domains: {
            'Gesundheit & Medizin': '{{ t("search.domain_gesundheit") }}',
            'IT & Technologie': '{{ t("search.domain_it") }}',
            'Fertigung & Technik': '{{ t("search.domain_fertigung") }}',
            'Maschinen & Elektro': '{{ t("search.domain_maschinen") }}',
            'Bau & Handwerk': '{{ t("search.domain_bau") }}',
            'Finanzen & Banken': '{{ t("search.domain_finanzen") }}',
            'Handel & Vertrieb': '{{ t("search.domain_handel") }}',
            'Transport & Logistik': '{{ t("search.domain_transport") }}',
            'Bildung & Soziales': '{{ t("search.domain_bildung") }}',
            'Wissenschaft & Forschung': '{{ t("search.domain_wissenschaft") }}',
            'Gastgewerbe & Tourismus': '{{ t("search.domain_tourismus") }}',
            'Gastgewerbe & Lebensmittel': '{{ t("search.domain_lebensmittel") }}',
            'Verwaltung & Recht': '{{ t("search.domain_verwaltung") }}',
            'Wirtschaft & Management': '{{ t("search.domain_wirtschaft") }}',
            'Land- & Forstwirtschaft': '{{ t("search.domain_landwirtschaft") }}',
            'Sicherheit & Verteidigung': '{{ t("search.domain_sicherheit") }}',
            'Kultur & Medien': '{{ t("search.domain_kultur") }}',
        },
        save_success: '{{ t("search.save_success") }}',
        save_error: '{{ t("search.save_error") }}',
        network_error: '{{ t("search.network_error") }}',
        mira_greeting: '{{ t("search.mira_greeting") }}',
        mira_error: '{{ t("search.mira_error") }}',
        mira_offline: '{{ t("search.mira_offline") }}',
        results_title: '{{ t("search.results_title") }}',
        results_loading: '{{ t("search.results_loading") }}',
        results_none: '{{ t("search.results_none") }}',
        results_show_more: '{{ t("search.results_show_more") }}',
        results_employer: '{{ t("search.results_employer") }}',
        results_location: '{{ t("search.results_location") }}',
        results_new: '{{ t("search.results_new") }}',
        results_view_details: '{{ t("search.results_view_details") }}',
        results_external: '{{ t("search.results_external") }}',
        detail_summary: '{{ t("search.detail_summary") }}',
        detail_description: '{{ t("search.detail_description") }}',
        detail_employer: '{{ t("search.detail_employer") }}',
        detail_location: '{{ t("search.detail_location") }}',
        detail_qualification: '{{ t("search.detail_qualification") }}',
        detail_sector: '{{ t("search.detail_sector") }}',
        detail_source: '{{ t("search.detail_source") }}',
        detail_seen_since: '{{ t("search.detail_seen_since") }}',
        detail_start_date: '{{ t("search.detail_start_date") }}',
        detail_contract: '{{ t("search.detail_contract") }}',
        detail_hours: '{{ t("search.detail_hours") }}',
        interest_prompt: '{{ t("search.interest_prompt") }}',
        interest_yes: '{{ t("search.interest_yes") }}',
        interest_no: '{{ t("search.interest_no") }}',
        interest_reason_placeholder: '{{ t("search.interest_reason_placeholder") }}',
        interest_saved: '{{ t("search.interest_saved") }}',
        interest_already_yes: '{{ t("search.interest_already_yes") }}',
        interest_already_no: '{{ t("search.interest_already_no") }}',
    };
    // Translate a domain name from API (German) to current language
    function tDomain(name) { return I18N.domains[name] || name; }
    // Translate a QL level to current language
    function tQL(level) { return I18N.ql[level] || ('Level ' + level); }

    // ============================================================
    // STATE
    // ============================================================
    const state = {
        domains: [],     // selected KLDB 2-digit codes
        ql: [],          // selected QL levels [1-4]
        lat: null,
        lon: null,
        radius_km: null,
        // data from last response
        data: null,
    };

    // ============================================================
    // MAP SETUP
    // ============================================================
    const map = L.map('search-map', {
        center: [51.1657, 10.4515],  // Germany center
        zoom: 6,
        zoomControl: true,
        scrollWheelZoom: true,
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 18,
    }).addTo(map);

    // Dedicated pane for heatmap ‚Äî semi-transparent so tiles show through
    map.createPane('heatPane');
    map.getPane('heatPane').style.zIndex = 350;
    map.getPane('heatPane').style.opacity = '0.55';

    let heatLayer = null;
    let radiusCircle = null;
    let searchMarker = null;
    let markerLayer = null;

    // Click on map = set center + radius
    map.on('click', function(e) {
        state.lat = Math.round(e.latlng.lat * 100) / 100;
        state.lon = Math.round(e.latlng.lng * 100) / 100;
        state.radius_km = parseInt(document.getElementById('radius-select').value) || null;
        updateRadiusCircle();
        doSearch();
    });

    function updateRadiusCircle() {
        if (radiusCircle) map.removeLayer(radiusCircle);
        if (searchMarker) map.removeLayer(searchMarker);

        if (state.lat && state.lon) {
            searchMarker = L.circleMarker([state.lat, state.lon], {
                radius: 6, color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.8, weight: 2
            }).addTo(map);

            if (state.radius_km) {
                radiusCircle = L.circle([state.lat, state.lon], {
                    radius: state.radius_km * 1000,
                    color: '#3498db', fillColor: '#3498db', fillOpacity: 0.08,
                    weight: 2, dashArray: '5,5'
                }).addTo(map);
            }
        }
    }

    // Radius dropdown change
    document.getElementById('radius-select').addEventListener('change', function() {
        state.radius_km = parseInt(this.value) || null;
        updateRadiusCircle();
        if (state.lat && state.lon) doSearch();
    });

    // ============================================================
    // CITY SEARCH (simple geocoding via Nominatim)
    // ============================================================
    let cityTimeout = null;
    const cityInput = document.getElementById('city-search');
    const cityDropdown = document.createElement('div');
    cityDropdown.className = 'city-dropdown';
    cityInput.parentElement.appendChild(cityDropdown);

    cityInput.addEventListener('input', function() {
        clearTimeout(cityTimeout);
        const q = this.value.trim();
        if (q.length < 2) { cityDropdown.innerHTML = ''; return; }
        cityTimeout = setTimeout(() => geocodeCity(q), 400);
    });

    async function geocodeCity(q) {
        try {
            const res = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&countrycodes=de&limit=5&q=${encodeURIComponent(q)}`,
                { headers: { 'Accept-Language': 'de' } }
            );
            const results = await res.json();
            cityDropdown.innerHTML = results.map(r =>
                `<div class="city-option" data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name.split(',').slice(0,2).join(',')}</div>`
            ).join('');
        } catch(e) {
            cityDropdown.innerHTML = '';
        }
    }

    cityDropdown.addEventListener('click', function(e) {
        const opt = e.target.closest('.city-option');
        if (!opt) return;
        state.lat = parseFloat(opt.dataset.lat);
        state.lon = parseFloat(opt.dataset.lon);
        state.radius_km = parseInt(document.getElementById('radius-select').value) || 50;
        cityInput.value = opt.textContent;
        cityDropdown.innerHTML = '';
        map.setView([state.lat, state.lon], 10);
        updateRadiusCircle();
        doSearch();
    });

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!cityInput.contains(e.target) && !cityDropdown.contains(e.target)) {
            cityDropdown.innerHTML = '';
        }
    });

    // ============================================================
    // DOMAIN BARS
    // ============================================================
    function renderDomains(domains) {
        const container = document.getElementById('domain-bars');
        if (!domains || domains.length === 0) {
            container.innerHTML = '<div class="panel-empty">‚Äî</div>';
            return;
        }
        const maxCount = Math.max(...domains.map(d => d.count));
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';

        container.innerHTML = domains.map(d => {
            const pct = maxCount > 0 ? Math.round(d.count / maxCount * 100) : 0;
            const selected = state.domains.length === 0 || d.codes.some(c => state.domains.includes(c));
            const dimmed = state.domains.length > 0 && !selected;
            return `
                <div class="domain-bar ${dimmed ? 'dimmed' : ''} ${selected && state.domains.length > 0 ? 'selected' : ''}"
                     data-codes="${d.codes.join(',')}" data-name="${d.name}">
                    <div class="domain-bar-label">${tDomain(d.name)}</div>
                    <div class="domain-bar-track">
                        <div class="domain-bar-fill" style="width:${pct}%; background:${d.color};"></div>
                    </div>
                    <div class="domain-bar-count">${d.count.toLocaleString(locale)}</div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('domain-bars').addEventListener('click', function(e) {
        const bar = e.target.closest('.domain-bar');
        if (!bar) return;
        const codes = bar.dataset.codes.split(',');

        // Toggle: if all codes are already selected, remove them. Otherwise add them.
        const allSelected = codes.every(c => state.domains.includes(c));
        if (allSelected) {
            state.domains = state.domains.filter(c => !codes.includes(c));
        } else {
            codes.forEach(c => { if (!state.domains.includes(c)) state.domains.push(c); });
        }
        doSearch();
    });

    // ============================================================
    // QL BAR CHART
    // ============================================================
    function renderQL(levels) {
        const container = document.getElementById('ql-buttons');
        const qlColors = { 1: '#95a5a6', 2: '#3498db', 3: '#e67e22', 4: '#e74c3c' };
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';
        const total = levels.reduce((s, l) => s + l.count, 0) || 1;

        container.innerHTML = levels.map(l => {
            const selected = state.ql.length === 0 || state.ql.includes(l.level);
            const dimmed = state.ql.length > 0 && !selected;
            const pct = ((l.count / total) * 100).toFixed(1);
            const color = qlColors[l.level] || '#999';
            return `
                <div class="ql-btn ${dimmed ? 'dimmed' : ''} ${selected && state.ql.length > 0 ? 'selected' : ''}"
                     data-level="${l.level}">
                    <div class="ql-bar-header">
                        <span class="ql-dot" style="background:${color};"></span>
                        <span class="ql-label">${tQL(l.level)}</span>
                        <span class="ql-count">${l.count.toLocaleString(locale)}</span>
                        <span class="ql-pct">${pct}%</span>
                    </div>
                    <div class="ql-bar-track">
                        <div class="ql-bar-fill" style="width:${pct}%; background:${color};"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('ql-buttons').addEventListener('click', function(e) {
        const btn = e.target.closest('.ql-btn');
        if (!btn) return;
        const level = parseInt(btn.dataset.level);
        const idx = state.ql.indexOf(level);
        if (idx >= 0) {
            state.ql.splice(idx, 1);
        } else {
            state.ql.push(level);
        }
        doSearch();
    });

    // ============================================================
    // HEATMAP
    // ============================================================
    function renderHeatmap(points) {
        if (heatLayer) map.removeLayer(heatLayer);
        if (!points || points.length === 0) return;

        // Use 90th percentile for max to prevent outlier dominance
        const weights = points.map(p => p[2]).sort((a, b) => a - b);
        const p90 = weights[Math.floor(weights.length * 0.9)] || 1;
        const maxW = Math.max(p90 * 1.5, 1);

        heatLayer = L.heatLayer(points, {
            radius: 20,
            blur: 25,
            maxZoom: 13,
            minOpacity: 0.18,
            max: maxW,
            pane: 'heatPane',
            gradient: {
                0.0: 'rgba(240,244,255,0.0)',
                0.10: 'rgba(147,197,253,0.4)',
                0.30: 'rgba(59,130,246,0.6)',
                0.50: 'rgba(34,197,94,0.7)',
                0.70: 'rgba(250,204,21,0.8)',
                0.85: 'rgba(249,115,22,0.9)',
                1.0:  'rgba(239,68,68,1.0)'
            }
        }).addTo(map);
    }

    // ============================================================
    // MAP MARKERS (individual postings)
    // ============================================================
    const MARKER_MIN_ZOOM = 8;  // markers appear at city level

    function markerRadius(zoom) {
        if (zoom <= 8) return 4;
        if (zoom <= 10) return 5;
        if (zoom <= 12) return 6;
        return 7;
    }

    function renderMarkers(markers) {
        if (markerLayer) { map.removeLayer(markerLayer); markerLayer = null; }
        if (!markers || markers.length === 0) return;

        const zoom = map.getZoom();
        markerLayer = L.layerGroup();
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const markerColor = isDark ? '#60a5fa' : '#2563eb';
        const borderColor = isDark ? '#93c5fd' : '#1d4ed8';
        const textColor = isDark ? '#e2e8f0' : '#1e293b';

        markers.forEach(m => {
            const cm = L.circleMarker([m.lat, m.lon], {
                radius: markerRadius(zoom),
                color: borderColor,
                fillColor: markerColor,
                fillOpacity: 0.8,
                weight: 1.5,
            });

            // Tooltip on hover
            const title = m.t || 'Untitled';
            const employer = m.e ? `<br><span style="color:${isDark ? '#94a3b8' : '#64748b'}">${m.e}</span>` : '';
            const city = m.c ? `<br><span style="color:${isDark ? '#94a3b8' : '#64748b'}; font-size:11px">üìç ${m.c}</span>` : '';
            cm.bindTooltip(
                `<strong style="color:${textColor}">${title}</strong>${employer}${city}`,
                {
                    direction: 'top',
                    offset: [0, -8],
                    className: 'posting-marker-tooltip'
                }
            );

            markerLayer.addLayer(cm);
        });

        // Show markers only when zoomed to city level or closer
        if (zoom >= MARKER_MIN_ZOOM) {
            markerLayer.addTo(map);
        }
        updateZoomHint(zoom);
    }

    // Toggle markers + resize on zoom
    map.on('zoomend', function() {
        const zoom = map.getZoom();
        updateZoomBadge(zoom);
        if (markerLayer) {
            if (zoom >= MARKER_MIN_ZOOM && !map.hasLayer(markerLayer)) {
                markerLayer.addTo(map);
            } else if (zoom < MARKER_MIN_ZOOM && map.hasLayer(markerLayer)) {
                map.removeLayer(markerLayer);
            }
            if (map.hasLayer(markerLayer)) {
                const r = markerRadius(zoom);
                markerLayer.eachLayer(function(layer) { layer.setRadius(r); });
            }
        }
        updateZoomHint(zoom);
    });

    // --- Zoom level badge (bottom-left overlay) ---
    const zoomBadge = L.DomUtil.create('div', 'zoom-badge');
    zoomBadge.style.cssText = 'position:absolute;bottom:28px;left:10px;z-index:800;background:rgba(0,0,0,0.55);color:#fff;padding:2px 7px;border-radius:4px;font-size:11px;font-family:system-ui,sans-serif;pointer-events:none;';
    document.getElementById('search-map').appendChild(zoomBadge);
    function updateZoomBadge(z) { zoomBadge.textContent = 'Zoom ' + z; }
    updateZoomBadge(map.getZoom());

    // --- Hint when zoomed out ---
    const zoomHint = L.DomUtil.create('div', 'zoom-hint');
    zoomHint.style.cssText = 'position:absolute;bottom:28px;left:50%;transform:translateX(-50%);z-index:800;background:rgba(0,0,0,0.6);color:#e2e8f0;padding:4px 12px;border-radius:6px;font-size:11px;font-family:system-ui,sans-serif;pointer-events:none;opacity:0;transition:opacity 0.3s;white-space:nowrap;';
    zoomHint.textContent = 'üîç Zoom in to see job markers';
    document.getElementById('search-map').appendChild(zoomHint);
    function updateZoomHint(z) { zoomHint.style.opacity = (z < MARKER_MIN_ZOOM && markerLayer) ? '1' : '0'; }

    // ============================================================
    // ACTIVE FILTER PILLS
    // ============================================================
    function renderFilterPills() {
        const container = document.getElementById('active-filters');
        let pills = [];

        // Domain pills
        if (state.domains.length > 0) {
            // Group by domain name
            const names = new Set();
            for (const code of state.domains) {
                for (const [name, codes] of Object.entries(window._domainMap || {})) {
                    if (codes.includes(code)) names.add(name);
                }
            }
            names.forEach(name => {
                pills.push(`<span class="filter-pill domain-pill" data-type="domain" data-name="${name}">
                    ${tDomain(name)} <button class="pill-remove" data-type="domain" data-name="${name}">√ó</button>
                </span>`);
            });
        }

        // QL pills
        state.ql.forEach(level => {
            const label = tQL(level);
            pills.push(`<span class="filter-pill ql-pill" data-type="ql" data-level="${level}">
                ${label} <button class="pill-remove" data-type="ql" data-level="${level}">√ó</button>
            </span>`);
        });

        // Geo pill
        if (state.lat && state.lon) {
            const geoLabel = cityInput.value || `${state.lat}, ${state.lon}`;
            const rLabel = state.radius_km ? ` (${state.radius_km} km)` : '';
            pills.push(`<span class="filter-pill geo-pill" data-type="geo">
                üìç ${geoLabel}${rLabel} <button class="pill-remove" data-type="geo">√ó</button>
            </span>`);
        }

        container.innerHTML = pills.join('');
    }

    document.getElementById('active-filters').addEventListener('click', function(e) {
        const btn = e.target.closest('.pill-remove');
        if (!btn) return;
        const type = btn.dataset.type;
        if (type === 'domain') {
            const name = btn.dataset.name;
            const codes = (window._domainMap || {})[name] || [];
            state.domains = state.domains.filter(c => !codes.includes(c));
        } else if (type === 'ql') {
            const level = parseInt(btn.dataset.level);
            state.ql = state.ql.filter(l => l !== level);
        } else if (type === 'geo') {
            state.lat = null;
            state.lon = null;
            state.radius_km = null;
            cityInput.value = '';
            if (radiusCircle) map.removeLayer(radiusCircle);
            if (searchMarker) map.removeLayer(searchMarker);
            radiusCircle = null;
            searchMarker = null;
        }
        doSearch();
    });

    // ============================================================
    // TOTAL + FRESHNESS
    // ============================================================
    function renderTotal(total) {
        const el = document.getElementById('search-total');
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';
        el.querySelector('.total-number').textContent = total.toLocaleString(locale);
    }

    function renderFreshness(count) {
        const badge = document.getElementById('freshness-badge');
        if (count > 0) {
            badge.style.display = '';
            const locale = LANG === 'de' ? 'de-DE' : 'en-US';
            document.getElementById('fresh-count').textContent = count.toLocaleString(locale);
        } else {
            badge.style.display = 'none';
        }
    }

    // ============================================================
    // INTELLIGENCE PANEL ‚Äî sparkline + state/profession rankings
    // ============================================================
    function renderSparkline(days) {
        const canvas = document.getElementById('sparkline-canvas');
        const section = document.getElementById('intel-activity');
        if (!days || days.length === 0) { section.style.display = 'none'; return; }
        section.style.display = '';

        // HiDPI canvas sizing
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        const W = rect.width, H = rect.height;

        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const gridColor = isDark ? 'rgba(148,163,184,0.15)' : 'rgba(100,116,139,0.12)';
        const weekColor = isDark ? 'rgba(148,163,184,0.30)' : 'rgba(100,116,139,0.25)';
        const textCol = isDark ? '#94a3b8' : '#94a3b8';

        // Layout: left margin for Y-axis, bottom for date labels
        const marginL = 36, marginB = 16, marginT = 4, marginR = 4;
        const plotW = W - marginL - marginR;
        const plotH = H - marginT - marginB;

        const maxCount = Math.max(...days.map(d => d.count), 1);

        // --- Y-axis steps ---
        // Pick nice step: 1,2,5,10,20,50,100,200,500,1000,2000,5000,10000,...
        function niceStep(max) {
            const rough = max / 3;
            const mag = Math.pow(10, Math.floor(Math.log10(rough)));
            const residual = rough / mag;
            if (residual <= 1.5) return mag;
            if (residual <= 3.5) return 2 * mag;
            if (residual <= 7.5) return 5 * mag;
            return 10 * mag;
        }
        const step = niceStep(maxCount);
        const yMax = Math.ceil(maxCount / step) * step;

        ctx.font = '9px system-ui, sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';

        // Draw Y-axis grid lines + labels
        for (let v = 0; v <= yMax; v += step) {
            const y = marginT + plotH - (v / yMax) * plotH;
            // Grid line
            ctx.strokeStyle = gridColor;
            ctx.lineWidth = 0.7;
            ctx.beginPath();
            ctx.moveTo(marginL, y);
            ctx.lineTo(W - marginR, y);
            ctx.stroke();
            // Label
            const label = v >= 1000 ? (v / 1000) + 'k' : v.toString();
            ctx.fillStyle = textCol;
            ctx.fillText(label, marginL - 4, y);
        }

        // Build data points in plot area
        const points = days.map((d, i) => ({
            x: marginL + (i / (days.length - 1)) * plotW,
            y: marginT + plotH - (d.count / yMax) * plotH,
            count: d.count,
            date: d.date,
        }));

        // --- Vertical grid lines ---
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        days.forEach((d, i) => {
            const x = points[i].x;
            const dt = new Date(d.date + 'T00:00:00');
            const dow = dt.getDay(); // 0=Sun, 1=Mon

            if (dow === 1) {
                // Monday ‚Äî solid week line + date label
                ctx.strokeStyle = weekColor;
                ctx.lineWidth = 1;
                ctx.setLineDash([]);
                ctx.beginPath();
                ctx.moveTo(x, marginT);
                ctx.lineTo(x, marginT + plotH);
                ctx.stroke();
                // Date label
                const lbl = dt.getDate() + '.' + (dt.getMonth() + 1) + '.';
                ctx.fillStyle = textCol;
                ctx.font = '8px system-ui, sans-serif';
                ctx.fillText(lbl, x, marginT + plotH + 3);
            } else {
                // Other days ‚Äî dotted lines
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 0.5;
                ctx.setLineDash([2, 3]);
                ctx.beginPath();
                ctx.moveTo(x, marginT);
                ctx.lineTo(x, marginT + plotH);
                ctx.stroke();
            }
        });
        ctx.setLineDash([]);

        // --- Color interpolation: grey (old/left) ‚Üí green (recent/right) ---
        // Older postings fade to grey, recent ones vivid green
        const greyR = isDark ? 100 : 160, greyG = isDark ? 116 : 174, greyB = isDark ? 139 : 185;
        const greenR = isDark ? 74 : 34, greenG = isDark ? 222 : 197, greenB = isDark ? 128 : 94;
        function lerpColor(t) {
            const r = Math.round(greyR + (greenR - greyR) * t);
            const g = Math.round(greyG + (greenG - greyG) * t);
            const b = Math.round(greyB + (greenB - greyB) * t);
            return [r, g, b];
        }

        // --- Gradient fill under the line (left-to-right fade) ---
        ctx.beginPath();
        ctx.moveTo(points[0].x, marginT + plotH);
        points.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.lineTo(points[points.length - 1].x, marginT + plotH);
        ctx.closePath();
        const grad = ctx.createLinearGradient(points[0].x, 0, points[points.length - 1].x, 0);
        const [gr0, gg0, gb0] = lerpColor(0);
        const [gr1, gg1, gb1] = lerpColor(1);
        grad.addColorStop(0, `rgba(${gr0},${gg0},${gb0},0.08)`);
        grad.addColorStop(0.5, `rgba(${Math.round((gr0+gr1)/2)},${Math.round((gg0+gg1)/2)},${Math.round((gb0+gb1)/2)},0.18)`);
        grad.addColorStop(1, `rgba(${gr1},${gg1},${gb1},0.30)`);
        ctx.fillStyle = grad;
        ctx.fill();

        // --- Fading line: draw segment-by-segment with interpolated color ---
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        for (let i = 1; i < points.length; i++) {
            const t = i / (points.length - 1); // 0 = old, 1 = recent
            const [cr, cg, cb] = lerpColor(t);
            const segColor = `rgb(${cr},${cg},${cb})`;
            const prev = points[i - 1], curr = points[i];
            const cpx = (prev.x + curr.x) / 2;
            ctx.beginPath();
            ctx.moveTo(prev.x, prev.y);
            ctx.bezierCurveTo(cpx, prev.y, cpx, curr.y, curr.x, curr.y);
            ctx.strokeStyle = segColor;
            // Subtle glow only on recent half
            if (t > 0.5) {
                ctx.shadowColor = segColor;
                ctx.shadowBlur = 3 * t;
            } else {
                ctx.shadowBlur = 0;
            }
            ctx.stroke();
        }
        ctx.shadowBlur = 0;

        // --- Hover tooltip ---
        canvas.onmousemove = function(e) {
            const br = canvas.getBoundingClientRect();
            const mx = e.clientX - br.left;
            let closest = points[0], minDist = 9999;
            for (const p of points) {
                const dist = Math.abs(p.x - mx);
                if (dist < minDist) { minDist = dist; closest = p; }
            }
            canvas.title = closest.date + ': ' + closest.count.toLocaleString();
        };
    }

    function renderIntelList(containerId, items, labelKey) {
        const el = document.getElementById(containerId);
        const locale = LANG === 'de' ? 'de-DE' : 'en-US';
        if (!items || items.length === 0) {
            el.innerHTML = '<div class="intel-empty">‚Äî</div>';
            return;
        }
        el.innerHTML = items.map((item, i) => {
            const name = item[labelKey] || '‚Äî';
            const abbr = name;
            return `<div class="intel-row" title="${name}: ${item.fresh}">
                <span class="intel-rank">${i + 1}.</span>
                <span class="intel-name">${abbr}</span>
                <span class="intel-count">${item.fresh.toLocaleString(locale)}</span>
            </div>`;
        }).join('');
    }

    async function loadIntelligence() {
        try {
            const body = {};
            if (state.domains.length > 0) body.domains = state.domains;
            const res = await fetch('/api/search/intelligence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!res.ok) return;
            const data = await res.json();
            renderSparkline(data.activity);
            document.getElementById('intel-split').style.display = '';
            renderIntelList('intel-states', data.states, 'state');
            renderIntelList('intel-professions', data.professions, 'name');
        } catch(e) {
            console.warn('Intelligence load failed:', e);
        }
    }

    // ============================================================
    // MAIN SEARCH
    // ============================================================
    let searchPending = false;
    let searchQueued = false;

    async function doSearch() {
        if (searchPending) { searchQueued = true; return; }
        searchPending = true;

        const body = {};
        if (state.domains.length > 0) body.domains = state.domains;
        if (state.ql.length > 0) body.ql = state.ql;
        if (state.lat != null) body.lat = state.lat;
        if (state.lon != null) body.lon = state.lon;
        if (state.radius_km) body.radius_km = state.radius_km;

        try {
            const res = await fetch('/api/search/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            state.data = data;

            // Build domain map for pill rendering
            window._domainMap = {};
            data.by_domain.forEach(d => { window._domainMap[d.name] = d.codes; });

            renderDomains(data.by_domain);
            renderQL(data.by_ql);
            renderHeatmap(data.heatmap);
            renderMarkers(data.markers);
            renderTotal(data.total);
            renderFreshness(data.fresh_count);
            renderFilterPills();

            // Force map tile refresh after render
            setTimeout(() => map.invalidateSize(), 50);

            // Load intelligence data (sparkline + rankings)
            loadIntelligence();

            // Load matching postings as result tiles
            loadResults(true);

            // Track filter state for Mira context
            if (typeof trackEvent === 'function') {
                trackEvent('search_filter', {
                    domains: state.domains,
                    ql: state.ql,
                    city: state.city || null,
                    radius: state.radius_km,
                    results: data.total
                });
            }
        } catch(e) {
            console.error('Search failed:', e);
        } finally {
            searchPending = false;
            if (searchQueued) {
                searchQueued = false;
                doSearch();
            }
        }
    }

    // ============================================================
    // SEARCH RESULTS ‚Äî tiles / rolodex
    // ============================================================
    let resultsOffset = 0;
    let resultsLoading = false;
    let currentPostingId = null;
    let pendingInterest = null;

    function buildFilterBody() {
        const body = {};
        if (state.domains.length > 0) body.domains = state.domains;
        if (state.ql.length > 0) body.ql = state.ql;
        if (state.lat != null) body.lat = state.lat;
        if (state.lon != null) body.lon = state.lon;
        if (state.radius_km) body.radius_km = state.radius_km;
        return body;
    }

    async function loadResults(reset) {
        if (resultsLoading) return;
        resultsLoading = true;

        if (reset) resultsOffset = 0;

        const grid = document.getElementById('search-results-grid');
        const section = document.getElementById('search-results-section');
        const showMore = document.getElementById('results-show-more');

        if (reset) {
            grid.innerHTML = `<div class="results-loading">${I18N.results_loading}</div>`;
            section.style.display = '';
        }

        const body = buildFilterBody();
        body.offset = resultsOffset;
        body.limit = 20;

        try {
            const res = await fetch('/api/search/results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            if (reset) grid.innerHTML = '';

            // Title
            document.getElementById('results-title').textContent = I18N.results_title;

            if (data.results.length === 0 && resultsOffset === 0) {
                grid.innerHTML = `<div class="results-empty">${I18N.results_none}</div>`;
                showMore.style.display = 'none';
                resultsLoading = false;
                return;
            }

            // Render tiles
            const locale = LANG === 'de' ? 'de-DE' : 'en-US';
            data.results.forEach(p => {
                const tile = document.createElement('div');
                tile.className = 'result-tile';
                tile.dataset.postingId = p.posting_id;
                if (p.interested === true) tile.classList.add('tile-interested');
                if (p.interested === false) tile.classList.add('tile-not-interested');

                const isNew = p.first_seen && (Date.now() - new Date(p.first_seen).getTime()) < 7 * 86400000;
                const dateStr = p.first_seen ? new Date(p.first_seen).toLocaleDateString(locale) : '';

                tile.innerHTML = `
                    <div class="tile-header">
                        <span class="tile-domain-dot" style="background:${p.domain_color};" title="${tDomain(p.domain)}"></span>
                        <span class="tile-ql-badge">${tQL(p.ql_level)}</span>
                        ${isNew ? `<span class="tile-new-badge">${I18N.results_new}</span>` : ''}
                        ${p.interested === true ? '<span class="tile-interest-icon" title="' + I18N.interest_already_yes + '">üëç</span>' : ''}
                        ${p.interested === false ? '<span class="tile-interest-icon" title="' + I18N.interest_already_no + '">üëé</span>' : ''}
                    </div>
                    <h3 class="tile-title">${escHtml(p.job_title)}</h3>
                    ${p.employer ? `<div class="tile-employer">${escHtml(p.employer)}</div>` : ''}
                    ${p.location ? `<div class="tile-location">üìç ${escHtml(p.location)}</div>` : ''}
                    ${p.summary ? `<div class="tile-summary">${escHtml(p.summary).substring(0, 150)}${p.summary.length > 150 ? '‚Ä¶' : ''}</div>` : ''}
                    <div class="tile-footer">
                        <span class="tile-date">${dateStr}</span>
                        <button class="tile-details-btn">${I18N.results_view_details}</button>
                    </div>
                `;
                grid.appendChild(tile);
            });

            resultsOffset += data.results.length;
            if (data.has_more) {
                showMore.style.display = '';
                document.getElementById('btn-show-more').textContent = I18N.results_show_more;
            } else {
                showMore.style.display = 'none';
            }
        } catch(e) {
            console.error('Results failed:', e);
            if (reset) grid.innerHTML = `<div class="results-empty">${I18N.network_error}</div>`;
        } finally {
            resultsLoading = false;
        }
    }

    function escHtml(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // Click on tile ‚Üí open detail
    document.getElementById('search-results-grid').addEventListener('click', function(e) {
        const btn = e.target.closest('.tile-details-btn');
        const tile = e.target.closest('.result-tile');
        if (btn && tile) {
            openPostingDetail(parseInt(tile.dataset.postingId));
        }
    });

    // Show more
    document.getElementById('btn-show-more').addEventListener('click', function() {
        loadResults(false);
    });

    // ============================================================
    // POSTING DETAIL MODAL
    // ============================================================
    async function openPostingDetail(postingId) {
        currentPostingId = postingId;
        const overlay = document.getElementById('posting-modal-overlay');
        const body = document.getElementById('posting-modal-body');
        const interestBar = document.getElementById('posting-interest-bar');

        body.innerHTML = `<div class="results-loading">${I18N.results_loading}</div>`;
        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';

        // Reset interest bar
        document.getElementById('interest-prompt').textContent = I18N.interest_prompt;
        document.getElementById('btn-interested').textContent = I18N.interest_yes;
        document.getElementById('btn-not-interested').textContent = I18N.interest_no;
        document.getElementById('interest-reason-row').style.display = 'none';
        document.getElementById('interest-feedback').style.display = 'none';
        document.getElementById('interest-reason').placeholder = I18N.interest_reason_placeholder;
        pendingInterest = null;

        try {
            const res = await fetch(`/api/search/posting/${postingId}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const p = await res.json();

            const locale = LANG === 'de' ? 'de-DE' : 'en-US';
            const seenDate = p.first_seen ? new Date(p.first_seen).toLocaleDateString(locale) : '';
            const lastDate = p.last_seen ? new Date(p.last_seen).toLocaleDateString(locale) : '';

            let html = `
                <div class="detail-header">
                    <span class="tile-domain-dot" style="background:${p.domain_color}; width:14px; height:14px;"></span>
                    <span class="detail-domain">${tDomain(p.domain)}</span>
                    <span class="detail-ql">${p.ql_label}</span>
                </div>
                <h2 class="detail-title">${escHtml(p.job_title)}</h2>
            `;

            // Info grid
            const infoRows = [];
            if (p.employer) infoRows.push([I18N.detail_employer, escHtml(p.employer) + (p.employer_industry ? ` <span class="detail-dim">(${escHtml(p.employer_industry)})</span>` : '')]);
            if (p.location) infoRows.push([I18N.detail_location, escHtml(p.location)]);
            if (p.start_date) infoRows.push([I18N.detail_start_date, escHtml(p.start_date)]);
            if (p.contract_type) infoRows.push([I18N.detail_contract, escHtml(p.contract_type)]);
            if (p.work_hours) infoRows.push([I18N.detail_hours, escHtml(p.work_hours)]);
            if (p.source) infoRows.push([I18N.detail_source, escHtml(p.source)]);
            if (seenDate) infoRows.push([I18N.detail_seen_since, seenDate + (lastDate && lastDate !== seenDate ? ` ‚Äî ${lastDate}` : '')]);

            if (infoRows.length) {
                html += `<div class="detail-info-grid">` +
                    infoRows.map(([label, val]) => `<div class="detail-info-label">${label}</div><div class="detail-info-value">${val}</div>`).join('') +
                `</div>`;
            }

            // Summary
            if (p.summary) {
                html += `<div class="detail-section">
                    <h4>${I18N.detail_summary}</h4>
                    <p>${escHtml(p.summary)}</p>
                </div>`;
            }

            // Description
            if (p.job_description) {
                html += `<div class="detail-section">
                    <h4>${I18N.detail_description}</h4>
                    <div class="detail-description">${escHtml(p.job_description)}</div>
                </div>`;
            }

            // External link
            if (p.external_url) {
                html += `<div class="detail-actions">
                    <a href="${p.external_url}" target="_blank" rel="noopener" class="btn-external-link">${I18N.results_external} ‚Üó</a>
                </div>`;
            }

            body.innerHTML = html;

            // Show existing interest state
            if (p.interested === true) {
                showInterestState(true);
            } else if (p.interested === false) {
                showInterestState(false);
            }
        } catch(e) {
            body.innerHTML = `<div class="results-empty">${I18N.network_error}</div>`;
        }
    }

    function closePostingModal() {
        const overlay = document.getElementById('posting-modal-overlay');
        overlay.classList.remove('open');
        document.body.style.overflow = '';
        currentPostingId = null;
    }

    document.getElementById('posting-modal-close').addEventListener('click', closePostingModal);
    document.getElementById('posting-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closePostingModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('posting-modal-overlay').classList.contains('open')) {
            closePostingModal();
        }
    });

    // ============================================================
    // INTEREST FEEDBACK
    // ============================================================
    document.getElementById('btn-interested').addEventListener('click', function() {
        pendingInterest = true;
        document.getElementById('interest-reason-row').style.display = 'flex';
        document.getElementById('interest-reason').focus();
        this.classList.add('active');
        document.getElementById('btn-not-interested').classList.remove('active');
        // Can submit immediately (reason is optional)
        submitInterest();
    });

    document.getElementById('btn-not-interested').addEventListener('click', function() {
        pendingInterest = false;
        document.getElementById('interest-reason-row').style.display = 'flex';
        document.getElementById('interest-reason').focus();
        this.classList.add('active');
        document.getElementById('btn-interested').classList.remove('active');
        // Show reason input but don't submit yet ‚Äî reason is more valuable for "not interested"
    });

    document.getElementById('btn-interest-submit').addEventListener('click', submitInterest);
    document.getElementById('interest-reason').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); submitInterest(); }
    });

    async function submitInterest() {
        if (pendingInterest === null || !currentPostingId) return;
        const reason = document.getElementById('interest-reason').value.trim() || null;

        try {
            const res = await fetch('/api/search/interest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    posting_id: currentPostingId,
                    interested: pendingInterest,
                    reason: reason,
                }),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            showInterestState(pendingInterest);

            // Update tile in grid
            const tile = document.querySelector(`.result-tile[data-posting-id="${currentPostingId}"]`);
            if (tile) {
                tile.classList.remove('tile-interested', 'tile-not-interested');
                tile.classList.add(pendingInterest ? 'tile-interested' : 'tile-not-interested');
                // Update interest icon
                tile.querySelectorAll('.tile-interest-icon').forEach(i => i.remove());
                const header = tile.querySelector('.tile-header');
                if (header) {
                    const icon = document.createElement('span');
                    icon.className = 'tile-interest-icon';
                    icon.textContent = pendingInterest ? 'üëç' : 'üëé';
                    icon.title = pendingInterest ? I18N.interest_already_yes : I18N.interest_already_no;
                    header.appendChild(icon);
                }
            }
        } catch(e) {
            console.error('Interest save failed:', e);
        }
    }

    function showInterestState(interested) {
        document.getElementById('interest-reason-row').style.display = 'none';
        const fb = document.getElementById('interest-feedback');
        fb.style.display = '';
        fb.textContent = I18N.interest_saved;
        fb.className = 'interest-feedback ' + (interested ? 'interest-positive' : 'interest-negative');

        document.getElementById('btn-interested').classList.toggle('active', interested === true);
        document.getElementById('btn-not-interested').classList.toggle('active', interested === false);
    }

    // ============================================================
    // SAVE SEARCH
    // ============================================================
    document.getElementById('btn-save-search').addEventListener('click', async function() {
        const body = {};
        if (state.domains.length > 0) body.domains = state.domains;
        if (state.ql.length > 0) body.ql = state.ql;
        if (state.lat != null) body.lat = state.lat;
        if (state.lon != null) body.lon = state.lon;
        if (state.radius_km) body.radius_km = state.radius_km;

        const feedback = document.getElementById('save-feedback');
        try {
            const res = await fetch('/api/search/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!res.ok) {
                const err = await res.json();
                feedback.textContent = err.error || I18N.save_error;
                feedback.className = 'save-feedback error';
            } else {
                feedback.textContent = I18N.save_success;
                feedback.className = 'save-feedback success';
            }
        } catch(e) {
            feedback.textContent = I18N.network_error;
            feedback.className = 'save-feedback error';
        }
        setTimeout(() => { feedback.textContent = ''; }, 3000);
    });

    // ============================================================
    // LOAD SAVED SEARCH + AUTO-SEED FROM PROFILE
    // ============================================================
    async function loadSavedSearch() {
        try {
            const res = await fetch('/api/search/saved');
            if (!res.ok) return;
            const data = await res.json();
            if (data.search_params) {
                const sp = data.search_params;
                if (sp.domains) state.domains = sp.domains;
                if (sp.ql) state.ql = sp.ql;
                if (sp.lat != null) { state.lat = sp.lat; state.lon = sp.lon; }
                if (sp.radius_km) {
                    state.radius_km = sp.radius_km;
                    document.getElementById('radius-select').value = sp.radius_km;
                }
                if (state.lat && state.lon) {
                    map.setView([state.lat, state.lon], 10);
                    updateRadiusCircle();
                }
            }
        } catch(e) {
            console.warn('Could not load saved search:', e);
        }
    }

    // ============================================================
    // MIRA CHAT WIDGET ‚Äî Smart FAB pattern
    // ============================================================
    const miraState = {
        isOpen: false,
        hasGreeted: false,
        usesDu: null,
        history: [],
        idleTimer: null,
    };

    function openMiraChat() {
        const widget = document.getElementById('mira-widget');
        miraState.isOpen = true;
        widget.classList.add('open');
        widget.classList.remove('mira-idle');
        resetMiraIdleTimer();
        if (!miraState.hasGreeted) {
            loadMiraGreeting();
            miraState.hasGreeted = true;
        }
        setTimeout(() => document.getElementById('mira-input').focus(), 300);
    }

    function closeMiraChat() {
        const widget = document.getElementById('mira-widget');
        miraState.isOpen = false;
        widget.classList.remove('open', 'mira-idle');
        clearTimeout(miraState.idleTimer);
    }

    function toggleMiraChat() {
        if (miraState.isOpen) closeMiraChat(); else openMiraChat();
    }

    // Idle transparency ‚Äî after 5s without hover/interaction, dim the chat
    function resetMiraIdleTimer() {
        const widget = document.getElementById('mira-widget');
        widget.classList.remove('mira-idle');
        clearTimeout(miraState.idleTimer);
        if (!miraState.isOpen) return;
        miraState.idleTimer = setTimeout(() => {
            if (miraState.isOpen) widget.classList.add('mira-idle');
        }, 5000);
    }

    // Click outside = close
    document.addEventListener('mousedown', function(e) {
        const widget = document.getElementById('mira-widget');
        if (miraState.isOpen && !widget.contains(e.target)) {
            closeMiraChat();
        }
    });

    // Reset idle on any interaction within the widget
    document.addEventListener('DOMContentLoaded', () => {
        const widget = document.getElementById('mira-widget');
        ['mouseenter', 'mousemove', 'click', 'keydown'].forEach(evt => {
            widget.addEventListener(evt, resetMiraIdleTimer);
        });
    });

    function loadMiraGreeting() {
        addMiraMessage(I18N.mira_greeting, false);
    }

    function addMiraMessage(content, isUser) {
        const container = document.getElementById('mira-messages');
        const msg = document.createElement('div');
        msg.className = `mira-message ${isUser ? 'user' : 'mira'}`;
        msg.textContent = content;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
    }

    function showMiraTyping() {
        const container = document.getElementById('mira-messages');
        const typing = document.createElement('div');
        typing.className = 'mira-typing'; typing.id = 'mira-typing';
        typing.innerHTML = '<span></span><span></span><span></span>';
        container.appendChild(typing);
        container.scrollTop = container.scrollHeight;
    }

    function hideMiraTyping() {
        const el = document.getElementById('mira-typing'); if (el) el.remove();
    }

    async function sendMiraMessage() {
        const input = document.getElementById('mira-input');
        const text = input.value.trim();
        if (!text) return;
        addMiraMessage(text, true);
        input.value = ''; input.style.height = 'auto';

        if (miraState.usesDu === null) {
            if (/\b(du|dein|dich|dir)\b/i.test(text)) miraState.usesDu = true;
            else if (/\b(Sie|Ihr|Ihnen|Ihre)\b/.test(text)) miraState.usesDu = false;
        }

        showMiraTyping();
        miraState.history.push({ role: 'user', content: text });

        try {
            const response = await fetch('/api/mira/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, uses_du: miraState.usesDu, history: miraState.history.slice(0, -1) })
            });
            hideMiraTyping();
            if (response.ok) {
                const data = await response.json();
                addMiraMessage(data.reply, false);
                miraState.history.push({ role: 'assistant', content: data.reply });
                if (miraState.history.length > 20) miraState.history = miraState.history.slice(-20);

                // Apply search filter actions if present
                if (data.actions && window.applyMiraFilters) {
                    window.applyMiraFilters(data.actions);
                }
            } else {
                addMiraMessage(I18N.mira_error, false);
                miraState.history.pop();
            }
        } catch (error) {
            hideMiraTyping();
            addMiraMessage(I18N.mira_offline, false);
            miraState.history.pop();
        }
    }

    function handleMiraKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMiraMessage(); }
    }

    // Wire up all Mira button handlers via addEventListener (not onclick)
    function wireMiraHandlers() {
        const fabBtn = document.getElementById('mira-fab-btn');
        const minBtn = document.getElementById('mira-minimize-btn');
        const sendBtn = document.getElementById('mira-send-btn');
        const miraInput = document.getElementById('mira-input');

        if (fabBtn) fabBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleMiraChat();
        });
        if (minBtn) minBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            closeMiraChat();
        });
        if (sendBtn) sendBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            sendMiraMessage();
        });
        if (miraInput) {
            miraInput.addEventListener('keydown', handleMiraKeydown);
            miraInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            miraInput.addEventListener('focus', () => {
                cancelMiraAutoCollapse();
                resetMiraIdleTimer();
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', wireMiraHandlers);
    } else {
        wireMiraHandlers();
    }

    // Trigger Mira greeting: vibrate FAB, auto-open, then auto-collapse after 4s
    // If user interacts (hovers/clicks/types), cancel the auto-collapse
    let miraAutoCollapseTimer = null;

    function cancelMiraAutoCollapse() {
        if (miraAutoCollapseTimer) {
            clearTimeout(miraAutoCollapseTimer);
            miraAutoCollapseTimer = null;
        }
    }

    function triggerMiraGreeting() {
        const widget = document.getElementById('mira-widget');
        const fab = widget.querySelector('.mira-fab');
        miraState.hasGreeted = true;

        // Check if Mira should stay closed (yogi ignored her 3+ times)
        fetch('/api/mira/greeting')
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                if (data && data.suppress_greeting) return; // grumpy yogi ‚Äî stay closed

                // Cancel auto-collapse on any user interaction with the widget
                ['mouseenter', 'click', 'keydown'].forEach(evt => {
                    widget.addEventListener(evt, cancelMiraAutoCollapse, { once: false });
                });

                setTimeout(() => {
                    fab.classList.add('mira-incoming');
                    setTimeout(() => {
                        fab.classList.remove('mira-incoming');
                        openMiraChat();
                        // Auto-collapse after 4s so user sees greeting but it clears for QL panel
                        miraAutoCollapseTimer = setTimeout(() => {
                            if (miraState.isOpen) closeMiraChat();
                        }, 4000);
                    }, 1200);
                }, 800);
            })
            .catch(() => {
                // On error, still greet (fallback)
                setTimeout(() => {
                    fab.classList.add('mira-incoming');
                    setTimeout(() => {
                        fab.classList.remove('mira-incoming');
                        openMiraChat();
                        miraAutoCollapseTimer = setTimeout(() => {
                            if (miraState.isOpen) closeMiraChat();
                        }, 4000);
                    }, 1200);
                }, 800);
            });
    }

    // ============================================================
    // INIT
    // ============================================================
    async function init() {
        await loadSavedSearch();
        doSearch();
        // Fix Leaflet tile rendering ‚Äî force recalculation after layout resolves
        // The grid now has explicit height (calc(100vh-220px)) so this should work reliably
        setTimeout(() => { map.invalidateSize(); map.setView(map.getCenter()); }, 200);
        setTimeout(() => map.invalidateSize(), 1000);
        // Watch for container resize (window resize, sidebar toggle)
        if (window.ResizeObserver) {
            const mapEl = document.getElementById('search-map');
            const ro = new ResizeObserver(() => map.invalidateSize());
            ro.observe(mapEl);
            // Also watch the panels container (catches grid reflow on zoom)
            const panels = document.querySelector('.search-panels');
            if (panels) ro.observe(panels);
        }
        // Browser zoom triggers 'resize' ‚Äî Leaflet needs invalidateSize
        let _zoomTimer;
        window.addEventListener('resize', function() {
            clearTimeout(_zoomTimer);
            _zoomTimer = setTimeout(() => {
                map.invalidateSize();
                map.setView(map.getCenter());
            }, 150);
        });
        // Vibrate + open Mira
        triggerMiraGreeting();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Sidebar toggle
    window.toggleSidebar = function() {
        document.getElementById('sidebar').classList.toggle('open');
    };

    // Expose for sidebar toggle
    window.toggleMiraChat = toggleMiraChat;

    // ============================================================
    // MIRA FILTER ACTIONS ‚Äî exposed for chat response handling
    // ============================================================
    window.applyMiraFilters = function(actions) {
        if (!actions || !actions.set_filters) return;
        const filters = actions.set_filters;
        let changed = false;

        // Set domains
        if (filters.domains && Array.isArray(filters.domains)) {
            state.domains = filters.domains;
            changed = true;
        }

        // Set qualification levels
        if (filters.ql && Array.isArray(filters.ql)) {
            state.ql = filters.ql;
            changed = true;
        }

        // Set city/location
        if (filters.lat != null && filters.lon != null) {
            state.lat = filters.lat;
            state.lon = filters.lon;
            state.radius_km = filters.radius_km || 50;

            // Update city input display
            const cityInput = document.getElementById('city-search');
            if (cityInput && filters.city) {
                cityInput.value = filters.city;
            }

            // Update radius dropdown
            const radiusSelect = document.getElementById('radius-select');
            if (radiusSelect) {
                radiusSelect.value = String(state.radius_km);
            }

            // Pan map and draw circle
            map.setView([state.lat, state.lon], 10);
            updateRadiusCircle();
            changed = true;
        }

        if (changed) {
            doSearch();
            // Ensure map tiles reload after filter-driven view change
            setTimeout(() => map.invalidateSize(), 200);
        }
    };
})();
</script>
{% endblock %}
