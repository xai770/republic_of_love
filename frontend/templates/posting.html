{% extends "base.html" %}

{% block title %}Job Details - talent.yoga{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/pages/posting.css?v=20260216b">
{% endblock %}

{% block content %}

<main class="posting-page">
    <div class="posting-back">
        <a href="javascript:history.back()">‚Üê Back</a>
    </div>
    
    <div class="loading" id="loading-state">
        <div class="spinner"></div>
        <p>Loading posting details...</p>
    </div>
    
    <div class="error-state hidden" id="error-state">
        <h2>Posting Not Found</h2>
        <p>This job posting may have been removed or is no longer available.</p>
        <a href="/" class="btn btn-primary">Go Home</a>
    </div>
    
    <div class="posting-card hidden" id="posting-content">
        <header class="posting-header">
            <h1 class="posting-title" id="posting-title">Loading...</h1>
            <div class="posting-company" id="posting-company"></div>
            <div class="posting-meta">
                <span id="posting-location">üìç <span id="location-text"></span></span>
                <span id="posting-source">üîó <span id="source-text"></span></span>
                <span id="posting-date">üìÖ <span id="date-text"></span></span>
            </div>
        </header>
        
        <div class="posting-section" id="profession-section">
            <h3>Profession</h3>
            <div class="posting-tags">
                <span class="posting-tag" id="profession-tag"></span>
                <span class="posting-tag secondary" id="qual-tag"></span>
            </div>
        </div>
        
        <div class="posting-section" id="domain-section">
            <h3>Domain</h3>
            <div class="posting-tags">
                <span class="posting-tag secondary" id="domain-tag"></span>
                <span class="posting-tag secondary" id="subdomain-tag"></span>
            </div>
        </div>
        
        <div class="posting-section" id="salary-section">
            <h3>Typical Salary Range</h3>
            <p class="salary-highlight" id="salary-text"></p>
        </div>
        
        <div class="posting-section" id="summary-section">
            <h3>Summary</h3>
            <p id="summary-text"></p>
        </div>
        
        <div class="posting-section" id="description-section">
            <h3>Full Description</h3>
            <div class="posting-description" id="description-text"></div>
        </div>
        
        <div class="posting-actions">
            <a href="#" target="_blank" class="btn btn-primary" id="original-link">View Original Posting</a>
        </div>
    </div>
</main>

<script>
    const postingId = {{ posting_id }};
    
    async function loadPosting() {
        try {
            const response = await fetch(`/api/postings/detail/${postingId}`);
            
            if (!response.ok) {
                throw new Error('Posting not found');
            }
            
            const data = await response.json();
            renderPosting(data);
        } catch (error) {
            console.error('Error loading posting:', error);
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }
    }
    
    function renderPosting(data) {
        // Hide loading, show content
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('posting-content').classList.remove('hidden');
        
        // Header
        document.getElementById('posting-title').textContent = data.title || 'Untitled Position';
        document.getElementById('posting-company').textContent = data.company || 'Company not specified';
        
        // Location - deduplicate city/state (e.g., "Sonneberg, Th√ºringen, Th√ºringen" -> "Sonneberg, Th√ºringen")
        let city = data.location_city || '';
        let state = data.location_state || '';
        // If city ends with ", State" and that matches state, strip it
        if (city && state && city.toLowerCase().endsWith(', ' + state.toLowerCase())) {
            city = city.slice(0, -(state.length + 2));
        }
        // If city equals state, just use city
        const locationParts = (city && state && city.toLowerCase() === state.toLowerCase()) 
            ? [city] 
            : [city, state].filter(Boolean);
        document.getElementById('location-text').textContent = locationParts.join(', ') || 'Not specified';
        
        // Source
        document.getElementById('source-text').textContent = data.source || 'Unknown';
        
        // Date
        if (data.created_at) {
            const date = new Date(data.created_at);
            document.getElementById('date-text').textContent = date.toLocaleDateString('de-DE');
        } else {
            document.getElementById('posting-date').style.display = 'none';
        }
        
        // Profession
        if (data.profession) {
            document.getElementById('profession-tag').textContent = data.profession;
            const qualLevels = {1: 'Helper', 2: 'Professional', 3: 'Specialist', 4: 'Expert'};
            document.getElementById('qual-tag').textContent = qualLevels[data.qualification_level] || '';
            if (!data.qualification_level) {
                document.getElementById('qual-tag').style.display = 'none';
            }
        } else {
            document.getElementById('profession-section').style.display = 'none';
        }
        
        // Domain
        if (data.domain) {
            document.getElementById('domain-tag').textContent = data.domain;
            if (data.sub_domain) {
                document.getElementById('subdomain-tag').textContent = data.sub_domain;
            } else {
                document.getElementById('subdomain-tag').style.display = 'none';
            }
        } else {
            document.getElementById('domain-section').style.display = 'none';
        }
        
        // Salary
        if (data.salary_range || data.salary_median) {
            document.getElementById('salary-text').textContent = data.salary_range || 
                `~${data.salary_median.toLocaleString('de-DE')} ‚Ç¨ median`;
        } else {
            document.getElementById('salary-section').style.display = 'none';
        }
        
        // Summary
        if (data.extracted_summary) {
            document.getElementById('summary-text').textContent = data.extracted_summary;
        } else {
            document.getElementById('summary-section').style.display = 'none';
        }
        
        // Description
        if (data.job_description) {
            document.getElementById('description-text').textContent = data.job_description;
        } else {
            document.getElementById('description-section').style.display = 'none';
        }
        
        // Original link
        if (data.url) {
            document.getElementById('original-link').href = data.url;
        } else {
            document.getElementById('original-link').style.display = 'none';
        }
        
        // Update page title
        document.title = `${data.title} ‚Äî talent.yoga`;
    }
    
    // Load on page ready
    loadPosting();
</script>
{% endblock %}
