{% extends "base.html" %}

{% block title %}Messages â€” talent.yoga{% endblock %}

{% block content %}
<nav class="navbar">
    <div class="nav-brand"><a href="/dashboard">ğŸ¯ talent.yoga</a></div>
    <div class="nav-links">
        <a href="/profile" class="nav-link">Profile</a>
        <a href="/matches" class="nav-link">Matches</a>
        <a href="/messages" class="nav-link active">Messages</a>
    </div>
    <div class="nav-user">
        {% if user.avatar_url %}
        <img src="{{ user.avatar_url }}" alt="avatar" class="avatar">
        {% endif %}
        <span>{{ user.display_name or user.email }}</span>
        <a href="/auth/logout" class="logout-btn">Logout</a>
    </div>
</nav>

<main class="messages-container">
    <!-- Sidebar: Message List -->
    <aside class="message-list">
        <div class="message-list-header">
            <h2>ğŸ“¬ Messages</h2>
            <div class="unread-badge" id="total-unread">0</div>
        </div>
        
        <!-- Sender Filters -->
        <div class="sender-filters">
            <button class="sender-filter active" data-sender="all">
                All
                <span class="filter-count" id="count-all">0</span>
            </button>
            <button class="sender-filter" data-sender="doug">
                ğŸ” Doug
                <span class="filter-count" id="count-doug">0</span>
            </button>
            <button class="sender-filter" data-sender="mira">
                ğŸ’¬ Mira
                <span class="filter-count" id="count-mira">0</span>
            </button>
            <button class="sender-filter" data-sender="adele">
                ğŸ¯ Adele
                <span class="filter-count" id="count-adele">0</span>
            </button>
            <button class="sender-filter" data-sender="system">
                âš™ï¸ System
                <span class="filter-count" id="count-system">0</span>
            </button>
            <button class="sender-filter" data-sender="yogi">
                ğŸ‘¤ Yogis
                <span class="filter-count" id="count-yogi">0</span>
            </button>
        </div>
        
        <!-- Message Items -->
        <div class="message-items" id="message-items">
            <!-- Populated by JS -->
        </div>
        
        <!-- Mark All Read -->
        <div class="list-actions">
            <button class="btn-link" onclick="markAllRead()">Mark all as read</button>
        </div>
    </aside>
    
    <!-- Main: Message Detail -->
    <section class="message-detail" id="message-detail">
        <div class="empty-detail" id="empty-detail">
            <span class="empty-icon">ğŸ’¬</span>
            <p>Select a message to read</p>
        </div>
        
        <div class="message-content hidden" id="message-content">
            <div class="message-header">
                <div class="sender-avatar" id="sender-avatar">ğŸ”</div>
                <div class="sender-info">
                    <span class="sender-name" id="sender-name">Doug</span>
                    <span class="sender-role" id="sender-role">Research Assistant</span>
                </div>
                <span class="message-time" id="message-time">Just now</span>
            </div>
            
            <h2 class="message-subject" id="message-subject">Subject</h2>
            
            <div class="message-body" id="message-body">
                <!-- Rendered markdown -->
            </div>
            
            <div class="message-actions">
                <button class="btn" onclick="viewPosting()" id="view-posting-btn">
                    ğŸ“‹ View Related Posting
                </button>
                <button class="btn btn-secondary" onclick="deleteMessage()">
                    ğŸ—‘ï¸ Delete
                </button>
            </div>
        </div>
    </section>
</main>
    <!-- Styles moved to /static/css/style.css -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// State
let allMessages = [];
let currentFilter = 'all';
let currentMessageId = null;
let unreadCounts = {};

// Sender display info
const senderInfo = {
    doug: { name: 'Doug', role: 'Research Assistant', emoji: 'ğŸ”' },
    mira: { name: 'Mira', role: 'Your Guide', emoji: 'ğŸ’¬' },
    adele: { name: 'Adele', role: 'Interview Coach', emoji: 'ğŸ¯' },
    sage: { name: 'Sage', role: 'Skills Advisor', emoji: 'ğŸ“š' },
    sandy: { name: 'Sandy', role: 'Market Analyst', emoji: 'ğŸ“Š' },
    mysti: { name: 'Mysti', role: 'Encouragement', emoji: 'âœ¨' },
    system: { name: 'System', role: 'Notifications', emoji: 'âš™ï¸' },
    yogi: { name: 'Yogi', role: 'Fellow Traveler', emoji: 'ğŸ‘¤' }
};

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    // Check URL params for posting filter
    const params = new URLSearchParams(window.location.search);
    const postingId = params.get('posting');
    
    await loadMessages(postingId);
    await loadUnreadCounts();
    
    setupFilters();
    
    // Auto-select first unread or first message
    const firstUnread = allMessages.find(m => !m.is_read);
    if (firstUnread) {
        selectMessage(firstUnread.message_id);
    } else if (allMessages.length > 0) {
        selectMessage(allMessages[0].message_id);
    }
});

async function loadMessages(postingId = null) {
    try {
        let url = '/api/messages/?limit=100';
        if (postingId) {
            url += `&posting_id=${postingId}`;
        }
        
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to load messages');
        
        const data = await res.json();
        allMessages = data.messages;
        
        renderMessageList();
    } catch (err) {
        console.error('Failed to load messages:', err);
    }
}

async function loadUnreadCounts() {
    try {
        const res = await fetch('/api/messages/unread-counts');
        if (!res.ok) return;
        
        const data = await res.json();
        unreadCounts = data.by_sender;
        
        // Update badges
        document.getElementById('total-unread').textContent = data.total;
        document.getElementById('count-all').textContent = data.total;
        
        ['doug', 'mira', 'adele', 'system', 'yogi'].forEach(sender => {
            const el = document.getElementById(`count-${sender}`);
            if (el) el.textContent = unreadCounts[sender] || 0;
        });
    } catch (err) {
        console.error('Failed to load unread counts:', err);
    }
}

function setupFilters() {
    document.querySelectorAll('.sender-filter').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sender-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.sender;
            renderMessageList();
        });
    });
}

function renderMessageList() {
    const container = document.getElementById('message-items');
    
    // Filter messages
    const filtered = allMessages.filter(m => {
        if (currentFilter === 'all') return true;
        return m.sender_type === currentFilter;
    });
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="no-messages">
                <span class="empty-icon">ğŸ“­</span>
                <p>No messages yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filtered.map(m => {
        const info = senderInfo[m.sender_type] || senderInfo.system;
        const isActive = m.message_id === currentMessageId;
        const isUnread = !m.is_read;
        const time = formatTime(m.created_at);
        
        return `
            <div class="message-item ${isActive ? 'active' : ''} ${isUnread ? 'unread' : ''}" 
                 onclick="selectMessage(${m.message_id})">
                <div class="item-avatar ${m.sender_type}">${info.emoji}</div>
                <div class="item-content">
                    <div class="item-header">
                        <span class="item-sender">${info.name}</span>
                        <span class="item-time">${time}</span>
                    </div>
                    <div class="item-subject">${escapeHtml(m.subject || 'No subject')}</div>
                    <div class="item-preview">${escapeHtml(m.preview)}</div>
                </div>
            </div>
        `;
    }).join('');
}

async function selectMessage(messageId) {
    currentMessageId = messageId;
    
    // Update list selection
    document.querySelectorAll('.message-item').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`.message-item[onclick="selectMessage(${messageId})"]`);
    if (activeItem) {
        activeItem.classList.add('active');
        activeItem.classList.remove('unread');
    }
    
    // Fetch full message (auto-marks as read)
    try {
        const res = await fetch(`/api/messages/${messageId}`);
        if (!res.ok) throw new Error('Failed to load message');
        
        const msg = await res.json();
        renderMessageDetail(msg);
        
        // Update local state
        const localMsg = allMessages.find(m => m.message_id === messageId);
        if (localMsg) localMsg.is_read = true;
        
        // Refresh unread counts
        loadUnreadCounts();
    } catch (err) {
        console.error('Failed to load message:', err);
    }
}

function renderMessageDetail(msg) {
    document.getElementById('empty-detail').classList.add('hidden');
    document.getElementById('message-content').classList.remove('hidden');
    
    const info = senderInfo[msg.sender_type] || senderInfo.system;
    
    document.getElementById('sender-avatar').textContent = info.emoji;
    document.getElementById('sender-avatar').className = `sender-avatar ${msg.sender_type}`;
    document.getElementById('sender-name').textContent = info.name;
    document.getElementById('sender-role').textContent = info.role;
    document.getElementById('message-time').textContent = formatTime(msg.created_at);
    document.getElementById('message-subject').textContent = msg.subject || 'No subject';
    
    // Render markdown body
    document.getElementById('message-body').innerHTML = marked.parse(msg.body);
    
    // Show/hide posting button
    const postingBtn = document.getElementById('view-posting-btn');
    if (msg.posting_id) {
        postingBtn.classList.remove('hidden');
        postingBtn.onclick = () => window.location.href = `/matches?posting=${msg.posting_id}`;
    } else {
        postingBtn.classList.add('hidden');
    }
    
    // Store for delete
    window.currentMessage = msg;
}

async function deleteMessage() {
    if (!window.currentMessage) return;
    
    if (!confirm('Delete this message?')) return;
    
    try {
        const res = await fetch(`/api/messages/${window.currentMessage.message_id}`, {
            method: 'DELETE'
        });
        if (!res.ok) throw new Error('Failed to delete');
        
        // Remove from local state
        allMessages = allMessages.filter(m => m.message_id !== window.currentMessage.message_id);
        currentMessageId = null;
        
        // Clear detail view
        document.getElementById('empty-detail').classList.remove('hidden');
        document.getElementById('message-content').classList.add('hidden');
        
        renderMessageList();
        loadUnreadCounts();
    } catch (err) {
        console.error('Failed to delete message:', err);
    }
}

async function markAllRead() {
    try {
        const url = currentFilter === 'all' 
            ? '/api/messages/mark-all-read'
            : `/api/messages/mark-all-read?sender_type=${currentFilter}`;
        
        const res = await fetch(url, { method: 'POST' });
        if (!res.ok) throw new Error('Failed to mark all read');
        
        // Update local state
        allMessages.forEach(m => {
            if (currentFilter === 'all' || m.sender_type === currentFilter) {
                m.is_read = true;
            }
        });
        
        renderMessageList();
        loadUnreadCounts();
    } catch (err) {
        console.error('Failed to mark all read:', err);
    }
}

function formatTime(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diff = now - date;
    
    // Today
    if (diff < 24 * 60 * 60 * 1000 && date.getDate() === now.getDate()) {
        return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Yesterday
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.getDate() === yesterday.getDate()) {
        return 'Yesterday';
    }
    
    // This week
    if (diff < 7 * 24 * 60 * 60 * 1000) {
        return date.toLocaleDateString('de-DE', { weekday: 'short' });
    }
    
    // Older
    return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short' });
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>
{% endblock %}
