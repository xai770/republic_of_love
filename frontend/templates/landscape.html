{% extends "base.html" %}

{% block title %}{{ t('nav.landscape') if t('nav.landscape') != 'nav.landscape' else 'Opportunity Landscape' }} â€” talent.yoga{% endblock %}

{% block extra_head %}
<style>
/* â”€â”€ Landscape page layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.landscape-page {
    padding: 1.5rem 2rem;
    max-width: 1200px;
    margin: 0 auto;
}
.landscape-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}
.landscape-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a202c;
}
.landscape-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}
.landscape-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
    color: #2d3748;
    min-width: 180px;
    cursor: pointer;
}
.landscape-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 2px rgba(66,153,225,0.2);
}

/* â”€â”€ Narrative banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.landscape-narrative {
    background: linear-gradient(135deg, #ebf8ff, #e6fffa);
    border: 1px solid #bee3f8;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
    color: #2a4365;
    line-height: 1.5;
    min-height: 2.5rem;
}
.landscape-narrative.loading {
    opacity: 0.5;
}

/* â”€â”€ Grid layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.landscape-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
}
@media (max-width: 900px) {
    .landscape-grid { grid-template-columns: 1fr; }
}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.landscape-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.landscape-card-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
}
.landscape-card-title .emoji {
    margin-right: 0.4rem;
}

/* â”€â”€ Regional comparison bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.region-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.region-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0;
    border-bottom: 1px solid #f7fafc;
    font-size: 0.875rem;
}
.region-item:last-child { border-bottom: none; }
.region-item.highlight {
    background: #fffff0;
    border-radius: 6px;
    padding: 0.4rem 0.5rem;
    margin: 0 -0.5rem;
    border-bottom: 1px solid #fefcbf;
}
.region-emoji { width: 1.5rem; text-align: center; flex-shrink: 0; }
.region-name { flex: 1; color: #2d3748; }
.region-count { color: #718096; font-size: 0.8rem; min-width: 3rem; text-align: right; }
.region-bar-wrap {
    width: 100px;
    height: 8px;
    background: #edf2f7;
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
}
.region-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.4s ease;
}
.region-bar.very_high { background: #e53e3e; }
.region-bar.high { background: #ed8936; }
.region-bar.stable { background: #48bb78; }
.region-bar.low { background: #a0aec0; }
.region-bar.very_low { background: #cbd5e0; }
.region-ratio {
    font-weight: 600;
    font-size: 0.8rem;
    min-width: 3rem;
    text-align: right;
}

/* â”€â”€ Top professions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prof-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.prof-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0;
    border-bottom: 1px solid #f7fafc;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.15s;
}
.prof-item:hover {
    background: #f7fafc;
    border-radius: 6px;
}
.prof-item:last-child { border-bottom: none; }
.prof-name { flex: 1; color: #2d3748; }
.prof-count { color: #718096; font-size: 0.8rem; }
.prof-badge {
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-weight: 600;
}
.prof-badge.very_high { background: #fed7d7; color: #c53030; }
.prof-badge.high { background: #feebc8; color: #c05621; }
.prof-badge.stable { background: #c6f6d5; color: #276749; }
.prof-badge.low { background: #edf2f7; color: #718096; }
.prof-badge.very_low { background: #f7fafc; color: #a0aec0; }

/* â”€â”€ Related professions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.related-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.related-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f7fafc;
    font-size: 0.875rem;
}
.related-item:last-child { border-bottom: none; }
.related-name { flex: 1; color: #2d3748; }
.related-sim {
    font-size: 0.75rem;
    color: #a0aec0;
    min-width: 3rem;
    text-align: right;
}
.related-demand {
    min-width: 5rem;
    text-align: right;
}

/* â”€â”€ Activity sparkline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.activity-chart {
    width: 100%;
    height: 80px;
    margin-top: 0.5rem;
}
.activity-bar-container {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 80px;
    width: 100%;
}
.activity-bar {
    flex: 1;
    background: #4299e1;
    border-radius: 2px 2px 0 0;
    min-width: 4px;
    transition: height 0.3s ease;
    position: relative;
}
.activity-bar:hover {
    background: #2b6cb0;
}
.activity-bar:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #2d3748;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    white-space: nowrap;
    pointer-events: none;
}
.activity-total {
    text-align: center;
    font-size: 0.8rem;
    color: #718096;
    margin-top: 0.5rem;
}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.landscape-empty {
    text-align: center;
    padding: 2rem;
    color: #a0aec0;
    font-size: 0.9rem;
}

/* â”€â”€ Loading state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.landscape-loading {
    text-align: center;
    padding: 1rem;
    color: #a0aec0;
}

/* â”€â”€ DARK MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-theme="dark"] .landscape-title { color: #e2e8f0; }
[data-theme="dark"] .landscape-select {
    background: #2d3748; color: #e2e8f0; border-color: #4a5568;
}
[data-theme="dark"] .landscape-narrative {
    background: linear-gradient(135deg, #1a365d, #234e52);
    border-color: #2a4365; color: #bee3f8;
}
[data-theme="dark"] .landscape-card {
    background: #2d3748; border-color: #4a5568;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
[data-theme="dark"] .landscape-card-title { color: #a0aec0; }
[data-theme="dark"] .region-item { border-color: #4a5568; }
[data-theme="dark"] .region-item.highlight {
    background: #2d3748; border-color: #4a5568;
}
[data-theme="dark"] .region-name { color: #e2e8f0; }
[data-theme="dark"] .region-count { color: #a0aec0; }
[data-theme="dark"] .region-bar-wrap { background: #4a5568; }
[data-theme="dark"] .prof-item { border-color: #4a5568; }
[data-theme="dark"] .prof-item:hover { background: #4a5568; }
[data-theme="dark"] .prof-name { color: #e2e8f0; }
[data-theme="dark"] .related-item { border-color: #4a5568; }
[data-theme="dark"] .related-name { color: #e2e8f0; }
[data-theme="dark"] .activity-bar { background: #4299e1; }
[data-theme="dark"] .activity-bar:hover { background: #63b3ed; }
</style>
{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}
    {% set active_page = 'landscape' %}
    {% include "partials/sidebar.html" %}

    <main class="main-content landscape-page">

        <!-- Header -->
        <div class="landscape-header">
            <h1 class="landscape-title">ğŸ—ºï¸ Opportunity Landscape</h1>
            <div class="landscape-controls">
                <select id="ls-domain" class="landscape-select" title="Berufsfeld">
                    <option value="">â€” Berufsfeld wÃ¤hlen â€”</option>
                    {% for name, info in domains %}
                    <option value="{{ info.codes | join(',') }}" data-name="{{ name }}">
                        {{ name }} ({{ '{:,}'.format(info.total) }})
                    </option>
                    {% endfor %}
                </select>
                <select id="ls-state" class="landscape-select" title="Bundesland">
                    <option value="">â€” Alle BundeslÃ¤nder â€”</option>
                    {% for state in states %}
                    <option value="{{ state }}">{{ state }}</option>
                    {% endfor %}
                </select>
                <select id="ls-profession" class="landscape-select" title="Beruf" style="display:none">
                    <option value="">â€” Alle Berufe â€”</option>
                </select>
            </div>
        </div>

        <!-- Narrative -->
        <div class="landscape-narrative" id="ls-narrative">
            WÃ¤hlen Sie ein Berufsfeld, um die regionale Marktanalyse zu starten.
        </div>

        <!-- Main grid -->
        <div class="landscape-grid">

            <!-- Regional Comparison -->
            <div class="landscape-card" id="ls-card-regional">
                <div class="landscape-card-title"><span class="emoji">ğŸ“Š</span>Regionale Nachfrage</div>
                <ul class="region-list" id="ls-regions">
                    <li class="landscape-empty">Berufsfeld wÃ¤hlenâ€¦</li>
                </ul>
            </div>

            <!-- Activity Chart -->
            <div class="landscape-card" id="ls-card-activity">
                <div class="landscape-card-title"><span class="emoji">ğŸ“ˆ</span>14-Tage AktivitÃ¤t</div>
                <div class="activity-chart" id="ls-activity">
                    <div class="landscape-empty">Berufsfeld wÃ¤hlenâ€¦</div>
                </div>
                <div class="activity-total" id="ls-activity-total"></div>
            </div>

            <!-- Top Professions -->
            <div class="landscape-card" id="ls-card-professions">
                <div class="landscape-card-title"><span class="emoji">ğŸ†</span>Top Berufe im Feld</div>
                <ul class="prof-list" id="ls-professions">
                    <li class="landscape-empty">Berufsfeld wÃ¤hlenâ€¦</li>
                </ul>
            </div>

            <!-- Related Professions -->
            <div class="landscape-card" id="ls-card-related" style="display:none">
                <div class="landscape-card-title"><span class="emoji">ğŸ”—</span>Verwandte Berufe</div>
                <ul class="related-list" id="ls-related">
                </ul>
            </div>

        </div>
    </main>
</div>

<script>
(function() {
    const domainSel = document.getElementById('ls-domain');
    const stateSel  = document.getElementById('ls-state');
    const profSel   = document.getElementById('ls-profession');
    const narrative  = document.getElementById('ls-narrative');
    const regionsEl  = document.getElementById('ls-regions');
    const activityEl = document.getElementById('ls-activity');
    const actTotalEl = document.getElementById('ls-activity-total');
    const profsEl    = document.getElementById('ls-professions');
    const relatedEl  = document.getElementById('ls-related');
    const relatedCard = document.getElementById('ls-card-related');

    let currentData = null;

    // â”€â”€ Fetch overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadOverview() {
        const domainVal = domainSel.value;
        if (!domainVal) return;

        // Use first domain code from the comma-separated list
        const domainCode = domainVal.split(',')[0];
        const state = stateSel.value || null;
        const profId = profSel.value ? parseInt(profSel.value) : null;

        narrative.classList.add('loading');
        narrative.textContent = 'Lade Marktdatenâ€¦';

        try {
            const resp = await fetch('/api/intelligence/overview', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    domain_code: domainCode,
                    berufenet_id: profId,
                    location_state: state,
                }),
            });

            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            currentData = await resp.json();
            renderAll(currentData);
        } catch (err) {
            narrative.textContent = 'Fehler beim Laden der Daten.';
            narrative.classList.remove('loading');
            console.error('Intelligence error:', err);
        }
    }

    // â”€â”€ Render all panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAll(data) {
        narrative.textContent = data.narrative;
        narrative.classList.remove('loading');

        renderRegions(data.regions);
        renderActivity(data.activity);
        renderProfessions(data.top_professions);

        // Populate profession dropdown from top_professions
        if (!profSel.dataset.populated || profSel.dataset.domain !== domainSel.value) {
            profSel.innerHTML = '<option value="">â€” Alle Berufe â€”</option>';
            for (const p of data.top_professions) {
                const opt = document.createElement('option');
                opt.value = p.berufenet_id;
                opt.textContent = `${p.name} (${p.total})`;
                profSel.appendChild(opt);
            }
            profSel.style.display = '';
            profSel.dataset.populated = '1';
            profSel.dataset.domain = domainSel.value;
        }

        // Related professions
        if (data.related && data.related.length > 0) {
            relatedCard.style.display = '';
            renderRelated(data.related);
        } else {
            relatedCard.style.display = 'none';
        }
    }

    // â”€â”€ Render regional bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRegions(regions) {
        if (!regions || regions.length === 0) {
            regionsEl.innerHTML = '<li class="landscape-empty">Keine Regionaldaten.</li>';
            return;
        }
        const maxRatio = Math.max(...regions.map(r => r.ratio), 1);
        regionsEl.innerHTML = regions.map(r => {
            const pct = Math.round((r.ratio / maxRatio) * 100);
            const hl = r.is_user_region ? ' highlight' : '';
            return `
                <li class="region-item${hl}">
                    <span class="region-emoji">${r.emoji}</span>
                    <span class="region-name">${r.state}</span>
                    <span class="region-count">${r.total.toLocaleString('de-DE')}</span>
                    <span class="region-bar-wrap">
                        <div class="region-bar ${r.level}" style="width:${pct}%"></div>
                    </span>
                    <span class="region-ratio">${r.ratio}Ã—</span>
                </li>
            `;
        }).join('');
    }

    // â”€â”€ Render activity bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderActivity(days) {
        if (!days || days.length === 0) {
            activityEl.innerHTML = '<div class="landscape-empty">Keine AktivitÃ¤tsdaten.</div>';
            actTotalEl.textContent = '';
            return;
        }
        const max = Math.max(...days.map(d => d.count), 1);
        const total = days.reduce((s, d) => s + d.count, 0);
        activityEl.innerHTML = `
            <div class="activity-bar-container">
                ${days.map(d => {
                    const h = Math.max(Math.round((d.count / max) * 76), 2);
                    const dateLabel = d.date.slice(5); // MM-DD
                    return `<div class="activity-bar" style="height:${h}px"
                                data-tooltip="${dateLabel}: ${d.count}"></div>`;
                }).join('')}
            </div>
        `;
        actTotalEl.textContent = `${total.toLocaleString('de-DE')} neue Stellenanzeigen in 14 Tagen`;
    }

    // â”€â”€ Render top professions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderProfessions(profs) {
        if (!profs || profs.length === 0) {
            profsEl.innerHTML = '<li class="landscape-empty">Keine Berufsdaten.</li>';
            return;
        }
        profsEl.innerHTML = profs.map(p => `
            <li class="prof-item" data-id="${p.berufenet_id}" onclick="selectProfession(${p.berufenet_id})">
                <span class="prof-name">${p.name}</span>
                <span class="prof-count">${p.total.toLocaleString('de-DE')}</span>
                <span class="prof-badge ${p.level}">${p.emoji} ${p.label}</span>
            </li>
        `).join('');
    }

    // â”€â”€ Render related professions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRelated(related) {
        if (!related || related.length === 0) {
            relatedEl.innerHTML = '<li class="landscape-empty">Keine verwandten Berufe.</li>';
            return;
        }
        relatedEl.innerHTML = related.map(r => {
            const demandHtml = r.demand
                ? `<span class="prof-badge ${r.demand.level}">${r.demand.emoji} ${r.demand.ratio}Ã—</span>`
                : '<span class="related-sim" style="color:#cbd5e0">â€”</span>';
            const salaryHtml = r.salary_median && r.salary_median > 0
                ? `<span class="related-sim">â‚¬${r.salary_median.toLocaleString('de-DE')}</span>`
                : '';
            return `
                <li class="related-item">
                    <span class="related-name">${r.name}</span>
                    ${salaryHtml}
                    <span class="related-sim">${Math.round(r.similarity * 100)}%</span>
                    <span class="related-demand">${demandHtml}</span>
                </li>
            `;
        }).join('');
    }

    // â”€â”€ Profession click handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.selectProfession = function(id) {
        profSel.value = id;
        loadOverview();
    };

    // â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    domainSel.addEventListener('change', () => {
        profSel.value = '';
        profSel.dataset.populated = '';
        loadOverview();
    });
    stateSel.addEventListener('change', loadOverview);
    profSel.addEventListener('change', loadOverview);

})();
</script>
{% endblock %}
