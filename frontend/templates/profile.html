{% extends "base.html" %}

{% block title %}Profil â€” talent.yoga{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE BUILDER â€” Split-pane layout
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.profile-builder {
    display: flex;
    height: calc(100vh - 80px);
    overflow: hidden;
}

/* â”€â”€ LEFT PANE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pb-left {
    width: 50%;
    min-width: 360px;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    background: var(--bg);
}

/* Tab bar */
.pb-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--card-bg);
    flex-shrink: 0;
}

.pb-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.75rem 0.5rem;
    border: none;
    background: none;
    color: var(--text-muted);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
}

.pb-tab:hover {
    color: var(--text);
    background: var(--bg);
}

.pb-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.pb-tab-icon { font-size: 1.1rem; }

/* Activity log (always visible, fills available space) */
.pb-log {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.pb-log-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    text-align: center;
    gap: 1rem;
    padding: 2rem;
}

.pb-log-empty-icon { font-size: 3rem; }

/* Log entries */
.pb-log-entry {
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    max-width: 90%;
    line-height: 1.45;
    font-size: 0.9rem;
    word-wrap: break-word;
}

.pb-log-entry.yogi {
    align-self: flex-end;
    background: var(--primary);
    color: #fff;
    border-bottom-right-radius: 0.15rem;
}

.pb-log-entry.adele {
    align-self: flex-start;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-bottom-left-radius: 0.15rem;
}

.pb-log-entry.adele .adele-label {
    font-weight: 600;
    color: var(--primary);
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
}

.pb-log-entry.system {
    align-self: center;
    background: none;
    color: var(--text-muted);
    font-size: 0.8rem;
    padding: 0.3rem 0;
    text-align: center;
    max-width: 100%;
}

.pb-log-entry.system .sys-icon { margin-right: 0.3rem; }

/* Input area (bottom of left pane) */
.pb-input-area {
    flex-shrink: 0;
    border-top: 1px solid var(--border);
    background: var(--card-bg);
}

/* Chat input */
.pb-chat-input {
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
}

.pb-chat-input textarea {
    flex: 1;
    resize: none;
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    padding: 0.6rem 0.9rem;
    font-size: 0.9rem;
    font-family: inherit;
    line-height: 1.4;
    max-height: 120px;
    min-height: 40px;
    background: var(--bg);
    color: var(--text);
}

.pb-chat-input textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.pb-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: var(--primary);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.15s;
}

.pb-send-btn:hover { opacity: 0.85; }
.pb-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* Upload input */
.pb-upload-area {
    padding: 1.5rem;
    display: none;
}

.pb-upload-area.active { display: block; }

.pb-dropzone {
    border: 2px dashed var(--border);
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.pb-dropzone:hover, .pb-dropzone.drag-over {
    border-color: var(--primary);
    background: rgba(37, 99, 235, 0.04);
}

.pb-dropzone-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }

.pb-dropzone p {
    margin: 0.25rem 0;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.pb-upload-status {
    display: none;
    text-align: center;
    padding: 1rem;
    color: var(--text-muted);
}

/* Form input */
.pb-form-area {
    padding: 1rem;
    display: none;
    overflow-y: auto;
    max-height: 45vh;
}

.pb-form-area.active { display: block; }

.pb-form-section { margin-bottom: 1rem; }

.pb-form-section h3 {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

.pb-form-row { margin-bottom: 0.75rem; }

.pb-form-row label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 0.2rem;
}

.pb-form-row input,
.pb-form-row select,
.pb-form-row textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    font-size: 0.9rem;
    background: var(--bg);
    color: var(--text);
    box-sizing: border-box;
}

.pb-form-row input:focus,
.pb-form-row select:focus,
.pb-form-row textarea:focus {
    border-color: var(--primary);
    outline: none;
}

.pb-form-row small {
    color: var(--text-muted);
    font-size: 0.75rem;
}

.pb-form-half {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

.pb-form-btn {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 0.375rem;
    background: var(--primary);
    color: #fff;
    font-size: 0.9rem;
    cursor: pointer;
    margin-top: 0.5rem;
}

.pb-form-btn:hover { opacity: 0.9; }

/* â”€â”€ RIGHT PANE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pb-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--card-bg);
    min-width: 360px;
}

.pb-right-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

.pb-right-header h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.pb-right-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.pb-completeness {
    font-size: 0.8rem;
    color: var(--text-muted);
    background: var(--bg);
    padding: 0.2rem 0.6rem;
    border-radius: 1rem;
}

.pb-download-btn {
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    background: none;
    color: var(--text);
    padding: 0.3rem 0.7rem;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.pb-download-btn:hover {
    background: var(--bg);
    border-color: var(--primary);
}

/* Markdown preview */
.pb-preview {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem 2rem;
}

.pb-preview-content {
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.65;
    font-size: 0.95rem;
}

.pb-preview-content h1 {
    font-size: 1.6rem;
    margin-bottom: 0.1rem;
    border-bottom: none;
}

.pb-preview-content h1 + p {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin-bottom: 1.2rem;
}

.pb-preview-content h2 {
    font-size: 1.15rem;
    margin-top: 1.8rem;
    margin-bottom: 0.7rem;
    padding-bottom: 0.3rem;
    border-bottom: 1px solid var(--border);
}

.pb-preview-content h3 {
    font-size: 1rem;
    margin-top: 1rem;
    margin-bottom: 0.2rem;
}

.pb-preview-content h3 + p em {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.pb-preview-content blockquote {
    border-left: 3px solid var(--primary);
    margin: 0 0 1rem 0;
    padding: 0.5rem 1rem;
    background: rgba(37, 99, 235, 0.04);
    border-radius: 0 0.375rem 0.375rem 0;
    color: var(--text-muted);
    font-style: italic;
}

.pb-preview-content ul, .pb-preview-content ol {
    padding-left: 1.25rem;
}

.pb-preview-content li { margin-bottom: 0.3rem; }

/* Highlight animation */
@keyframes pb-highlight {
    0% { background: rgba(37, 99, 235, 0.15); }
    100% { background: transparent; }
}

.pb-highlight { animation: pb-highlight 2s ease-out; }

/* Empty right pane */
.pb-preview-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    text-align: center;
    gap: 1rem;
    padding: 2rem;
}

.pb-preview-empty-icon { font-size: 4rem; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 900px) {
    .profile-builder { flex-direction: column; height: auto; }
    .pb-left, .pb-right { width: 100%; min-width: 0; border-right: none; }
    .pb-left { border-bottom: 1px solid var(--border); max-height: 60vh; }
    .pb-right { min-height: 50vh; }
}

/* â”€â”€ Dark mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-theme="dark"] .pb-log-entry.adele { background: var(--bg); }
[data-theme="dark"] .pb-preview-content blockquote { background: rgba(37, 99, 235, 0.08); }
[data-theme="dark"] .pb-dropzone:hover,
[data-theme="dark"] .pb-dropzone.drag-over { background: rgba(37, 99, 235, 0.08); }
</style>
{% endblock %}

{% block content %}
<div class="app-layout">
    {% include "partials/header.html" %}
    
    {% set active_page = 'profile' %}
    {% include "partials/sidebar.html" %}
    
    <main class="main-content" style="padding:0; padding-bottom:0; max-width:none; overflow:hidden;">
    <div class="profile-builder">
        
        <!-- â•â•â• LEFT PANE â•â•â• -->
        <div class="pb-left">
            <!-- Tab bar -->
            <div class="pb-tabs">
                <button class="pb-tab active" data-tab="chat" onclick="switchTab('chat')">
                    <span class="pb-tab-icon">ğŸ™ï¸</span> Adele
                </button>
                <button class="pb-tab" data-tab="upload" onclick="switchTab('upload')">
                    <span class="pb-tab-icon">ğŸ“„</span> Upload
                </button>
                <button class="pb-tab" data-tab="form" onclick="switchTab('form')">
                    <span class="pb-tab-icon">ğŸ“</span> Formular
                </button>
            </div>

            <!-- Activity log (always visible) -->
            <div class="pb-log" id="pb-log">
                <div class="pb-log-empty" id="pb-log-empty">
                    <div class="pb-log-empty-icon">ğŸ™ï¸</div>
                    <div>
                        <strong>Willkommen beim Profil-Builder!</strong><br>
                        Sprich mit Adele, lade deinen Lebenslauf hoch, oder fÃ¼lle das Formular aus.
                    </div>
                </div>
            </div>

            <!-- Input area â€” changes per tab -->
            <div class="pb-input-area">
                <!-- Chat input (default) -->
                <div class="pb-chat-input" id="pb-input-chat">
                    <textarea id="pb-chat-text" rows="1" placeholder="Schreib Adele..."
                              onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendToAdele()}"
                              oninput="autoResize(this)"></textarea>
                    <button class="pb-send-btn" onclick="sendToAdele()" id="pb-send-btn" title="Senden">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>

                <!-- Upload input -->
                <div class="pb-upload-area" id="pb-input-upload">
                    <div class="pb-dropzone" id="pb-dropzone"
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         onclick="document.getElementById('pb-file-input').click()">
                        <div class="pb-dropzone-icon">ğŸ“„</div>
                        <p><strong>Lebenslauf hierher ziehen</strong></p>
                        <p>oder klicken zum AuswÃ¤hlen</p>
                        <p style="font-size:0.8rem; color:var(--text-muted)">PDF, DOCX, TXT</p>
                    </div>
                    <input type="file" id="pb-file-input" accept=".pdf,.docx,.doc,.txt"
                           onchange="handleFileSelect(event)" hidden>
                    <div class="pb-upload-status" id="pb-upload-status">
                        <div class="spinner"></div>
                        <p>Lebenslauf wird analysiert...</p>
                    </div>
                </div>

                <!-- Form input -->
                <div class="pb-form-area" id="pb-input-form">
                    <div class="pb-form-section">
                        <h3>IdentitÃ¤t</h3>
                        <div class="pb-form-row">
                            <label>Yogi-Name (Ã¶ffentliches Pseudonym)</label>
                            <input type="text" id="pf-yogi-name" placeholder="z.B. Phoenix, Lotus, Stardust" maxlength="30">
                            <small>Dein Anzeigename auf der Plattform â€” darf nicht dein echter Name sein</small>
                        </div>
                    </div>
                    <div class="pb-form-section">
                        <h3>Basisdaten</h3>
                        <div class="pb-form-row">
                            <label>Aktuelle Position</label>
                            <input type="text" id="pf-title" placeholder="z.B. Gesundheits- und Krankenpfleger">
                        </div>
                        <div class="pb-form-row">
                            <label>Standort</label>
                            <input type="text" id="pf-location" placeholder="z.B. Frankfurt am Main">
                        </div>
                    </div>
                    <div class="pb-form-section">
                        <h3>SuchprÃ¤ferenzen</h3>
                        <div class="pb-form-row">
                            <label>Wunschrollen</label>
                            <input type="text" id="pf-roles" placeholder="z.B. Teamleitung, Stationsleitung">
                            <small>Komma-getrennt</small>
                        </div>
                        <div class="pb-form-row">
                            <label>Wunschorte</label>
                            <input type="text" id="pf-locations" placeholder="z.B. Frankfurt, MÃ¼nchen, Remote">
                            <small>Komma-getrennt</small>
                        </div>
                        <div class="pb-form-half">
                            <div class="pb-form-row">
                                <label>Gehalt min (â‚¬)</label>
                                <input type="number" id="pf-salary-min" step="1000" placeholder="z.B. 45000">
                            </div>
                            <div class="pb-form-row">
                                <label>Gehalt max (â‚¬)</label>
                                <input type="number" id="pf-salary-max" step="1000" placeholder="z.B. 65000">
                            </div>
                        </div>
                        <div class="pb-form-row">
                            <label>Mindestlevel</label>
                            <select id="pf-seniority">
                                <option value="">Egal</option>
                                <option value="junior">Junior / Einsteiger</option>
                                <option value="mid">Mid-level</option>
                                <option value="senior">Senior</option>
                                <option value="lead">Lead / Leitung</option>
                            </select>
                        </div>
                    </div>
                    <button class="pb-form-btn" onclick="saveFormData()">ğŸ’¾ Speichern</button>
                </div>
            </div>
        </div>

        <!-- â•â•â• RIGHT PANE â•â•â• -->
        <div class="pb-right">
            <div class="pb-right-header">
                <h2>ğŸ“‹ Profil</h2>
                <div class="pb-right-actions">
                    <span class="pb-completeness" id="pb-completeness">0%</span>
                    <button class="pb-download-btn" onclick="downloadProfile()" title="Als Markdown herunterladen">
                        â¬‡ Download
                    </button>
                </div>
            </div>
            <div class="pb-preview" id="pb-preview">
                <div class="pb-preview-content" id="pb-preview-content">
                    <div class="pb-preview-empty" id="pb-preview-empty">
                        <div class="pb-preview-empty-icon">ğŸ“‹</div>
                        <div>
                            <strong>Dein Profil erscheint hier</strong><br>
                            Sobald du Daten eingibst, baut sich dein Profil-Dokument live auf.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE BUILDER â€” Frontend Logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentTab = 'chat';
let profileMarkdown = '';

// â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.pb-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
    });
    document.getElementById('pb-input-chat').style.display = tab === 'chat' ? 'flex' : 'none';
    document.getElementById('pb-input-upload').style.display = tab === 'upload' ? 'block' : 'none';
    document.getElementById('pb-input-upload').classList.toggle('active', tab === 'upload');
    document.getElementById('pb-input-form').style.display = tab === 'form' ? 'block' : 'none';
    document.getElementById('pb-input-form').classList.toggle('active', tab === 'form');
    if (tab === 'chat') document.getElementById('pb-chat-text').focus();
}

// â”€â”€ AUTO-RESIZE TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

// â”€â”€ ACTIVITY LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addLogEntry(type, text, sender) {
    const log = document.getElementById('pb-log');
    const empty = document.getElementById('pb-log-empty');
    if (empty) empty.remove();

    const entry = document.createElement('div');
    entry.className = 'pb-log-entry ' + type;

    if (type === 'adele') {
        entry.innerHTML = '<div class="adele-label">Adele</div>' + formatLogText(text);
    } else if (type === 'system') {
        const icon = sender === 'cv_upload' ? 'ğŸ“„' : sender === 'form_edit' ? 'ğŸ“' : sender === 'cv_import' ? 'ğŸ“¥' : 'â„¹ï¸';
        entry.innerHTML = '<span class="sys-icon">' + icon + '</span>' + text;
    } else {
        entry.textContent = text;
    }

    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function formatLogText(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

// â”€â”€ LOAD EXISTING DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadActivityLog() {
    try {
        const res = await fetch('/api/profiles/me/activity-log');
        if (!res.ok) return;
        const entries = await res.json();
        if (entries.length === 0) return;

        const empty = document.getElementById('pb-log-empty');
        if (empty) empty.remove();

        entries.forEach(e => {
            if (e.sender === 'yogi') {
                addLogEntry('yogi', e.body);
            } else if (e.sender === 'adele') {
                addLogEntry('adele', e.body);
            } else if (e.sender === 'system') {
                addLogEntry('system', e.body, e.type);
            }
        });
    } catch (err) {
        console.warn('Failed to load activity log:', err);
    }
}

async function loadProfile() {
    try {
        const res = await fetch('/api/profiles/me/markdown');
        if (!res.ok) return;
        const data = await res.json();
        profileMarkdown = data.markdown;
        renderProfile(data.markdown, data.completeness);
        loadFormDefaults();
    } catch (err) {
        console.warn('Failed to load profile:', err);
    }
}

function renderProfile(md, completeness) {
    const container = document.getElementById('pb-preview-content');
    const emptyEl = document.getElementById('pb-preview-empty');

    if (!md || md.startsWith('_Noch kein')) {
        if (emptyEl) emptyEl.style.display = 'flex';
        return;
    }

    if (emptyEl) emptyEl.style.display = 'none';
    container.innerHTML = marked.parse(md);
    document.getElementById('pb-completeness').textContent = completeness + '%';
    profileMarkdown = md;
}

async function loadFormDefaults() {
    try {
        const res = await fetch('/api/profiles/me');
        if (!res.ok) return;
        const p = await res.json();
        if (p.display_name) document.getElementById('pf-yogi-name').value = p.display_name;
        if (p.title) document.getElementById('pf-title').value = p.title;
        if (p.location) document.getElementById('pf-location').value = p.location;
        if (p.desired_roles && p.desired_roles.length) document.getElementById('pf-roles').value = p.desired_roles.join(', ');
        if (p.desired_locations && p.desired_locations.length) document.getElementById('pf-locations').value = p.desired_locations.join(', ');
        if (p.expected_salary_min) document.getElementById('pf-salary-min').value = p.expected_salary_min;
        if (p.expected_salary_max) document.getElementById('pf-salary-max').value = p.expected_salary_max;
        if (p.min_seniority) document.getElementById('pf-seniority').value = p.min_seniority;
    } catch(e) {}
}

// â”€â”€ ADELE CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function sendToAdele() {
    const input = document.getElementById('pb-chat-text');
    const text = input.value.trim();
    if (!text) return;

    addLogEntry('yogi', text);
    input.value = '';
    autoResize(input);

    const btn = document.getElementById('pb-send-btn');
    btn.disabled = true;

    try {
        const res = await fetch('/api/adele/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: text })
        });
        if (!res.ok) throw new Error('Chat failed');
        const data = await res.json();
        addLogEntry('adele', data.reply);
        setTimeout(refreshProfile, 500);
    } catch (err) {
        addLogEntry('system', 'Fehler bei der Kommunikation mit Adele.', 'error');
    } finally {
        btn.disabled = false;
        input.focus();
    }
}

async function refreshProfile() {
    try {
        const res = await fetch('/api/profiles/me/markdown');
        if (!res.ok) return;
        const data = await res.json();
        const oldMd = profileMarkdown;
        renderProfile(data.markdown, data.completeness);
        if (oldMd !== data.markdown) {
            const el = document.getElementById('pb-preview-content');
            el.classList.add('pb-highlight');
            setTimeout(() => el.classList.remove('pb-highlight'), 2000);
        }
    } catch(e) {}
}

// â”€â”€ CV UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('pb-dropzone').classList.add('drag-over');
}

function handleDragLeave(e) {
    document.getElementById('pb-dropzone').classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    document.getElementById('pb-dropzone').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) uploadCV(file);
}

function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) uploadCV(file);
}

async function uploadCV(file) {
    document.getElementById('pb-dropzone').style.display = 'none';
    document.getElementById('pb-upload-status').style.display = 'block';
    addLogEntry('system', 'CV hochgeladen: ' + file.name, 'cv_upload');

    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch('/api/profiles/me/parse-cv', {
            method: 'POST',
            body: formData
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Upload fehlgeschlagen');
        }
        const data = await res.json();

        const parts = [];
        if (data.current_title) parts.push(data.current_title);
        if (data.work_history && data.work_history.length) parts.push(data.work_history.length + ' Positionen');
        if (data.skills && data.skills.length) parts.push(data.skills.length + ' Skills');
        addLogEntry('adele', 'Ich habe aus deinem Lebenslauf extrahiert: ' + parts.join(', ') + '. Importiere jetzt...');

        await importCV(data);
        addLogEntry('system', 'Lebenslauf-Daten importiert âœ“', 'cv_import');
        await refreshProfile();

    } catch (err) {
        addLogEntry('system', 'CV-Fehler: ' + err.message, 'error');
    } finally {
        document.getElementById('pb-dropzone').style.display = '';
        document.getElementById('pb-upload-status').style.display = 'none';
    }
}

async function importCV(data) {
    const payload = {
        current_title: data.current_title || null,
        career_level: data.career_level || null,
        years_experience: data.years_experience || null,
        skills: data.skills || [],
        languages: data.languages || [],
        certifications: data.certifications || [],
        profile_summary: data.profile_summary || null,
        work_history: data.work_history || [],
        education: data.education || []
    };
    const res = await fetch('/api/profiles/me/import-cv', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || 'Import fehlgeschlagen');
    }
}

// â”€â”€ FORM SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function saveFormData() {
    const yogiName = document.getElementById('pf-yogi-name').value.trim();
    const title = document.getElementById('pf-title').value.trim();
    const location = document.getElementById('pf-location').value.trim();
    const roles = document.getElementById('pf-roles').value.trim();
    const locations = document.getElementById('pf-locations').value.trim();
    const salaryMin = document.getElementById('pf-salary-min').value;
    const salaryMax = document.getElementById('pf-salary-max').value;
    const seniority = document.getElementById('pf-seniority').value;

    const changes = [];

    // Save yogi name (with server-side real-name check)
    if (yogiName) {
        try {
            const res = await fetch('/api/profiles/me/yogi-name', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ yogi_name: yogiName })
            });
            if (!res.ok) {
                const err = await res.json();
                alert(err.detail || 'Yogi-Name konnte nicht gespeichert werden.');
                return; // Stop â€” don't save anything else if name is rejected
            }
            changes.push('Yogi-Name: ' + yogiName);
            // Update header display
            const headerName = document.querySelector('.user-name');
            if (headerName) headerName.textContent = yogiName;
        } catch(e) {}
    }

    if (title || location) {
        try {
            await fetch('/api/profiles/me', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title: title || null, location: location || null })
            });
            if (title) changes.push('Position: ' + title);
            if (location) changes.push('Standort: ' + location);
        } catch(e) {}
    }

    if (roles || locations || salaryMin || salaryMax || seniority) {
        const prefs = {};
        if (roles) prefs.desired_roles = roles.split(',').map(s => s.trim()).filter(Boolean);
        if (locations) prefs.desired_locations = locations.split(',').map(s => s.trim()).filter(Boolean);
        if (salaryMin) prefs.expected_salary_min = parseInt(salaryMin);
        if (salaryMax) prefs.expected_salary_max = parseInt(salaryMax);
        if (seniority) prefs.min_seniority = seniority;

        try {
            await fetch('/api/profiles/me/preferences', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(prefs)
            });
            if (roles) changes.push('Wunschrollen aktualisiert');
            if (locations) changes.push('Wunschorte aktualisiert');
            if (salaryMin || salaryMax) changes.push('Gehaltsvorstellung aktualisiert');
            if (seniority) changes.push('Mindestlevel: ' + seniority);
        } catch(e) {}
    }

    if (changes.length > 0) {
        addLogEntry('system', changes.join(' Â· '), 'form_edit');
        await refreshProfile();
    }
}

// â”€â”€ DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function downloadProfile() {
    if (!profileMarkdown || profileMarkdown.startsWith('_Noch kein')) {
        alert('Noch kein Profil zum Herunterladen.');
        return;
    }
    const blob = new Blob([profileMarkdown], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'profil.md';
    a.click();
    URL.revokeObjectURL(url);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('DOMContentLoaded', async () => {
    await loadProfile();
    await loadActivityLog();
    switchTab('chat');
});
</script>
{% endblock %}
